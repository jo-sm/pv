!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.mlvw=e()}(this,function(){"use strict";function t(){var t=new Float32Array(9);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function e(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t}function n(t){var e=new Float32Array(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}function r(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function i(t,e,n,r,i,a,o,s,u){var l=new Float32Array(9);return l[0]=t,l[1]=e,l[2]=n,l[3]=r,l[4]=i,l[5]=a,l[6]=o,l[7]=s,l[8]=u,l}function a(t,e,n,r,i,a,o,s,u,l){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t[4]=a,t[5]=o,t[6]=s,t[7]=u,t[8]=l,t}function o(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function s(t,e){if(t===e){var n=e[1],r=e[2],i=e[5];t[1]=e[3],t[2]=e[6],t[3]=n,t[5]=e[7],t[6]=r,t[7]=i}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t}function u(t,e){var n=e[0],r=e[1],i=e[2],a=e[3],o=e[4],s=e[5],u=e[6],l=e[7],h=e[8],c=h*o-s*l,d=-h*a+s*u,f=l*a-o*u,_=n*c+r*d+i*f;return _?(_=1/_,t[0]=c*_,t[1]=(-h*r+i*l)*_,t[2]=(s*r-i*o)*_,t[3]=d*_,t[4]=(h*n-i*u)*_,t[5]=(-s*n+i*a)*_,t[6]=f*_,t[7]=(-l*n+r*u)*_,t[8]=(o*n-r*a)*_,t):null}function l(t,e){var n=e[0],r=e[1],i=e[2],a=e[3],o=e[4],s=e[5],u=e[6],l=e[7],h=e[8];return t[0]=o*h-s*l,t[1]=i*l-r*h,t[2]=r*s-i*o,t[3]=s*u-a*h,t[4]=n*h-i*u,t[5]=i*a-n*s,t[6]=a*l-o*u,t[7]=r*u-n*l,t[8]=n*o-r*a,t}function h(t){var e=t[0],n=t[1],r=t[2],i=t[3],a=t[4],o=t[5],s=t[6],u=t[7],l=t[8];return e*(l*a-o*u)+n*(-l*i+o*s)+r*(u*i-a*s)}function c(t,e,n){var r=e[0],i=e[1],a=e[2],o=e[3],s=e[4],u=e[5],l=e[6],h=e[7],c=e[8],d=n[0],f=n[1],_=n[2],v=n[3],m=n[4],g=n[5],p=n[6],y=n[7],b=n[8];return t[0]=d*r+f*o+_*l,t[1]=d*i+f*s+_*h,t[2]=d*a+f*u+_*c,t[3]=v*r+m*o+g*l,t[4]=v*i+m*s+g*h,t[5]=v*a+m*u+g*c,t[6]=p*r+y*o+b*l,t[7]=p*i+y*s+b*h,t[8]=p*a+y*u+b*c,t}function d(t,e,n){var r=e[0],i=e[1],a=e[2],o=e[3],s=e[4],u=e[5],l=e[6],h=e[7],c=e[8],d=n[0],f=n[1];return t[0]=r,t[1]=i,t[2]=a,t[3]=o,t[4]=s,t[5]=u,t[6]=d*r+f*o+l,t[7]=d*i+f*s+h,t[8]=d*a+f*u+c,t}function f(t,e,n){var r=e[0],i=e[1],a=e[2],o=e[3],s=e[4],u=e[5],l=e[6],h=e[7],c=e[8],d=Math.sin(n),f=Math.cos(n);return t[0]=f*r+d*o,t[1]=f*i+d*s,t[2]=f*a+d*u,t[3]=f*o-d*r,t[4]=f*s-d*i,t[5]=f*u-d*a,t[6]=l,t[7]=h,t[8]=c,t}function _(t,e,n){var r=n[0],i=n[1];return t[0]=r*e[0],t[1]=r*e[1],t[2]=r*e[2],t[3]=i*e[3],t[4]=i*e[4],t[5]=i*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function v(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=e[0],t[7]=e[1],t[8]=1,t}function m(t,e){var n=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=n,t[2]=0,t[3]=-n,t[4]=r,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function g(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=e[1],t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function p(t,e){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t}function y(t,e){var n=e[0],r=e[1],i=e[2],a=e[3],o=n+n,s=r+r,u=i+i,l=n*o,h=r*o,c=r*s,d=i*o,f=i*s,_=i*u,v=a*o,m=a*s,g=a*u;return t[0]=1-c-_,t[3]=h-g,t[6]=d+m,t[1]=h+g,t[4]=1-l-_,t[7]=f-v,t[2]=d-m,t[5]=f+v,t[8]=1-l-c,t}function b(t,e){var n=e[0],r=e[1],i=e[2],a=e[3],o=e[4],s=e[5],u=e[6],l=e[7],h=e[8],c=e[9],d=e[10],f=e[11],_=e[12],v=e[13],m=e[14],g=e[15],p=n*s-r*o,y=n*u-i*o,b=n*l-a*o,A=r*u-i*s,k=r*l-a*s,C=i*l-a*u,w=h*v-c*_,R=h*m-d*_,M=h*g-f*_,S=c*m-d*v,T=c*g-f*v,E=d*g-f*m,x=p*E-y*T+b*S+A*M-k*R+C*w;return x?(x=1/x,t[0]=(s*E-u*T+l*S)*x,t[1]=(u*M-o*E-l*R)*x,t[2]=(o*T-s*M+l*w)*x,t[3]=(i*T-r*E-a*S)*x,t[4]=(n*E-i*M+a*R)*x,t[5]=(r*M-n*T-a*w)*x,t[6]=(v*C-m*k+g*A)*x,t[7]=(m*b-_*C-g*y)*x,t[8]=(_*k-v*b+g*p)*x,t):null}function A(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"}function k(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2))}function C(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t[6]=e[6]+n[6],t[7]=e[7]+n[7],t[8]=e[8]+n[8],t}function w(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t[4]=e[4]-n[4],t[5]=e[5]-n[5],t[6]=e[6]-n[6],t[7]=e[7]-n[7],t[8]=e[8]-n[8],t}function R(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t[8]=e[8]*n,t}function M(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t[3]=e[3]+n[3]*r,t[4]=e[4]+n[4]*r,t[5]=e[5]+n[5]*r,t[6]=e[6]+n[6]*r,t[7]=e[7]+n[7]*r,t[8]=e[8]+n[8]*r,t}function S(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]}function T(){var t=new Float32Array(16);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function E(t){var e=new Float32Array(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function x(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function F(t,e,n,r,i,a,o,s,u,l,h,c,d,f,_,v){var m=new Float32Array(16);return m[0]=t,m[1]=e,m[2]=n,m[3]=r,m[4]=i,m[5]=a,m[6]=o,m[7]=s,m[8]=u,m[9]=l,m[10]=h,m[11]=c,m[12]=d,m[13]=f,m[14]=_,m[15]=v,m}function O(t,e,n,r,i,a,o,s,u,l,h,c,d,f,_,v,m){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t[4]=a,t[5]=o,t[6]=s,t[7]=u,t[8]=l,t[9]=h,t[10]=c,t[11]=d,t[12]=f,t[13]=_,t[14]=v,t[15]=m,t}function D(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function P(t,e){if(t===e){var n=e[1],r=e[2],i=e[3],a=e[6],o=e[7],s=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=n,t[6]=e[9],t[7]=e[13],t[8]=r,t[9]=a,t[11]=e[14],t[12]=i,t[13]=o,t[14]=s}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t}function I(t,e){var n=e[0],r=e[1],i=e[2],a=e[3],o=e[4],s=e[5],u=e[6],l=e[7],h=e[8],c=e[9],d=e[10],f=e[11],_=e[12],v=e[13],m=e[14],g=e[15],p=n*s-r*o,y=n*u-i*o,b=n*l-a*o,A=r*u-i*s,k=r*l-a*s,C=i*l-a*u,w=h*v-c*_,R=h*m-d*_,M=h*g-f*_,S=c*m-d*v,T=c*g-f*v,E=d*g-f*m,x=p*E-y*T+b*S+A*M-k*R+C*w;return x?(x=1/x,t[0]=(s*E-u*T+l*S)*x,t[1]=(i*T-r*E-a*S)*x,t[2]=(v*C-m*k+g*A)*x,t[3]=(d*k-c*C-f*A)*x,t[4]=(u*M-o*E-l*R)*x,t[5]=(n*E-i*M+a*R)*x,t[6]=(m*b-_*C-g*y)*x,t[7]=(h*C-d*b+f*y)*x,t[8]=(o*T-s*M+l*w)*x,t[9]=(r*M-n*T-a*w)*x,t[10]=(_*k-v*b+g*p)*x,t[11]=(c*b-h*k-f*p)*x,t[12]=(s*R-o*S-u*w)*x,t[13]=(n*S-r*R+i*w)*x,t[14]=(v*y-_*A-m*p)*x,t[15]=(h*A-c*y+d*p)*x,t):null}function V(t,e){var n=e[0],r=e[1],i=e[2],a=e[3],o=e[4],s=e[5],u=e[6],l=e[7],h=e[8],c=e[9],d=e[10],f=e[11],_=e[12],v=e[13],m=e[14],g=e[15];return t[0]=s*(d*g-f*m)-c*(u*g-l*m)+v*(u*f-l*d),t[1]=-(r*(d*g-f*m)-c*(i*g-a*m)+v*(i*f-a*d)),t[2]=r*(u*g-l*m)-s*(i*g-a*m)+v*(i*l-a*u),t[3]=-(r*(u*f-l*d)-s*(i*f-a*d)+c*(i*l-a*u)),t[4]=-(o*(d*g-f*m)-h*(u*g-l*m)+_*(u*f-l*d)),t[5]=n*(d*g-f*m)-h*(i*g-a*m)+_*(i*f-a*d),t[6]=-(n*(u*g-l*m)-o*(i*g-a*m)+_*(i*l-a*u)),t[7]=n*(u*f-l*d)-o*(i*f-a*d)+h*(i*l-a*u),t[8]=o*(c*g-f*v)-h*(s*g-l*v)+_*(s*f-l*c),t[9]=-(n*(c*g-f*v)-h*(r*g-a*v)+_*(r*f-a*c)),t[10]=n*(s*g-l*v)-o*(r*g-a*v)+_*(r*l-a*s),t[11]=-(n*(s*f-l*c)-o*(r*f-a*c)+h*(r*l-a*s)),t[12]=-(o*(c*m-d*v)-h*(s*m-u*v)+_*(s*d-u*c)),t[13]=n*(c*m-d*v)-h*(r*m-i*v)+_*(r*d-i*c),t[14]=-(n*(s*m-u*v)-o*(r*m-i*v)+_*(r*u-i*s)),t[15]=n*(s*d-u*c)-o*(r*d-i*c)+h*(r*u-i*s),t}function N(t){var e=t[0],n=t[1],r=t[2],i=t[3],a=t[4],o=t[5],s=t[6],u=t[7],l=t[8],h=t[9],c=t[10],d=t[11],f=t[12],_=t[13],v=t[14],m=t[15];return(e*o-n*a)*(c*m-d*v)-(e*s-r*a)*(h*m-d*_)+(e*u-i*a)*(h*v-c*_)+(n*s-r*o)*(l*m-d*f)-(n*u-i*o)*(l*v-c*f)+(r*u-i*s)*(l*_-h*f)}function L(t,e,n){var r=e[0],i=e[1],a=e[2],o=e[3],s=e[4],u=e[5],l=e[6],h=e[7],c=e[8],d=e[9],f=e[10],_=e[11],v=e[12],m=e[13],g=e[14],p=e[15],y=n[0],b=n[1],A=n[2],k=n[3];return t[0]=y*r+b*s+A*c+k*v,t[1]=y*i+b*u+A*d+k*m,t[2]=y*a+b*l+A*f+k*g,t[3]=y*o+b*h+A*_+k*p,y=n[4],b=n[5],A=n[6],k=n[7],t[4]=y*r+b*s+A*c+k*v,t[5]=y*i+b*u+A*d+k*m,t[6]=y*a+b*l+A*f+k*g,t[7]=y*o+b*h+A*_+k*p,y=n[8],b=n[9],A=n[10],k=n[11],t[8]=y*r+b*s+A*c+k*v,t[9]=y*i+b*u+A*d+k*m,t[10]=y*a+b*l+A*f+k*g,t[11]=y*o+b*h+A*_+k*p,y=n[12],b=n[13],A=n[14],k=n[15],t[12]=y*r+b*s+A*c+k*v,t[13]=y*i+b*u+A*d+k*m,t[14]=y*a+b*l+A*f+k*g,t[15]=y*o+b*h+A*_+k*p,t}function B(t,e,n){var r,i,a,o,s,u,l,h,c,d,f,_,v=n[0],m=n[1],g=n[2];return e===t?(t[12]=e[0]*v+e[4]*m+e[8]*g+e[12],t[13]=e[1]*v+e[5]*m+e[9]*g+e[13],t[14]=e[2]*v+e[6]*m+e[10]*g+e[14],t[15]=e[3]*v+e[7]*m+e[11]*g+e[15]):(r=e[0],i=e[1],a=e[2],o=e[3],s=e[4],u=e[5],l=e[6],h=e[7],c=e[8],d=e[9],f=e[10],_=e[11],t[0]=r,t[1]=i,t[2]=a,t[3]=o,t[4]=s,t[5]=u,t[6]=l,t[7]=h,t[8]=c,t[9]=d,t[10]=f,t[11]=_,t[12]=r*v+s*m+c*g+e[12],t[13]=i*v+u*m+d*g+e[13],t[14]=a*v+l*m+f*g+e[14],t[15]=o*v+h*m+_*g+e[15]),t}function j(t,e,n){var r=n[0],i=n[1],a=n[2];return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*a,t[9]=e[9]*a,t[10]=e[10]*a,t[11]=e[11]*a,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function z(t,e,n,r){var i,a,o,s,u,l,h,c,d,f,_,v,m,g,p,y,b,A,k,C,w,R,M,S,T=r[0],E=r[1],x=r[2],F=Math.sqrt(T*T+E*E+x*x);return 0===F?null:(F=1/F,T*=F,E*=F,x*=F,i=Math.sin(n),a=Math.cos(n),o=1-a,s=e[0],u=e[1],l=e[2],h=e[3],c=e[4],d=e[5],f=e[6],_=e[7],v=e[8],m=e[9],g=e[10],p=e[11],y=T*T*o+a,b=E*T*o+x*i,A=x*T*o-E*i,k=T*E*o-x*i,C=E*E*o+a,w=x*E*o+T*i,R=T*x*o+E*i,M=E*x*o-T*i,S=x*x*o+a,t[0]=s*y+c*b+v*A,t[1]=u*y+d*b+m*A,t[2]=l*y+f*b+g*A,t[3]=h*y+_*b+p*A,t[4]=s*k+c*C+v*w,t[5]=u*k+d*C+m*w,t[6]=l*k+f*C+g*w,t[7]=h*k+_*C+p*w,t[8]=s*R+c*M+v*S,t[9]=u*R+d*M+m*S,t[10]=l*R+f*M+g*S,t[11]=h*R+_*M+p*S,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)}function U(t,e,n){var r=Math.sin(n),i=Math.cos(n),a=e[4],o=e[5],s=e[6],u=e[7],l=e[8],h=e[9],c=e[10],d=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=a*i+l*r,t[5]=o*i+h*r,t[6]=s*i+c*r,t[7]=u*i+d*r,t[8]=l*i-a*r,t[9]=h*i-o*r,t[10]=c*i-s*r,t[11]=d*i-u*r,t}function q(t,e,n){var r=Math.sin(n),i=Math.cos(n),a=e[0],o=e[1],s=e[2],u=e[3],l=e[8],h=e[9],c=e[10],d=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=a*i-l*r,t[1]=o*i-h*r,t[2]=s*i-c*r,t[3]=u*i-d*r,t[8]=a*r+l*i,t[9]=o*r+h*i,t[10]=s*r+c*i,t[11]=u*r+d*i,t}function W(t,e,n){var r=Math.sin(n),i=Math.cos(n),a=e[0],o=e[1],s=e[2],u=e[3],l=e[4],h=e[5],c=e[6],d=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=a*i+l*r,t[1]=o*i+h*r,t[2]=s*i+c*r,t[3]=u*i+d*r,t[4]=l*i-a*r,t[5]=h*i-o*r,t[6]=c*i-s*r,t[7]=d*i-u*r,t}function H(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}function G(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function X(t,e,n){var r,i,a,o=n[0],s=n[1],u=n[2],l=Math.sqrt(o*o+s*s+u*u);return 0===l?null:(l=1/l,o*=l,s*=l,u*=l,r=Math.sin(e),i=Math.cos(e),a=1-i,t[0]=o*o*a+i,t[1]=s*o*a+u*r,t[2]=u*o*a-s*r,t[3]=0,t[4]=o*s*a-u*r,t[5]=s*s*a+i,t[6]=u*s*a+o*r,t[7]=0,t[8]=o*u*a+s*r,t[9]=s*u*a-o*r,t[10]=u*u*a+i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)}function Y(t,e){var n=Math.sin(e),r=Math.cos(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=r,t[6]=n,t[7]=0,t[8]=0,t[9]=-n,t[10]=r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function $(t,e){var n=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=0,t[2]=-n,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=n,t[9]=0,t[10]=r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Z(t,e){var n=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=n,t[2]=0,t[3]=0,t[4]=-n,t[5]=r,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function K(t,e,n){var r=e[0],i=e[1],a=e[2],o=e[3],s=r+r,u=i+i,l=a+a,h=r*s,c=r*u,d=r*l,f=i*u,_=i*l,v=a*l,m=o*s,g=o*u,p=o*l;return t[0]=1-(f+v),t[1]=c+p,t[2]=d-g,t[3]=0,t[4]=c-p,t[5]=1-(h+v),t[6]=_+m,t[7]=0,t[8]=d+g,t[9]=_-m,t[10]=1-(h+f),t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t}function Q(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t}function J(t,e){var n=e[0],r=e[1],i=e[2],a=e[4],o=e[5],s=e[6],u=e[8],l=e[9],h=e[10];return t[0]=Math.sqrt(n*n+r*r+i*i),t[1]=Math.sqrt(a*a+o*o+s*s),t[2]=Math.sqrt(u*u+l*l+h*h),t}function tt(t,e){var n=e[0]+e[5]+e[10],r=0;return n>0?(r=2*Math.sqrt(n+1),t[3]=.25*r,t[0]=(e[6]-e[9])/r,t[1]=(e[8]-e[2])/r,t[2]=(e[1]-e[4])/r):e[0]>e[5]&e[0]>e[10]?(r=2*Math.sqrt(1+e[0]-e[5]-e[10]),t[3]=(e[6]-e[9])/r,t[0]=.25*r,t[1]=(e[1]+e[4])/r,t[2]=(e[8]+e[2])/r):e[5]>e[10]?(r=2*Math.sqrt(1+e[5]-e[0]-e[10]),t[3]=(e[8]-e[2])/r,t[0]=(e[1]+e[4])/r,t[1]=.25*r,t[2]=(e[6]+e[9])/r):(r=2*Math.sqrt(1+e[10]-e[0]-e[5]),t[3]=(e[1]-e[4])/r,t[0]=(e[8]+e[2])/r,t[1]=(e[6]+e[9])/r,t[2]=.25*r),t}function et(t,e,n,r){var i=e[0],a=e[1],o=e[2],s=e[3],u=i+i,l=a+a,h=o+o,c=i*u,d=i*l,f=i*h,_=a*l,v=a*h,m=o*h,g=s*u,p=s*l,y=s*h,b=r[0],A=r[1],k=r[2];return t[0]=(1-(_+m))*b,t[1]=(d+y)*b,t[2]=(f-p)*b,t[3]=0,t[4]=(d-y)*A,t[5]=(1-(c+m))*A,t[6]=(v+g)*A,t[7]=0,t[8]=(f+p)*k,t[9]=(v-g)*k,t[10]=(1-(c+_))*k,t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t}function nt(t,e,n,r,i){var a=e[0],o=e[1],s=e[2],u=e[3],l=a+a,h=o+o,c=s+s,d=a*l,f=a*h,_=a*c,v=o*h,m=o*c,g=s*c,p=u*l,y=u*h,b=u*c,A=r[0],k=r[1],C=r[2],w=i[0],R=i[1],M=i[2];return t[0]=(1-(v+g))*A,t[1]=(f+b)*A,t[2]=(_-y)*A,t[3]=0,t[4]=(f-b)*k,t[5]=(1-(d+g))*k,t[6]=(m+p)*k,t[7]=0,t[8]=(_+y)*C,t[9]=(m-p)*C,t[10]=(1-(d+v))*C,t[11]=0,t[12]=n[0]+w-(t[0]*w+t[4]*R+t[8]*M),t[13]=n[1]+R-(t[1]*w+t[5]*R+t[9]*M),t[14]=n[2]+M-(t[2]*w+t[6]*R+t[10]*M),t[15]=1,t}function rt(t,e){var n=e[0],r=e[1],i=e[2],a=e[3],o=n+n,s=r+r,u=i+i,l=n*o,h=r*o,c=r*s,d=i*o,f=i*s,_=i*u,v=a*o,m=a*s,g=a*u;return t[0]=1-c-_,t[1]=h+g,t[2]=d-m,t[3]=0,t[4]=h-g,t[5]=1-l-_,t[6]=f+v,t[7]=0,t[8]=d+m,t[9]=f-v,t[10]=1-l-c,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function it(t,e,n,r,i,a,o){var s=1/(n-e),u=1/(i-r),l=1/(a-o);return t[0]=2*a*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*a*u,t[6]=0,t[7]=0,t[8]=(n+e)*s,t[9]=(i+r)*u,t[10]=(o+a)*l,t[11]=-1,t[12]=0,t[13]=0,t[14]=o*a*2*l,t[15]=0,t}function at(t,e,n,r,i){var a=1/Math.tan(e/2),o=1/(r-i);return t[0]=a/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(i+r)*o,t[11]=-1,t[12]=0,t[13]=0,t[14]=2*i*r*o,t[15]=0,t}function ot(t,e,n,r){var i=Math.tan(e.upDegrees*Math.PI/180),a=Math.tan(e.downDegrees*Math.PI/180),o=Math.tan(e.leftDegrees*Math.PI/180),s=Math.tan(e.rightDegrees*Math.PI/180),u=2/(o+s),l=2/(i+a);return t[0]=u,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=l,t[6]=0,t[7]=0,t[8]=-(o-s)*u*.5,t[9]=(i-a)*l*.5,t[10]=r/(n-r),t[11]=-1,t[12]=0,t[13]=0,t[14]=r*n/(n-r),t[15]=0,t}function st(t,e,n,r,i,a,o){var s=1/(e-n),u=1/(r-i),l=1/(a-o);return t[0]=-2*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*u,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*l,t[11]=0,t[12]=(e+n)*s,t[13]=(i+r)*u,t[14]=(o+a)*l,t[15]=1,t}function ut(t,e,n,r){var i,a,o,s,u,l,h,c,d,f,_=e[0],v=e[1],m=e[2],g=r[0],p=r[1],y=r[2],b=n[0],A=n[1],k=n[2];return 0===Math.abs(_-b)&&0===Math.abs(v-A)&&0===Math.abs(m-k)?D(t):(h=_-b,c=v-A,d=m-k,f=1/Math.sqrt(h*h+c*c+d*d),h*=f,c*=f,d*=f,i=p*d-y*c,a=y*h-g*d,o=g*c-p*h,f=Math.sqrt(i*i+a*a+o*o),f?(i*=f=1/f,a*=f,o*=f):(i=0,a=0,o=0),s=c*o-d*a,u=d*i-h*o,l=h*a-c*i,f=Math.sqrt(s*s+u*u+l*l),f?(s*=f=1/f,u*=f,l*=f):(s=0,u=0,l=0),t[0]=i,t[1]=s,t[2]=h,t[3]=0,t[4]=a,t[5]=u,t[6]=c,t[7]=0,t[8]=o,t[9]=l,t[10]=d,t[11]=0,t[12]=-(i*_+a*v+o*m),t[13]=-(s*_+u*v+l*m),t[14]=-(h*_+c*v+d*m),t[15]=1,t)}function lt(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"}function ht(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2)+Math.pow(t[9],2)+Math.pow(t[10],2)+Math.pow(t[11],2)+Math.pow(t[12],2)+Math.pow(t[13],2)+Math.pow(t[14],2)+Math.pow(t[15],2))}function ct(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t[6]=e[6]+n[6],t[7]=e[7]+n[7],t[8]=e[8]+n[8],t[9]=e[9]+n[9],t[10]=e[10]+n[10],t[11]=e[11]+n[11],t[12]=e[12]+n[12],t[13]=e[13]+n[13],t[14]=e[14]+n[14],t[15]=e[15]+n[15],t}function dt(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t[4]=e[4]-n[4],t[5]=e[5]-n[5],t[6]=e[6]-n[6],t[7]=e[7]-n[7],t[8]=e[8]-n[8],t[9]=e[9]-n[9],t[10]=e[10]-n[10],t[11]=e[11]-n[11],t[12]=e[12]-n[12],t[13]=e[13]-n[13],t[14]=e[14]-n[14],t[15]=e[15]-n[15],t}function ft(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12]*n,t[13]=e[13]*n,t[14]=e[14]*n,t[15]=e[15]*n,t}function _t(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t[3]=e[3]+n[3]*r,t[4]=e[4]+n[4]*r,t[5]=e[5]+n[5]*r,t[6]=e[6]+n[6]*r,t[7]=e[7]+n[7]*r,t[8]=e[8]+n[8]*r,t[9]=e[9]+n[9]*r,t[10]=e[10]+n[10]*r,t[11]=e[11]+n[11]*r,t[12]=e[12]+n[12]*r,t[13]=e[13]+n[13]*r,t[14]=e[14]+n[14]*r,t[15]=e[15]+n[15]*r,t}function vt(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]}function mt(){var t=new Float32Array(3);return t[0]=0,t[1]=0,t[2]=0,t}function gt(t){var e=new Float32Array(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function pt(t,e,n){var r=new Float32Array(3);return r[0]=t,r[1]=e,r[2]=n,r}function yt(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function bt(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}function At(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function kt(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function Ct(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t}function wt(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t[2]=e[2]/n[2],t}function Rt(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t}function Mt(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t}function St(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t[2]=Math.min(e[2],n[2]),t}function Tt(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t[2]=Math.max(e[2],n[2]),t}function Et(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t}function xt(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function Ft(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t}function Ot(t,e){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2];return Math.sqrt(n*n+r*r+i*i)}function Dt(t,e){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2];return n*n+r*r+i*i}function Pt(t){var e=t[0],n=t[1],r=t[2];return Math.sqrt(e*e+n*n+r*r)}function It(t){var e=t[0],n=t[1],r=t[2];return e*e+n*n+r*r}function Vt(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t}function Nt(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t}function Lt(t,e){var n=e[0],r=e[1],i=e[2],a=n*n+r*r+i*i;return a>0&&(a=1/Math.sqrt(a),t[0]=e[0]*a,t[1]=e[1]*a,t[2]=e[2]*a),t}function Bt(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function jt(t,e,n){var r=e[0],i=e[1],a=e[2],o=n[0],s=n[1],u=n[2];return t[0]=i*u-a*s,t[1]=a*o-r*u,t[2]=r*s-i*o,t}function zt(t,e,n,r){var i=e[0],a=e[1],o=e[2];return t[0]=i+r*(n[0]-i),t[1]=a+r*(n[1]-a),t[2]=o+r*(n[2]-o),t}function Ut(t,e,n,r,i,a){var o=a*a,s=o*(2*a-3)+1,u=o*(a-2)+a,l=o*(a-1),h=o*(3-2*a);return t[0]=e[0]*s+n[0]*u+r[0]*l+i[0]*h,t[1]=e[1]*s+n[1]*u+r[1]*l+i[1]*h,t[2]=e[2]*s+n[2]*u+r[2]*l+i[2]*h,t}function qt(t,e,n,r,i,a){var o=1-a,s=o*o,u=a*a,l=s*o,h=3*a*s,c=3*u*o,d=u*a;return t[0]=e[0]*l+n[0]*h+r[0]*c+i[0]*d,t[1]=e[1]*l+n[1]*h+r[1]*c+i[1]*d,t[2]=e[2]*l+n[2]*h+r[2]*c+i[2]*d,t}function Wt(t,e){e=e||1;var n=2*Math.random()*Math.PI,r=2*Math.random()-1,i=Math.sqrt(1-r*r)*e;return t[0]=Math.cos(n)*i,t[1]=Math.sin(n)*i,t[2]=r*e,t}function Ht(t,e,n){var r=e[0],i=e[1],a=e[2],o=n[3]*r+n[7]*i+n[11]*a+n[15];return o=o||1,t[0]=(n[0]*r+n[4]*i+n[8]*a+n[12])/o,t[1]=(n[1]*r+n[5]*i+n[9]*a+n[13])/o,t[2]=(n[2]*r+n[6]*i+n[10]*a+n[14])/o,t}function Gt(t,e,n){var r=e[0],i=e[1],a=e[2];return t[0]=r*n[0]+i*n[3]+a*n[6],t[1]=r*n[1]+i*n[4]+a*n[7],t[2]=r*n[2]+i*n[5]+a*n[8],t}function Xt(t,e,n){var r=e[0],i=e[1],a=e[2],o=n[0],s=n[1],u=n[2],l=n[3],h=l*r+s*a-u*i,c=l*i+u*r-o*a,d=l*a+o*i-s*r,f=-o*r-s*i-u*a;return t[0]=h*l+f*-o+c*-u-d*-s,t[1]=c*l+f*-s+d*-o-h*-u,t[2]=d*l+f*-u+h*-s-c*-o,t}function Yt(t,e,n,r){var i=[],a=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],a[0]=i[0],a[1]=i[1]*Math.cos(r)-i[2]*Math.sin(r),a[2]=i[1]*Math.sin(r)+i[2]*Math.cos(r),t[0]=a[0]+n[0],t[1]=a[1]+n[1],t[2]=a[2]+n[2],t}function $t(t,e,n,r){var i=[],a=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],a[0]=i[2]*Math.sin(r)+i[0]*Math.cos(r),a[1]=i[1],a[2]=i[2]*Math.cos(r)-i[0]*Math.sin(r),t[0]=a[0]+n[0],t[1]=a[1]+n[1],t[2]=a[2]+n[2],t}function Zt(t,e,n,r){var i=[],a=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],a[0]=i[0]*Math.cos(r)-i[1]*Math.sin(r),a[1]=i[0]*Math.sin(r)+i[1]*Math.cos(r),a[2]=i[2],t[0]=a[0]+n[0],t[1]=a[1]+n[1],t[2]=a[2]+n[2],t}function Kt(t,e,n,r,i,a){var o,s;for(e||(e=3),n||(n=0),s=r?Math.min(r*e+n,t.length):t.length,o=n;o<s;o+=e)Hn[0]=t[o],Hn[1]=t[o+1],Hn[2]=t[o+2],i(Hn,Hn,a),t[o]=Hn[0],t[o+1]=Hn[1],t[o+2]=Hn[2];return t}function Qt(t,e){var n=pt(t[0],t[1],t[2]),r=pt(e[0],e[1],e[2]);Lt(n,n),Lt(r,r);var i=Bt(n,r);return i>1?0:i<-1?Math.PI:Math.acos(i)}function Jt(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"}function te(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function ee(){var t=new Float32Array(4);return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t}function ne(t){var e=new Float32Array(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function re(t,e,n,r){var i=new Float32Array(4);return i[0]=t,i[1]=e,i[2]=n,i[3]=r,i}function ie(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function ae(t,e,n,r,i){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t}function oe(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t}function se(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t}function ue(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t[3]=e[3]*n[3],t}function le(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t[2]=e[2]/n[2],t[3]=e[3]/n[3],t}function he(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t[3]=Math.ceil(e[3]),t}function ce(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t[3]=Math.floor(e[3]),t}function de(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t[2]=Math.min(e[2],n[2]),t[3]=Math.min(e[3],n[3]),t}function fe(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t[2]=Math.max(e[2],n[2]),t[3]=Math.max(e[3],n[3]),t}function _e(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t[3]=Math.round(e[3]),t}function ve(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t}function me(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t[3]=e[3]+n[3]*r,t}function ge(t,e){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2],a=e[3]-t[3];return Math.sqrt(n*n+r*r+i*i+a*a)}function pe(t,e){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2],a=e[3]-t[3];return n*n+r*r+i*i+a*a}function ye(t){var e=t[0],n=t[1],r=t[2],i=t[3];return Math.sqrt(e*e+n*n+r*r+i*i)}function be(t){var e=t[0],n=t[1],r=t[2],i=t[3];return e*e+n*n+r*r+i*i}function Ae(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t}function ke(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t}function Ce(t,e){var n=e[0],r=e[1],i=e[2],a=e[3],o=n*n+r*r+i*i+a*a;return o>0&&(o=1/Math.sqrt(o),t[0]=n*o,t[1]=r*o,t[2]=i*o,t[3]=a*o),t}function we(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function Re(t,e,n,r){var i=e[0],a=e[1],o=e[2],s=e[3];return t[0]=i+r*(n[0]-i),t[1]=a+r*(n[1]-a),t[2]=o+r*(n[2]-o),t[3]=s+r*(n[3]-s),t}function Me(t,e){return e=e||1,t[0]=Math.random(),t[1]=Math.random(),t[2]=Math.random(),t[3]=Math.random(),Ce(t,t),ve(t,t,e),t}function Se(t,e,n){var r=e[0],i=e[1],a=e[2],o=e[3];return t[0]=n[0]*r+n[4]*i+n[8]*a+n[12]*o,t[1]=n[1]*r+n[5]*i+n[9]*a+n[13]*o,t[2]=n[2]*r+n[6]*i+n[10]*a+n[14]*o,t[3]=n[3]*r+n[7]*i+n[11]*a+n[15]*o,t}function Te(t,e,n){var r=e[0],i=e[1],a=e[2],o=n[0],s=n[1],u=n[2],l=n[3],h=l*r+s*a-u*i,c=l*i+u*r-o*a,d=l*a+o*i-s*r,f=-o*r-s*i-u*a;return t[0]=h*l+f*-o+c*-u-d*-s,t[1]=c*l+f*-s+d*-o-h*-u,t[2]=d*l+f*-u+h*-s-c*-o,t[3]=e[3],t}function Ee(t,e,n,r,i,a){var o,s;for(e||(e=4),n||(n=0),s=r?Math.min(r*e+n,t.length):t.length,o=n;o<s;o+=e)Xn[0]=t[o],Xn[1]=t[o+1],Xn[2]=t[o+2],Xn[3]=t[o+3],i(Xn,Xn,a),t[o]=Xn[0],t[o+1]=Xn[1],t[o+2]=Xn[2],t[o+3]=Xn[3];return t}function xe(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}function Fe(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function Oe(){var t=new Float32Array(4);return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}function De(t,e,n){var r=Bt(e,n);return r<-.999999?(jt(Zn,Kn,e),Pt(Zn)<1e-6&&jt(Zn,Qn,e),Lt(Zn,Zn),Ve(t,Zn,Math.PI),t):r>.999999?(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t):(jt(Zn,e,n),t[0]=Zn[0],t[1]=Zn[1],t[2]=Zn[2],t[3]=1+r,$n(t,t))}function Pe(t,e,n,r){return Jn[0]=n[0],Jn[3]=n[1],Jn[6]=n[2],Jn[1]=r[0],Jn[4]=r[1],Jn[7]=r[2],Jn[2]=-e[0],Jn[5]=-e[1],Jn[8]=-e[2],$n(t,Xe(t,Jn))}function Ie(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}function Ve(t,e,n){n*=.5;var r=Math.sin(n);return t[0]=r*e[0],t[1]=r*e[1],t[2]=r*e[2],t[3]=Math.cos(n),t}function Ne(t,e){var n=2*Math.acos(e[3]),r=Math.sin(n/2);return 0!==r?(t[0]=e[0]/r,t[1]=e[1]/r,t[2]=e[2]/r):(t[0]=1,t[1]=0,t[2]=0),n}function Le(t,e,n){var r=e[0],i=e[1],a=e[2],o=e[3],s=n[0],u=n[1],l=n[2],h=n[3];return t[0]=r*h+o*s+i*l-a*u,t[1]=i*h+o*u+a*s-r*l,t[2]=a*h+o*l+r*u-i*s,t[3]=o*h-r*s-i*u-a*l,t}function Be(t,e,n){n*=.5;var r=e[0],i=e[1],a=e[2],o=e[3],s=Math.sin(n),u=Math.cos(n);return t[0]=r*u+o*s,t[1]=i*u+a*s,t[2]=a*u-i*s,t[3]=o*u-r*s,t}function je(t,e,n){n*=.5;var r=e[0],i=e[1],a=e[2],o=e[3],s=Math.sin(n),u=Math.cos(n);return t[0]=r*u-a*s,t[1]=i*u+o*s,t[2]=a*u+r*s,t[3]=o*u-i*s,t}function ze(t,e,n){n*=.5;var r=e[0],i=e[1],a=e[2],o=e[3],s=Math.sin(n),u=Math.cos(n);return t[0]=r*u+i*s,t[1]=i*u-r*s,t[2]=a*u+o*s,t[3]=o*u-a*s,t}function Ue(t,e){var n=e[0],r=e[1],i=e[2];return t[0]=n,t[1]=r,t[2]=i,t[3]=Math.sqrt(Math.abs(1-n*n-r*r-i*i)),t}function qe(t,e,n,r){var i,a,o,s,u,l=e[0],h=e[1],c=e[2],d=e[3],f=n[0],_=n[1],v=n[2],m=n[3];return(a=l*f+h*_+c*v+d*m)<0&&(a=-a,f=-f,_=-_,v=-v,m=-m),1-a>1e-6?(i=Math.acos(a),o=Math.sin(i),s=Math.sin((1-r)*i)/o,u=Math.sin(r*i)/o):(s=1-r,u=r),t[0]=s*l+u*f,t[1]=s*h+u*_,t[2]=s*c+u*v,t[3]=s*d+u*m,t}function We(t,e,n,r,i,a){return qe(ur,e,i,a),qe(lr,n,r,a),qe(t,ur,lr,2*a*(1-a)),t}function He(t,e){var n=e[0],r=e[1],i=e[2],a=e[3],o=n*n+r*r+i*i+a*a,s=o?1/o:0;return t[0]=-n*s,t[1]=-r*s,t[2]=-i*s,t[3]=a*s,t}function Ge(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t}function Xe(t,e){var n,r=e[0]+e[4]+e[8];if(r>0)n=Math.sqrt(r+1),t[3]=.5*n,n=.5/n,t[0]=(e[5]-e[7])*n,t[1]=(e[6]-e[2])*n,t[2]=(e[1]-e[3])*n;else{var i=0;e[4]>e[0]&&(i=1),e[8]>e[3*i+i]&&(i=2);var a=(i+1)%3,o=(i+2)%3;n=Math.sqrt(e[3*i+i]-e[3*a+a]-e[3*o+o]+1),t[i]=.5*n,n=.5/n,t[3]=(e[3*a+o]-e[3*o+a])*n,t[a]=(e[3*a+i]+e[3*i+a])*n,t[o]=(e[3*o+i]+e[3*i+o])*n}return t}function Ye(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}function $e(t,e,n){var r=null,i=null;return t[e](function(t){var e=t.prop(n);null!==r||null!==i?(r=Math.min(r,e),i=Math.max(i,e)):r=i=e}),{min:r,max:i}}function Ze(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ir("rainbow"),n=arguments[2],r=arguments[3],i=arguments[4];return new Lr(function(n,r,a){var o=0;this._min!==this._max&&(o=(i(n).prop(t)-this._min)/(this._max-this._min)),Gr(r,a,e,o)},function(e){if(void 0!==n)return this._min=n[0],void(this._max=n[1]);n=$e(e,r,t),this._min=n.min,this._max=n.max})}function Ke(t,e){if(t.length!==e.length)return!1;for(var n=0;n<t.length;++n)if(Math.abs(t[n]-e[n])>1e-6)return!1;return!0}function Qe(t){for(var e=0,n=0,r=0;r<t.length;++r)e+=t[r].clientX,n+=t[r].clientY;return e/=t.length,n/=t.length,{x:e,y:n}}function Je(t,e){var n=e.x-t.x,r=e.y-t.y;return Math.sqrt(n*n+r*r)}function tn(t,e){var n=Je(t[0],t[1]);return Je(e[0],e[1])/(0===n?1:n)}function en(t,e){var n=e.x-t.x,r=e.y-t.y;return Math.atan2(r,n)}function nn(t,e){return en(e[1],e[0])-en(t[1],t[0])}function rn(t){if("complete"!==document.readyState&&"loaded"!==document.readyState&&"interactive"!==document.readyState)return console.error("isWebGLSupported only works after DOMContentLoaded"),!1;if(void 0===t)try{var e=document.createElement("canvas");return Boolean(window.WebGLRenderingContext&&e.getContext("experimental-webgl"))}catch(t){return!1}return Boolean(t)}function an(t,e,n){for(var r=0;r<n-1;++r)t.addTriangle(e,e+1+r,e+2+r);t.addTriangle(e,e+n,e+1)}function on(t,e,n){for(var r=e+n,i=0;i<n-1;++i)t.addTriangle(r,e+i+1,e+i);t.addTriangle(r,e,e+n-1)}function sn(t){for(var e=1;e<t;)e*=2;return e}function un(t,e){t.eachResidue(function(t){var n=t.centralAtom();null!==n&&e(n,n.pos())})}function ln(t,e,n){for(var r=0;r<n-1;++r)t.addTriangle(e,e+1+r,e+2+r);t.addTriangle(e,e+n,e+1)}function hn(t,e,n){for(var r=e+n,i=0;i<n-1;++i)t.addTriangle(r,e+i+1,e+i);t.addTriangle(r,e,e+n-1)}function cn(t,e,n){return new pa(t,e,n)}function dn(t,e,n){return new ya(t,e,n)}function fn(t,e,n){return new ga(t,e,n)}function _n(t,e){return new Aa(t,e)}function vn(){return new ba([0,1,0],2e3)}function mn(t,e){return t<e}function gn(){return/(iPad|iPhone|iPod)/g.test(navigator.userAgent)}function pn(){return/Android/gi.test(navigator.userAgent)}function yn(t){var e=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT);return Boolean(e.precision)&&(gn()||pn())}function bn(t,e){return t=t||"auto","fixed"===t?new kr(e):"auto"===t?new Cr(e):null}function An(t,e,n){return e in t?t[e]:n}function kn(t,e){return t<<8|e.charCodeAt(0)}function Cn(t,e){return t.num()<e.num()}function wn(t){return{num:function(){return t}}}function Rn(t,e,n){var r,i;if(t?(r=e.atom("C"),i=n.atom("N")):(r=e.atom("O3'"),i=n.atom("P")),r.isConnectedTo(i))return!1;var a=Dt(r.pos(),i.pos());return Math.abs(a-2.25)>1}function Mn(t,e){e.length()<2||t.push(e)}function Sn(t,e,n){if(0===t.length)return!0;if(!e)return!1;var r=kn(n.num(),n.insCode()),i=t[t.length-1];return kn(i.num(),i.insCode())<r}function Tn(t,e){var n={atom_one:t,atom_two:e};return{atom_one:function(){return n.atom_one},atom_two:function(){return n.atom_two},mid_point:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:mt();return At(t,n.atom_one.pos(),n.atom_two.pos()),xt(t,t,.5),t}}}function En(t){if(!t)return null;var e=Ua[t.toUpperCase()];return e||1.5}function xn(t,e,n){var r=e.atom("C"),i=n.atom("N");r&&i&&Dt(r.pos(),i.pos())<1.6*1.6&&t.connect(i,r)}function Fn(t,e,n){var r=e.atom("O3'"),i=n.atom("P");r&&i&&Dt(r.pos(),i.pos())<1.7*1.7&&t.connect(r,i)}function On(t,e){var n=new XMLHttpRequest;n.open("GET",t,!0),n.responseType="arraybuffer",n.onload=function(){n.response&&e(new DataView(n.response))},n.send(null)}function Dn(t,e){var n=mt(),r=mt();bt(n,0,0,0);var i=0;t.eachCentralAtom(function(t,e){At(n,n,e),i+=1}),0!==i&&(xt(n,n,1/i),e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0,t.eachCentralAtom(function(t,i){kt(r,i,n);var a=r[0],o=r[1],s=r[2];e[0]+=o*o+s*s,e[1]-=a*o,e[2]-=a*s,e[5]-=o*s,e[4]+=a*a+s*s,e[8]+=a*a+o*o}),e[3]=e[1],e[6]=e[2],e[7]=e[5])}function Pn(e){var n=t(),r=t(),i=mt(),a=mt(),o=mt(),s=mt(),u=mt(),l=mt(),h=mt();Dn(e,n);var c=li(n);y(r,c);var d=!0;e.eachCentralAtom(function(t,e){Gt(o,e,r),d?(yt(i,o),yt(a,o),d=!1):(i(i,i,o),a(a,a,o))}),kt(s,a,i);var f=[[s[0],0],[s[1],1],[s[2],2]];f.sort(function(t,e){return e[0]-t[0]});var _=f[0][1],v=f[1][1];bt(u,r[_+0],r[_+3],r[_+6]),bt(l,r[v+0],r[v+3],r[v+6]),jt(h,u,l);var m=t();return m[0]=u[0],m[1]=l[0],m[2]=h[0],m[3]=u[1],m[4]=l[1],m[5]=h[1],m[6]=u[2],m[7]=l[2],m[8]=h[2],m}function In(t){for(var e=0;e<t.length();++e)fo(t,e)?t.residueAt(e).setSS("H"):_o(t,e)?t.residueAt(e).setSS("E"):t.residueAt(e).setSS("C")}function Vn(t){console.time("mol.assignHelixSheet");for(var e=t.chains(),n=0;n<e.length;++n)e[n].eachBackboneTrace(In);console.timeEnd("mol.assignHelixSheet")}function Nn(t){function e(t,e){return t=Math.abs(t),e=Math.abs(e),t>e?t*Math.sqrt(1+e*e/t/t):0===e?t:e*Math.sqrt(1+t*t/e/e)}var n,r=Math.pow(2,-52),i=1e-64/r,a=0,o=0,s=0,u=0,l=0,h=t,c=h.length,d=h[0].length;if(c<d)throw new Error("Need more rows than columns");var f=new Array(d),_=new Array(d);for(o=0;o<d;o++)f[o]=_[o]=0;for(var v=[],o=0;o<d;++o){var m=[];v.push([]);for(s=0;s<d;++s)m.push(0);v.push(m)}var g=0,p=0,y=0,b=0,A=0,k=0,C=0;for(o=0;o<d;o++){for(f[o]=p,C=0,l=o+1,s=o;s<c;s++)C+=h[s][o]*h[s][o];if(C<=i)p=0;else for(g=h[o][o],p=Math.sqrt(C),g>=0&&(p=-p),y=g*p-C,h[o][o]=g-p,s=l;s<d;s++){for(C=0,u=o;u<c;u++)C+=h[u][o]*h[u][s];for(g=C/y,u=o;u<c;u++)h[u][s]+=g*h[u][o]}for(_[o]=p,C=0,s=l;s<d;s++)C+=h[o][s]*h[o][s];if(C<=i)p=0;else{for(g=h[o][o+1],p=Math.sqrt(C),g>=0&&(p=-p),y=g*p-C,h[o][o+1]=g-p,s=l;s<d;s++)f[s]=h[o][s]/y;for(s=l;s<c;s++){for(C=0,u=l;u<d;u++)C+=h[s][u]*h[o][u];for(u=l;u<d;u++)h[s][u]+=C*f[u]}}(A=Math.abs(_[o])+Math.abs(f[o]))>b&&(b=A)}for(o=d-1;-1!==o;o+=-1){if(0!==p){for(y=p*h[o][o+1],s=l;s<d;s++)v[s][o]=h[o][s]/y;for(s=l;s<d;s++){for(C=0,u=l;u<d;u++)C+=h[o][u]*v[u][s];for(u=l;u<d;u++)v[u][s]+=C*v[u][o]}}for(s=l;s<d;s++)v[o][s]=0,v[s][o]=0;v[o][o]=1,p=f[o],l=o}for(o=d-1;-1!==o;o+=-1){for(l=o+1,p=_[o],s=l;s<d;s++)h[o][s]=0;if(0!==p){for(y=h[o][o]*p,s=l;s<d;s++){for(C=0,u=l;u<c;u++)C+=h[u][o]*h[u][s];for(g=C/y,u=o;u<c;u++)h[u][s]+=g*h[u][o]}for(s=o;s<c;s++)h[s][o]=h[s][o]/p}else for(s=o;s<c;s++)h[s][o]=0;h[o][o]+=1}for(r*=b,u=d-1;-1!==u;u+=-1)for(var w=0;w<50;w++){var R=!1;for(l=u;-1!==l;l+=-1){if(Math.abs(f[l])<=r){R=!0;break}if(Math.abs(_[l-1])<=r)break}if(!R){a=0,C=1;var M=l-1;for(o=l;o<u+1&&(g=C*f[o],f[o]=a*f[o],!(Math.abs(g)<=r));o++)for(y=e(g,p=_[o]),_[o]=y,a=p/y,C=-g/y,s=0;s<c;s++)A=h[s][M],k=h[s][o],h[s][M]=A*a+k*C,h[s][o]=-A*C+k*a}if(k=_[u],l===u){if(k<0)for(_[u]=-k,s=0;s<d;s++)v[s][u]=-v[s][u];break}if(w>=49)throw new Error("No convergence.");for(b=_[l],p=e(g=(((A=_[u-1])-k)*(A+k)+((p=f[u-1])-(y=f[u]))*(p+y))/(2*y*A),1),g=g<0?((b-k)*(b+k)+y*(A/(g-p)-y))/b:((b-k)*(b+k)+y*(A/(g+p)-y))/b,a=1,C=1,o=l+1;o<u+1;o++){for(p=f[o],A=_[o],y=C*p,p*=a,k=e(g,y),f[o-1]=k,g=b*(a=g/k)+p*(C=y/k),p=-b*C+p*a,y=A*C,A*=a,s=0;s<d;s++)b=v[s][o-1],k=v[s][o],v[s][o-1]=b*a+k*C,v[s][o]=-b*C+k*a;for(k=e(g,y),_[o-1]=k,g=(a=g/k)*p+(C=y/k)*A,b=-C*p+a*A,s=0;s<c;s++)A=h[s][o-1],k=h[s][o],h[s][o-1]=A*a+k*C,h[s][o]=-A*C+k*a}f[l]=0,f[u]=g,_[u]=b}for(o=0;o<_.length;o++)_[o]<r&&(_[o]=0);for(o=0;o<d;o++)for(s=o-1;s>=0;s--)if(_[s]<_[o]){for(a=_[s],_[s]=_[o],_[o]=a,u=0;u<h.length;u++)n=h[u][o],h[u][o]=h[u][s],h[u][s]=n;for(u=0;u<v.length;u++)n=v[u][o],v[u][o]=v[u][s],v[u][s]=n;o=s}return{U:h,S:_,V:v}}function Ln(t){var e={};if(void 0===t||null===t||"all"===t)return null;if("backbone"===t)return{CA:!0,C:!0,O:!0,N:!0};if(void 0!==t.substr){for(var n=t.split(","),r=0;r<n.length;++r)e[n[r].trim()]=!0;return e}for(var i=0;i<t.length;++i)e[t[i]]=!0;return e}function Bn(t,e,n,r,i){for(var a=t.atoms(),o=e.atoms(),s=0;s<a.length;++s){var u=a[s];if(null===i||!0===i[u.name()])for(var l=0;l<o.length;++l){var h=o[l];if(h.name()===u.name()){n.push(u),r.push(h);break}}}}function jn(t,e,n,r){for(var i=t.full().createEmptyView(),a=e.full().createEmptyView(),o=Math.min(t.chains().length,e.chains().length),s=Ln(n),u=0;u<o;++u){var l=t.chains()[u],h=e.chains()[u],c=r(l,h),d=c[0],f=c[1];if(d.length!==f.length)return console.error("chains",l.name()," and",h.name()," do not contain the same number of residues."),null;for(var _=i.addChain(l),v=a.addChain(h),m=0;m<d.length;++m){var g=d[m],p=f[m],y=[],b=[];if(Bn(g,p,y,b,s),0!==y.length)for(var A=_.addResidue(g),k=v.addResidue(p),C=0;C<y.length;++C)A.addAtom(y[C]),k.addAtom(b[C])}}return[i,a]}function zn(t,e,n){return jn(t,e,n,function(t,e){return[t.residues(),e.residues()]})}function Un(t,e,n){return jn(t,e,n,function(t,e){for(var n=[],r=[],i=t.residues(),a=0;a<i.length;++a){var o=e.residueByRnum(i[a].num());null!==o&&(n.push(i[a]),r.push(o))}return[n,r]})}var qn=Object.freeze({create:t,fromMat4:e,clone:n,copy:r,fromValues:i,set:a,identity:o,transpose:s,invert:u,adjoint:l,determinant:h,multiply:c,mul:c,translate:d,rotate:f,scale:_,fromTranslation:v,fromRotation:m,fromScaling:g,fromMat2d:p,fromQuat:y,normalFromMat4:b,str:A,frob:k,add:C,subtract:w,sub:w,multiplyScalar:R,multiplyScalarAndAdd:M,equals:S}),Wn=Object.freeze({create:T,clone:E,copy:x,fromValues:F,set:O,identity:D,transpose:P,invert:I,adjoint:V,determinant:N,multiply:L,mul:L,translate:B,scale:j,rotate:z,rotateX:U,rotateY:q,rotateZ:W,fromTranslation:H,fromScaling:G,fromRotation:X,fromXRotation:Y,fromYRotation:$,fromZRotation:Z,fromRotationTranslation:K,getTranslation:Q,getScaling:J,getRotation:tt,fromRotationTranslationScale:et,fromRotationTranslationScaleOrigin:nt,fromQuat:rt,frustum:it,perspective:at,perspectiveFromFieldOfView:ot,ortho:st,lookAt:ut,str:lt,frob:ht,add:ct,subtract:dt,sub:dt,multiplyScalar:ft,multiplyScalarAndAdd:_t,equals:vt}),Hn=mt(),Gn=Object.freeze({create:mt,clone:gt,fromValues:pt,copy:yt,set:bt,add:At,subtract:kt,sub:kt,multiply:Ct,mul:Ct,divide:wt,div:wt,ceil:Rt,floor:Mt,min:St,max:Tt,round:Et,scale:xt,scaleAndAdd:Ft,distance:Ot,dist:Ot,squaredDistance:Dt,sqrDist:Dt,length:Pt,len:Pt,squaredLength:It,sqrLen:It,negate:Vt,inverse:Nt,normalize:Lt,dot:Bt,cross:jt,lerp:zt,hermite:Ut,bezier:qt,random:Wt,transformMat4:Ht,transformMat3:Gt,transformQuat:Xt,rotateX:Yt,rotateY:$t,rotateZ:Zt,forEach:Kt,angle:Qt,str:Jt,equals:te}),Xn=ee(),Yn=Object.freeze({create:ee,clone:ne,fromValues:re,copy:ie,set:ae,add:oe,subtract:se,sub:se,multiply:ue,mul:ue,divide:le,div:le,ceil:he,floor:ce,min:de,max:fe,round:_e,scale:ve,scaleAndAdd:me,distance:ge,dist:ge,squaredDistance:pe,sqrDist:pe,length:ye,len:ye,squaredLength:be,sqrLen:be,negate:Ae,inverse:ke,normalize:Ce,dot:we,lerp:Re,random:Me,transformMat4:Se,transformQuat:Te,forEach:Ee,str:xe,equals:Fe}),$n=Ce,Zn=mt(),Kn=pt(1,0,0),Qn=pt(0,1,0),Jn=t(),tr=ne,er=re,nr=ie,rr=ae,ir=oe,ar=ve,or=we,sr=Re,ur=Oe(),lr=Oe(),hr=ye,cr=ye,dr=be,fr=be,_r=Fe,vr=Object.freeze({create:Oe,normalize:$n,rotationTo:De,setAxes:Pe,clone:tr,fromValues:er,copy:nr,set:rr,identity:Ie,setAxisAngle:Ve,getAxisAngle:Ne,add:ir,multiply:Le,mul:Le,scale:ar,rotateX:Be,rotateY:je,rotateZ:ze,calculateW:Ue,dot:or,lerp:sr,slerp:qe,sqlerp:We,invert:He,conjugate:Ge,length:hr,len:cr,squaredLength:dr,sqrLen:fr,fromMat3:Xe,str:Ye,equals:_r}),mr=(function(){var t=new Float32Array(2);t[0]=0,t[1]=0}(),function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}),gr=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),pr=function t(e,n,r){null===e&&(e=Function.prototype);var i=Object.getOwnPropertyDescriptor(e,n);if(void 0===i){var a=Object.getPrototypeOf(e);return null===a?void 0:t(a,n,r)}if("value"in i)return i.value;var o=i.get;if(void 0!==o)return o.call(r)},yr=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},br=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},Ar=function t(e,n){mr(this,t),this.near=e,this.far=n},kr=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{near:.1,far:400};mr(this,t),this._near=e.near,this._far=e.far}return gr(t,[{key:"update",value:function(){return new Ar(this._near,this._far)}}]),t}(),Cr=function(){function t(){mr(this,t),this._far=100}return gr(t,[{key:"update",value:function(t,e){for(var n=e.center(),r=null,i=0;i<t.length;++i){var a=t[i];a.visible()&&(r=a.updateSquaredSphereRadius(n,r))}if(null===r)return null;r=Math.sqrt(r);var o=e.zoom();return new Ar(.1,1.05*(r+o))}}]),t}(),wr=function(){function t(e,n,r){mr(this,t),this._pool=e,this._start=n,this._next=n,this._end=r}return gr(t,[{key:"nextId",value:function(t){var e=this._next;return console.assert(this._next<this._end),this._next++,this._pool._objects[e]=t,e}},{key:"hasLeft",value:function(){return this._next<this._end}},{key:"recycle",value:function(){this._pool.recycle(this)}},{key:"length",value:function(){return this._end-this._start}}]),t}(),Rr=function(){function t(){mr(this,t),this.MAX_ID=16777216,this.clear()}return gr(t,[{key:"getContinuousRange",value:function(t){for(var e=-1,n=null,r=0;r<this._free.length;++r){var i=this._free[r].length();i>=t&&(null===n||i<n)&&(n=i,e=r)}if(-1!==e){var a=this._free[e];return this._free.splice(e,1),this._usedCount++,a}var o=this._unusedRangeStart,s=o+t;if(s>this.MAX_ID)return console.error("not enough free object ids."),null;this._unusedRangeStart=s;var u=new wr(this,o,s);return this._usedCount++,u}},{key:"clear",value:function(){this._objects={},this._unusedRangeStart=1,this._free=[],this._usedCount=0}},{key:"recycle",value:function(t){for(var e=t._start;e<t._next;++e)delete this._objects[e];t._next=t._start,this._free.push(t),this._usedCount--,console.assert(this._usedCount>=0),this._free.length>0&&0===this._usedCount&&this.clear()}},{key:"objectForId",value:function(t){return this._objects[t]}}]),t}(),Mr=function(){function t(e,n){mr(this,t),this._width=n.width,this._height=n.height,this._colorBufferWidth=this._width,this._colorBufferHeight=this._height,this._gl=e,this._colorHandle=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this._colorHandle),this._depthHandle=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,this._depthHandle),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this._width,this._height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,this._depthHandle),this._colorTexture=e.createTexture(),this._initColorBuffer()}return gr(t,[{key:"width",value:function(){return this._width}},{key:"height",value:function(){return this._height}},{key:"bind",value:function(){var t=this._gl;t.bindFramebuffer(t.FRAMEBUFFER,this._colorHandle),t.bindRenderbuffer(t.RENDERBUFFER,this._depthHandle),this._colorBufferWidth===this._width&&this._colorBufferHeight===this._height||this._resizeBuffers(),t.viewport(0,0,this._width,this._height)}},{key:"colorTexture",value:function(){return this._colorTexture}},{key:"_initColorBuffer",value:function(){this.bind();var t=this._gl;t.bindTexture(t.TEXTURE_2D,this._colorTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this._width,this._height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this._colorTexture,0),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,null),this.release()}},{key:"_resizeBuffers",value:function(){var t=this._gl;t.bindRenderbuffer(t.RENDERBUFFER,this._depthHandle),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this._width,this._height),t.bindTexture(t.TEXTURE_2D,this._colorTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this._width,this._height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this._colorTexture,0),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this._depthHandle),t.bindTexture(t.TEXTURE_2D,null),this._colorBufferWidth=this._width,this._colorBufferHeight=this._height}},{key:"resize",value:function(t,e){this._width=t,this._height=e}},{key:"release",value:function(){var t=this._gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null)}}]),t}(),Sr=function(){function t(e){mr(this,t),this._freeArrays=[],this._bufferType=e}return gr(t,[{key:"request",value:function(t){for(var e=-1,n=null,r=0;r<this._freeArrays.length;++r){var i=this._freeArrays[r].length;i>=t&&(null===n||i<n)&&(n=i,e=r)}if(-1!==e){var a=this._freeArrays[e];return this._freeArrays.splice(e,1),a}return new this._bufferType(t)}},{key:"release",value:function(t){this._freeArrays.push(t)}}]),t}(),Tr=void 0,Er={create:ee,scale:ve,copy:ie,clone:ne,fromValues:re,mix:function(t,e,n,r){var i=1-r;return t[0]=e[0]*r+n[0]*i,t[1]=e[1]*r+n[1]*i,t[2]=e[2]*r+n[2]*i,t[3]=e[3]*r+n[3]*i,t}},xr={white:Er.fromValues(1,1,1,1),black:Er.fromValues(0,0,0,1),grey:Er.fromValues(.5,.5,.5,1),lightgrey:Er.fromValues(.8,.8,.8,1),darkgrey:Er.fromValues(.3,.3,.3,1),red:Er.fromValues(1,0,0,1),darkred:Er.fromValues(.5,0,0,1),lightred:Er.fromValues(1,.5,.5,1),green:Er.fromValues(0,1,0,1),darkgreen:Er.fromValues(0,.5,0,1),lightgreen:Er.fromValues(.5,1,.5,1),blue:Er.fromValues(0,0,1,1),darkblue:Er.fromValues(0,0,.5,1),lightblue:Er.fromValues(.5,.5,1,1),yellow:Er.fromValues(1,1,0,1),darkyellow:Er.fromValues(.5,.5,0,1),lightyellow:Er.fromValues(1,1,.5,1),cyan:Er.fromValues(0,1,1,1),darkcyan:Er.fromValues(0,.5,.5,1),lightcyan:Er.fromValues(.5,1,1,1),magenta:Er.fromValues(1,0,1,1),darkmagenta:Er.fromValues(.5,0,.5,1),lightmagenta:Er.fromValues(1,.5,1,1),orange:Er.fromValues(1,.5,0,1),darkorange:Er.fromValues(.5,.25,0,1),lightorange:Er.fromValues(1,.75,.5,1)},Fr=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=void 0,r=void 0,i=void 0,a=void 0;if(4===t.length||5===t.length){n=parseInt(t[1],16),r=parseInt(t[2],16),i=parseInt(t[3],16),a=Math.round(15*e),5===t.length&&(a=parseInt(t[4],16));return Er.fromValues(1/15*n,1/15*r,1/15*i,1/15*a)}if(7===t.length||9===t.length){n=parseInt(t.substr(1,2),16),r=parseInt(t.substr(3,2),16),i=parseInt(t.substr(5,2),16),a=Math.round(255*e),9===t.length&&(a=parseInt(t.substr(7,2),16));return Er.fromValues(1/255*n,1/255*r,1/255*i,1/255*a)}},Or=function(t){console.log("setting colors"),xr=t,Nr()},Dr=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if("string"==typeof t){var n=xr[t];if(void 0!==n&&((t=Er.clone(n))[3]=e),t.length>0&&"#"===t[0])return Fr(t,e)}return 3===t.length?[t[0],t[1],t[2],e]:t},Pr=function(){function t(e,n){mr(this,t),this._colors=e.map(function(t){return Dr(t)}),this._stops=n}return gr(t,[{key:"colorAt",value:function(t,e){if(e<=this._stops[0])return ie(t,this._colors[0]);if(e>=this._stops[this._stops.length-1])return ie(t,this._colors[this._stops.length-1]);for(var n=0,r=1;r<this._stops.length&&!(this._stops[r]>e);++r)n=r;var i=n+1,a=this._stops[n],o=(e-a)/(this._stops[i]-a);return Er.mix(t,this._colors[i],this._colors[n],o)}}]),t}(),Ir=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"equal";return"string"==typeof t?Vr[t]:("equal"===e&&(e=t.map(function(e,n){return Number(n)/(t.length-1)})),new Pr(t,e))},Vr={rainbow:Ir(["blue","green","yellow","red"]),reds:Ir(["lightred","darkred"]),greens:Ir(["lightgreen","darkgreen"]),blues:Ir(["lightblue","darkblue"]),trafficlight:Ir(["green","yellow","red"]),heatmap:Ir(["red","white","blue"])},Nr=function(){Vr={rainbow:Ir(["blue","green","yellow","red"]),reds:Ir(["lightred","darkred"]),greens:Ir(["lightgreen","darkgreen"]),blues:Ir(["lightblue","darkblue"]),trafficlight:Ir(["green","yellow","red"]),heatmap:Ir(["red","white","blue"])}},Lr=function(){function t(e,n,r){mr(this,t),this.colorFor=e,this._beginFunc=n,this._endFunc=r}return gr(t,[{key:"begin",value:function(t){this._beginFunc&&this._beginFunc(t)}},{key:"end",value:function(t){this._endFunc&&this._endFunc(t)}}]),t}(),Br=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"white";return t=Dr(t),new Lr(function(e,n,r){n[r+0]=t[0],n[r+1]=t[1],n[r+2]=t[2],n[r+3]=t[3]})},jr={H:[.87,.87,.87],C:[.61,.61,.61],N:[0,.47,.84],O:[.97,.18,.18],F:[.12,.94,.12],CL:[.12,.94,.12],BR:[.6,.13,0],I:[.4,0,.73],HE:[0,1,1],NE:[0,1,1],AR:[0,1,1],XE:[0,1,1],KR:[0,1,1],P:[1,.43,.13],S:[1,.73,.22],B:[1,.67,.47],LI:[.47,0,1],NA:[.47,0,1],K:[.47,0,1],RB:[.47,0,1],CS:[.47,0,1],FR:[.47,0,1],BE:[0,.47,0],MG:[0,.47,0],SR:[0,.47,0],BA:[0,.47,0],RA:[0,.47,0],TI:[.6,.6,.6],FE:[.56,.31,.12]},zr=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:jr;return new Lr(function(e,n,r){var i=e.element(),a=t[i];return void 0!==a?(n[r]=a[0],n[r+1]=a[1],n[r+2]=a[2],n[r+3]=1,n):(n[r]=1,n[r+1]=0,n[r+2]=1,n[r+3]=1,n)})},Ur=function(t){var e=void 0;return e=t&&t._colors?{C:t._colors[0],H:t._colors[1],E:t._colors[2]}:t?{C:Dr(t.C),H:Dr(t.H),E:Dr(t.E)}:{C:[.8,.8,.8,1],H:[.6,.6,.9,1],E:[.2,.8,.2,1]},new Lr(function(t,n,r){var i=t.residue().ss(),a=e[i];void 0!==a&&(n[r]=a[0],n[r+1]=a[1],n[r+2]=a[2],n[r+3]=a[3])})},qr=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ir("rainbow");return new Lr(function(e,n,r){var i=Tr.chainLimits[e.residue().chain().name()],a=[1,1,1,1],o=0;void 0!==i&&(o=(e.residue().index()-i[0])/(i[1]-i[0])),t.colorAt(a,o),n[r]=a[0],n[r+1]=a[1],n[r+2]=a[2],n[r+3]=a[3]},function(t){var e=t.chains();Tr.chainLimits={},e.forEach(function(t){var e=t.backboneTraces();if(0!==e.length){var n=e[0].residueAt(0).index(),r=e[0].residueAt(e[0].length()-1).index();e.forEach(function(t){n=Math.min(n,t.residueAt(0).index()),r=Math.max(r,t.residueAt(t.length()-1).index())}),n!==r&&(Tr.chainLimits[t.name()]=[n,r])}})},function(){Tr.chainLimits=null})},Wr=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ir("rainbow"),e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"lightgrey";return e=Dr(e),new Lr(function(n,r,i){var a=n.residue().index(),o=Tr.chainLimits[n.residue().chain().name()],s=o.indices[a],u=[0,0,0,0],l=0;if(-1===s)return r[i]=e[0],r[i+1]=e[1],r[i+2]=e[2],void(r[i+3]=e[3]);null!==o.max&&(l=s/(o.max>0?o.max:1)),t.colorAt(u,l),r[i]=u[0],r[i+1]=u[1],r[i+2]=u[2],r[i+3]=u[3]},function(t){var e=t.chains();Tr.chainLimits={},e.forEach(function(t){var e={},n=null,r="C",i=0;t.residues().forEach(function(t){var a=t.ss();"C"===a?("C"!==r&&i++,e[t.index()]=-1):(n=i,e[t.index()]=i),r=a}),Tr.chainLimits[t.name()]={indices:e,max:n}})},function(){Tr.chainLimits=null})},Hr=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ir("rainbow");return new Lr(function(e,n,r){var i=Tr.chainIndices[e.residue().chain().name()]*Tr.scale,a=[0,0,0,0];t.colorAt(a,i),n[r+0]=a[0],n[r+1]=a[1],n[r+2]=a[2],n[r+3]=a[3]},function(t){var e=t.chains();Tr.chainIndices={},e.forEach(function(t,e){Tr.chainIndices[t.name()]=e}),Tr.scale=e.length>1?1/(e.length-1):1},function(){Tr.chainIndices=null})},Gr=function(){var t=ee();return function(e,n,r,i){r.colorAt(t,i),e[n+0]=t[0],e[n+1]=t[1],e[n+2]=t[2],e[n+3]=t[3]}}(),Xr=function(t,e,n){return Ze(t,e,n,"eachAtom",function(t){return t})},Yr=function(t,e,n){return Ze(t,e,n,"eachResidue",function(t){return t.residue()})},$r=function(t,e){for(var n=new Float32Array(4*(e*(t.length/4-1)+1)),r=ee(),i=ee(),a=e/2,o=0,s=0;s<t.length/4-1;++s){ae(r,t[4*s+0],t[4*s+1],t[4*s+2],t[4*s+3]),ae(i,t[4*s+4],t[4*s+5],t[4*s+6],t[4*s+7]);for(var u=0;u<e;++u){var l=u<a?0:1;n[o+0]=r[0]*(1-l)+i[0]*l,n[o+1]=r[1]*(1-l)+i[1]*l,n[o+2]=r[2]*(1-l)+i[2]*l,n[o+3]=r[3]*(1-l)+i[3]*l,o+=4}}return n[o+0]=i[0],n[o+1]=i[1],n[o+2]=i[2],n[o+3]=i[3],n},Zr=Object.freeze({rgb:Er,hex2rgb:Fr,setColorPalette:Or,forceRGB:Dr,gradient:Ir,resetGradients:Nr,uniform:Br,byElement:zr,bySS:Ur,rainbow:qr,ssSuccession:Wr,byChain:Hr,byAtomProp:Xr,byResidueProp:Yr,interpolateColor:$r}),Kr=function(){function t(e){mr(this,t),this._projection=T(),this._camModelView=T(),this._modelView=T(),this._rotation=T(),this._translation=T(),this._near=.1,this._onCameraChangedListeners=[],this._far=4e3,this._fogNear=-5,this._fogFar=50,this._fog=!0,this._fovY=45*Math.PI/180,this._fogColor=pt(1,1,1),this._outlineColor=pt(.1,.1,.1),this._outlineWidth=1,this._outlineEnabled=!0,this._selectionColor=re(.1,1,.1,.7),this._center=mt(),this._zoom=50,this._screenDoorTransparency=!1,this._updateProjectionMat=!0,this._updateModelViewMat=!0,this._upsamplingFactor=1,this._gl=e,this._currentShader=null,this._stateId=0,this.setViewportSize(e.viewportWidth,e.viewportHeight)}return gr(t,[{key:"_incrementStateId",value:function(){this._stateId+=1,this._stateId>68719476735&&(this._stateId=0)}},{key:"setOutlineEnabled",value:function(t){this._outlineEnabled=t,this._incrementStateId()}},{key:"setScreenDoorTransparency",value:function(t){this._screenDoorTransparency=t,this._incrementStateId()}},{key:"setOutlineWidth",value:function(t){this._outlineWidth!==t&&(this._outlineWidth=t,this._incrementStateId())}},{key:"addOnCameraChanged",value:function(t){this._onCameraChangedListeners.push(t)}},{key:"_informOnCameraChangedListeners",value:function(){var t=this;this._onCameraChangedListeners.forEach(function(e){e(t)})}},{key:"setRotation",value:function(t){var e=!1;16===t.length?Ke(this._rotation,t)||(x(this._rotation,t),e=!0):((void 0)(this._rotation,t),e=!0),e&&(this._informOnCameraChangedListeners(),this._updateModelViewMat=!0)}},{key:"upsamplingFactor",value:function(){return this._upsamplingFactor}},{key:"setUpsamplingFactor",value:function(t){if(this._upsamplingFactor!==t){this._incrementStateId(),this._upsamplingFactor=t;var e=this._upsamplingFactor/this._width,n=this._upsamplingFactor/this._height;this._relativePixelSize=new Float32Array([e,n])}}},{key:"mainAxes",value:function(){return[pt(this._rotation[0],this._rotation[4],this._rotation[8]),pt(this._rotation[1],this._rotation[5],this._rotation[9]),pt(this._rotation[2],this._rotation[6],this._rotation[10])]}},{key:"fieldOfViewY",value:function(){return this._fovY}},{key:"setFieldOfViewY",value:function(t){this._fovY=t,this._updateProjectionMat=!0}},{key:"aspectRatio",value:function(){return this._width/this._height}},{key:"rotation",value:function(){return this._rotation}},{key:"_updateIfRequired",value:function(){var t=!1;return this._updateModelViewMat&&(D(this._camModelView),B(this._camModelView,this._camModelView,[-this._center[0],-this._center[1],-this._center[2]]),L(this._camModelView,this._rotation,this._camModelView),D(this._translation),B(this._translation,this._translation,[0,0,-this._zoom]),L(this._camModelView,this._translation,this._camModelView),t=!0),this._updateProjectionMat&&(D(this._projection),at(this._projection,this._fovY,this._width/this._height,this._near,this._far),t=!0),this._updateProjectionMat=!1,this._updateModelViewMat=!1,t&&this._incrementStateId(),t}},{key:"setViewportSize",value:function(t,e){this._updateProjectionMat=!0,this._width=t,this._height=e,this._relativePixelSize=new Float32Array([this._upsamplingFactor/t,this._upsamplingFactor/e])}},{key:"viewportWidth",value:function(){return this._width}},{key:"viewportHeight",value:function(){return this._height}},{key:"setCenter",value:function(t){Ke(this._center,t)||(this._updateModelViewMat=!0,yt(this._center,t),this._informOnCameraChangedListeners())}},{key:"fog",value:function(t){return void 0!==t&&t!==this._fog&&(this._fog=t,this._incrementStateId()),this._fog}},{key:"rotateZ",value:function(t){var e=T();D(e),this._updateModelViewMat=!0,z(e,e,t,[0,0,1]),L(this._rotation,e,this._rotation),this._informOnCameraChangedListeners()}},{key:"rotateX",value:function(t){var e=T();D(e),this._updateModelViewMat=!0,z(e,e,t,[1,0,0]),L(this._rotation,e,this._rotation),this._informOnCameraChangedListeners()}},{key:"rotateY",value:function(t){var e=T();D(e),this._updateModelViewMat=!0,z(e,e,t,[0,1,0]),L(this._rotation,e,this._rotation),this._informOnCameraChangedListeners()}},{key:"panX",value:function(t){return this.panXY(t,0)}},{key:"panY",value:function(t){return this.panXY(0,t)}},{key:"panXY",value:function(t,e){var n=T(),r=mt();P(n,this._rotation),this._updateModelViewMat=!0,bt(r,-t,e,0),Ht(r,r,n),At(r,r,this._center),this.setCenter(r)}},{key:"nearOffset",value:function(){return this._near}},{key:"farOffset",value:function(){return this._far}},{key:"setNearFar",value:function(t,e){t===this._near&&e===this._far||(this._near=t,this._far=e,this._updateProjectionMat=!0)}},{key:"setFogNearFar",value:function(t,e){this._fogNear=t,this._fogFar=e,this._updateProjectionMat=!0}},{key:"setZoom",value:function(t){return Math.abs(this._zoom-t)>1e-8&&(this._updateModelViewMat=!0,this._zoom=t),this._zoom}},{key:"zoom",value:function(t){if(void 0===t)return this._zoom;this._updateModelViewMat=!0;var e=1+.1*t;return this._zoom=Math.min(1e3,Math.max(2,e*this._zoom)),this._informOnCameraChangedListeners(),this._zoom}},{key:"center",value:function(){return this._center}},{key:"setFogColor",value:function(t){this._fogColor=gt(t)}},{key:"currentShader",value:function(){return this._currentShader}},{key:"invalidateCurrentShader",value:function(){this._currentShader=null}},{key:"setOutlineColor",value:function(t){this._outlineColor=gt(t)}},{key:"setSelectionColor",value:function(t){this._selectionColor=gt(t),3===t.length?this._selectionColor=re(t[0],t[1],t[2],.7):this._selectionColor=ne(t),this._incrementStateId()}},{key:"bind",value:function(t,e){var n=!1,r=this._gl;if(this._currentShader!==t&&(this._currentShader=t,r.useProgram(t),n=!0),n=this._updateIfRequired()||n,e?(L(this._modelView,this._camModelView,e),r.uniformMatrix4fv(t.modelview,!1,this._modelView)):r.uniformMatrix4fv(t.modelview,!1,this._camModelView),this._stateId!==t.stateId){t.stateId=this._stateId,r.uniformMatrix4fv(t.projection,!1,this._projection),t.rotation&&r.uniformMatrix4fv(t.rotation,!1,this._rotation),r.uniform1i(t.fog,this._fog);var i=this._zoom;r.uniform1f(t.fogFar,this._fogFar+i),r.uniform1f(t.zoom,this._zoom),r.uniform1f(t.fogNear,this._fogNear+i),r.uniform3fv(t.fogColor,this._fogColor),r.uniform3fv(t.outlineColor,this._outlineColor),r.uniform4fv(t.selectionColor,this._selectionColor),r.uniform2fv(t.relativePixelSize,this._relativePixelSize),r.uniform1f(t.outlineWidth,this._outlineWidth),r.uniform1i(t.screenDoorTransparency,this._screenDoorTransparency),r.uniform1i(t.outlineEnabled,this._outlineEnabled)}}}]),t}(),Qr=function(){function t(e,n,r){mr(this,t),this._element=e,this._element.addEventListener("touchmove",this._touchMove.bind(this)),this._element.addEventListener("touchstart",this._touchStart.bind(this)),this._element.addEventListener("touchend",this._touchEnd.bind(this)),this._element.addEventListener("touchcancel",this._touchEnd.bind(this)),this._touchState={scale:1,rotation:0,center:null},this._lastSingleTap=null,this._viewer=n,this._cam=r}return gr(t,[{key:"_extractEventAttributes",value:function(t,e){var n={};n.center=Qe(e.targetTouches),n.pointers=[];for(var r=0;r<e.targetTouches.length;++r){var i=e.targetTouches[r];n.pointers.push({x:i.clientX,y:i.clientY})}return n.numTouches=e.targetTouches.length,n.rotation=0,n.scale=1,n.deltaScale=0,n.deltaRotation=0,t.center&&(n.deltaCenter={x:n.center.x-t.center.x,y:n.center.y-t.center.y}),2!==t.numTouches||2!==n.numTouches?n:(t.initialPointers?n.initialPointers=t.initialPointers:n.initialPointers=t.pointers,n.scale=tn(n.initialPointers,n.pointers),n.deltaScale=n.scale-t.scale,n.rotation=nn(n.initialPointers,n.pointers),n.deltaRotation=n.rotation-t.rotation,n)}},{key:"_touchMove",value:function(t){t.preventDefault();var e=this._extractEventAttributes(this._touchState,t),n=4*-e.deltaScale;if(0!==n&&this._cam.zoom(n),2===e.numTouches&&2===this._touchState.numTouches){var r=.002*Math.tan(.5*this._cam.fieldOfViewY())*this._cam.zoom();this._cam.panXY(e.deltaCenter.x*r,e.deltaCenter.y*r)}var i=-e.deltaRotation;this._cam.rotateZ(i),1===e.numTouches&&1===this._touchState.numTouches&&(this._cam.rotateX(.005*e.deltaCenter.y),this._cam.rotateY(.005*e.deltaCenter.x)),this._viewer.requestRedraw(),this._touchState=e,this._lastSingleTap=null}},{key:"_touchStart",value:function(t){if(t.preventDefault(),1===t.targetTouches.length){var e=(new Date).getTime();null!==this._lastSingleTap&&e-this._lastSingleTap<300&&(this._viewer._mouseHandler._mouseDoubleClick({clientX:t.targetTouches[0].clientX,clientY:t.targetTouches[0].clientY}),e=null),this._lastSingleTap=e}else this._lastSingleTap=null;this._touchState=this._extractEventAttributes(this._touchState,t)}},{key:"_touchEnd",value:function(t){if(t.preventDefault(),this._lastSingleTap){var e=this._element.getBoundingClientRect(),n=this._touchState.pointers[0],r=this._viewer.pick({x:n.x-e.left,y:n.y-e.top});this._viewer._dispatchEvent(t,"click",r)}}}]),t}(),Jr=function(){function t(e,n,r,i){mr(this,t),this._viewer=n,this._canvas=e,this._cam=r,this._canvas=e,this._animationTime=i,this._lastMouseUpTime=null,this._boundListeners={doubleClick:this._mouseDoubleClick.bind(this),wheel:this._mouseWheel.bind(this),down:this._mouseDown.bind(this),rotate:this._mouseRotate.bind(this),pan:this._mousePan.bind(this),up:this._mouseUp.bind(this)},this._canvas.on("wheel",this._boundListeners.wheel),this._canvas.on("dblclick",this._boundListeners.doubleClick),this._canvas.on("mousedown",this._boundListeners.down)}return gr(t,[{key:"_centerOnClicked",value:function(t){null!==t&&this._viewer.setCenter(t.pos(),this._animationTime)}},{key:"setCam",value:function(t){this._cam=t}},{key:"_mouseUp",value:function(t){var e=this._canvas,n=(new Date).getTime();if((null===this._lastMouseUpTime||n-this._lastMouseUpTime>300)&n-this._lastMouseDownTime<300){var r=this._canvas.domElement().getBoundingClientRect(),i=this._viewer.pick({x:t.clientX-r.left,y:t.clientY-r.top});this._viewer._dispatchEvent(t,"click",i)}this._lastMouseUpTime=n,e.removeEventListener("mousemove",this._mouseRotateListener),e.removeEventListener("mousemove",this._mousePan.bind(this)),e.removeEventListener("mouseup",this._mouseUpListener),document.removeEventListener("mouseup",this._mouseUpListener),document.removeEventListener("mousemove",this._mouseRotateListener),document.removeEventListener("mousemove",this._mousePanListener)}},{key:"_mouseWheel",value:function(t){this._cam.zoom(t.deltaY<0?1:-1),t.preventDefault(),this._viewer.requestRedraw()}},{key:"_mouseDoubleClick",value:function(t){var e=this._canvas.domElement().getBoundingClientRect(),n=this._viewer.pick({x:t.clientX-e.left,y:t.clientY-e.top});this._viewer._dispatchEvent(t,"doubleClick",n),this._viewer.requestRedraw()}},{key:"_mouseDown",value:function(t){0!==t.button&&1!==t.button||(this._lastMouseDownTime=(new Date).getTime(),t.preventDefault(),!0===t.shiftKey||1===t.button?(this._canvas.on("mousemove",this._mousePanListener),document.addEventListener("mousemove",this._mousePanListener,!1)):(this._canvas.on("mousemove",this._mouseRotateListener),document.addEventListener("mousemove",this._mouseRotateListener,!1)),this._canvas.on("mouseup",this._mouseUpListener),document.addEventListener("mouseup",this._mouseUpListener,!1),this._lastMousePos={x:t.pageX,y:t.pageY})}},{key:"_mouseRotate",value:function(t){var e={x:t.pageX,y:t.pageY},n={x:e.x-this._lastMousePos.x,y:e.y-this._lastMousePos.y};this._cam.rotateX(.005*n.y),this._cam.rotateY(.005*n.x),this._lastMousePos=e,this._viewer.requestRedraw()}},{key:"_mousePan",value:function(t){var e={x:t.pageX,y:t.pageY},n={x:e.x-this._lastMousePos.x,y:e.y-this._lastMousePos.y},r=.002*Math.tan(.5*this._cam.fieldOfViewY())*this._cam.zoom();this._cam.panXY(r*n.x,r*n.y),this._lastMousePos=e,this._viewer.requestRedraw()}}]),t}(),ti=function(){function t(e,n){mr(this,t),this._width=n.width,this._antialias=n.antialias,this._height=n.height,this._resize=!1,this._lastTimestamp=null,this._domElement=e,this._initCanvas(),this._backgroundColor=n.backgroundColor,this._forceManualAntialiasing=n.forceManualAntialiasing}return gr(t,[{key:"_ensureSize",value:function(){if(this._resize){this._resize=!1;var t=this._width*this._samples,e=this._height*this._samples;this._realWidth=t,this._realHeight=e,this._gl.viewport(0,0,t,e),this._canvas.width=t,this._canvas.height=e,this._samples>1&&this._initManualAntialiasing(this._samples)}}},{key:"resize",value:function(t,e){t===this._width&&e===this._height||(this._resize=!0,this._width=t,this._height=e)}},{key:"fitParent",value:function(){var t=this._domElement.getBoundingClientRect();this.resize(t.width,t.height)}},{key:"gl",value:function(){return this._gl}},{key:"imageData",value:function(){return this._canvas.toDataURL()}},{key:"_initContext",value:function(){try{var t={antialias:this._antialias&&!this._forceManualAntialiasing,preserveDrawingBuffer:!0};this._gl=this._canvas.getContext("experimental-webgl",t)}catch(t){return console.error("WebGL not supported",t),!1}return!!this._gl||(console.error("WebGL not supported"),!1)}},{key:"_initManualAntialiasing",value:function(t){var e=1/t,n="translate("+.5*-(1-e)*this._realWidth+"px, "+.5*-(1-e)*this._realHeight+"px)"+" "+("scale("+e+", "+e+")");this._canvas.style.webkitTransform=n,this._canvas.style.transform=n,this._canvas.style.ieTransform=n,this._canvas.width=this._realWidth,this._canvas.height=this._realHeight}},{key:"initGL",value:function(){var t=1;if(!this._initContext())return!1;var e=this._gl;return!e.getContextAttributes().antialias&&this._forceManualAntialiasing&&this._antialias&&(t=2),this._realWidth=this._width*t,this._realHeight=this._height*t,this._samples=t,t>1&&this._initManualAntialiasing(t),e.viewportWidth=this._realWidth,e.viewportHeight=this._realHeight,e.clearColor(this._backgroundColor[0],this._backgroundColor[1],this._backgroundColor[2],1),e.lineWidth(2),e.cullFace(e.FRONT),e.enable(e.CULL_FACE),e.enable(e.DEPTH_TEST),!0}},{key:"_shaderFromString",value:function(t,e,n){var r,i=this._gl;if("fragment"===e)r=i.createShader(i.FRAGMENT_SHADER);else{if("vertex"!==e)return console.error("could not determine type for shader"),null;r=i.createShader(i.VERTEX_SHADER)}var a=t.replace("${PRECISION}",n);return i.shaderSource(r,a),i.compileShader(r),i.getShaderParameter(r,i.COMPILE_STATUS)?r:(console.log(a),console.error(i.getShaderInfoLog(r)),null)}},{key:"initShader",value:function(t,e,n){var r=this._gl,i=this._shaderFromString(e,"fragment",n),a=this._shaderFromString(t,"vertex",n),o=r.createProgram();if(r.attachShader(o,a),r.attachShader(o,i),r.linkProgram(o),!r.getProgramParameter(o,r.LINK_STATUS))return console.error("could not initialise shaders"),console.error(r.getShaderInfoLog(o)),null;var s=r.getAttribLocation.bind(r),u=r.getUniformLocation.bind(r);return o.posAttrib=s(o,"attrPos"),o.colorAttrib=s(o,"attrColor"),o.normalAttrib=s(o,"attrNormal"),o.objIdAttrib=s(o,"attrObjId"),o.selectAttrib=s(o,"attrSelect"),o.symId=u(o,"symId"),o.projection=u(o,"projectionMat"),o.modelview=u(o,"modelviewMat"),o.rotation=u(o,"rotationMat"),o.fog=u(o,"fog"),o.fogFar=u(o,"fogFar"),o.fogNear=u(o,"fogNear"),o.fogColor=u(o,"fogColor"),o.outlineColor=u(o,"outlineColor"),o.outlineWidth=u(o,"outlineWidth"),o.relativePixelSize=u(o,"relativePixelSize"),o.screenDoorTransparency=u(o,"screenDoorTransparency"),o.selectionColor=u(o,"selectionColor"),o.pointSize=u(o,"pointSize"),o.zoom=u(o,"zoom"),o.outlineEnabled=u(o,"outlineEnabled"),o}},{key:"on",value:function(t,e){this._canvas.addEventListener(t,e,!1)}},{key:"removeEventListener",value:function(t,e){this._canvas.removeEventListener(t,e,!1)}},{key:"onWheel",value:function(t,e){"onwheel"in this._canvas?this.on("wheel",t):this.on("mousewheel",e)}},{key:"domElement",value:function(){return this._canvas}},{key:"bind",value:function(){this._ensureSize(),this._gl.viewport(0,0,this._realWidth,this._realHeight)}},{key:"superSamplingFactor",value:function(){return this._samples}},{key:"viewportWidth",value:function(){return this._realWidth}},{key:"viewportHeight",value:function(){return this._realHeight}},{key:"width",value:function(){return this._width}},{key:"height",value:function(){return this._height}},{key:"_initCanvas",value:function(){this._canvas=document.createElement("canvas"),this._canvas.width=this._width,this._canvas.height=this._height,this._domElement.appendChild(this._canvas)}},{key:"isWebGLSupported",value:function(){return rn(this._gl)}},{key:"destroy",value:function(){this._canvas.width=1,this._canvas.height=1,this._canvas.parentElement.removeChild(this._canvas),this._canvas=null}}]),t}(),ei=function(){function t(e){mr(this,t),this._children=[],this._visible=!0,this._name=name||"",this._gl=e,this._order=1}return gr(t,[{key:"order",value:function(t){return void 0!==t&&(this._order=t),this._order}},{key:"add",value:function(t){this._children.push(t)}},{key:"draw",value:function(t,e,n,r){for(var i=0,a=this._children.length;i!==a;++i)this._children[i].draw(t,e,n,r)}},{key:"show",value:function(){this._visible=!0}},{key:"hide",value:function(){this._visible=!1}},{key:"name",value:function(t){function e(e){return t.apply(this,arguments)}return e.toString=function(){return t.toString()},e}(function(t){return void 0!==t&&(this._name=t),this._name})},{key:"destroy",value:function(){for(var t=0;t<this._children.length;++t)this._children[t].destroy()}},{key:"visible",value:function(){return this._visible}}]),t}(),ni=function(t,e,n){var r=mt();return jt(r,t,e),Math.atan2(Bt(r,n),Bt(t,e))},ri=function(t,e){var n=mt();return yt(n,e),Math.abs(e[0])<Math.abs(e[1])?Math.abs(e[0])<Math.abs(e[2])?n[0]+=1:n[2]+=1:Math.abs(e[1])<Math.abs(e[2])?n[1]+=1:n[2]+=1,jt(t,e,n)},ii=function(t,e,n){var r=Math.sin(n),i=Math.cos(n),a=e[0],o=e[1],s=e[2],u=a*a,l=a*o,h=a*s,c=o*o,d=o*s,f=s*s;return t[0]=u+i-u*i,t[1]=l-i*l-r*s,t[2]=h-i*h+r*o,t[3]=l-i*l+r*s,t[4]=c+i-i*c,t[5]=d-i*d-r*a,t[6]=h-i*h-r*o,t[7]=d-i*d+r*a,t[8]=f+i-i*f,t},ai=function(t,e,n,r,i,a,o){var s=mt(),u=a*a,l=u*(3-2*a),h=1-l,c=u*(a-2)+a,d=u*(a-1);yt(s,e),xt(s,s,h),Ft(s,s,n,c),Ft(s,s,r,l),Ft(s,s,i,d),t[o]=s[0],t[o+1]=s[1],t[o+2]=s[2]},oi=function(t,e,n){return n?t*e:e*(t-1)+1},si=function(t,e,n,r,i,a){i=i||!1,r=r||.5;var o=null,s=3*oi(e,n,i);o=a?a.request(s):new Float32Array(s);var u=0,l=1/n,h=mt(),c=mt(),d=mt(),f=mt(),_=mt(),v=mt(),m=void 0,g=void 0,p=void 0;for(bt(f,t[0],t[1],t[2]),bt(_,t[3],t[4],t[5]),i?(bt(d,t[t.length-3],t[t.length-2],t[t.length-1]),kt(h,_,d),xt(h,h,r)):(bt(d,t[0],t[1],t[2]),bt(h,0,0,0)),m=1,p=e-1;m<p;++m){for(bt(v,t[3*(m+1)],t[3*(m+1)+1],t[3*(m+1)+2]),kt(c,v,f),xt(c,c,r),g=0;g<n;++g)ai(o,f,h,_,c,l*g,u),u+=3;yt(d,f),yt(f,_),yt(_,v),yt(h,c)}for(i?(bt(v,t[0],t[1],t[3]),kt(c,v,f),xt(c,c,r)):bt(c,0,0,0),g=0;g<n;++g)ai(o,f,h,_,c,l*g,u),u+=3;if(!i)return o[u]=t[3*(e-1)+0],o[u+1]=t[3*(e-1)+1],o[u+2]=t[3*(e-1)+2],o;for(yt(d,f),yt(f,_),yt(_,v),yt(h,c),bt(v,t[3],t[4],t[5]),kt(c,v,f),xt(c,c,r),g=0;g<n;++g)ai(o,f,h,_,c,l*g,u),u+=3;return o},ui=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:mt(),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;mr(this,t),this._center=e,this._radius=n}return gr(t,[{key:"center",get:function(){return this._center}},{key:"radius",get:function(){return this._radius}}]),t}(),li=function(e){for(var n=t(),r=t(),i=t(),a=t(),o=Oe(),u=mt(),l=mt(),h=er(0,0,0,1),d=0;d<24;++d){y(n,h),c(r,n,c(a,e,s(i,n))),bt(u,r[5],r[2],r[1]),bt(l,Math.abs(u[0]),Math.abs(u[1]),Math.abs(u[2]));var f=void 0,_=((f=l[0]>l[1]&&l[0]>l[2]?0:l[1]>l[2]?1:2)+1)%3,v=(f+2)%3;if(0===u[f])break;var m=(r[3*v+v]-r[3*_+_])/(2*u[f]),g=m>0?1:-1,p=g/((m*=g)+(m<1e6?Math.sqrt(m*m+1):m)),b=1/Math.sqrt(p*p+1);if(1===b)break;if(ae(o,0,0,0,0),o[f]=g*Math.sqrt((1-b)/2),o[f]*=-1,o[3]=Math.sqrt(1-o[f]*o[f]),1===o[3])break;h=Le(h,h,o),$n(h,h)}return h},hi=function(t,e,n,r,i){i?jt(r,e,n):ri(r,e),jt(n,r,e),Lt(r,r),Lt(n,n),t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=r[0],t[4]=r[1],t[5]=r[2],t[6]=e[0],t[7]=e[1],t[8]=e[2]},ci=function(t,e){for(var n=new Float32Array(e*(t.length-1)+1),r=0,i=0,a=0,o=1/e,s=0;s<t.length-1;++s){i=t[s],a=t[s+1];for(var u=0;u<e;++u){var l=o*u;n[r+0]=i*(1-l)+a*l,r+=1}}return n[r+0]=a,n},di=function(){function t(e,n){mr(this,t),this._arcs=n,this._stacks=e,this._indices=new Uint16Array(3*n*e*2),this._verts=new Float32Array(3*n*e);var r,i,a=Math.PI/(e-1),o=2*Math.PI/n;for(r=0;r<this._stacks;++r){var s=Math.sin(r*a),u=Math.cos(r*a);for(i=0;i<this._arcs;++i){var l=s*Math.cos(i*o),h=s*Math.sin(i*o);this._verts[3*(i+r*this._arcs)]=l,this._verts[3*(i+r*this._arcs)+1]=h,this._verts[3*(i+r*this._arcs)+2]=u}}var c=0;for(r=0;r<this._stacks-1;++r)for(i=0;i<this._arcs;++i)this._indices[c]=r*this._arcs+i,this._indices[c+1]=r*this._arcs+(i+1)%this._arcs,this._indices[c+2]=(r+1)*this._arcs+i,c+=3,this._indices[c]=r*this._arcs+(i+1)%this._arcs,this._indices[c+1]=(r+1)*this._arcs+(i+1)%this._arcs,this._indices[c+2]=(r+1)*this._arcs+i,c+=3}return gr(t,[{key:"addTransformed",value:function(t,e,n,r,i){for(var a=mt(),o=mt(),s=t.numVerts(),u=0;u<this._stacks*this._arcs;++u)bt(o,this._verts[3*u],this._verts[3*u+1],this._verts[3*u+2]),yt(a,o),xt(a,a,n),At(a,a,e),t.addVertex(a,o,r,i);for(u=0;u<this._indices.length/3;++u)t.addTriangle(s+this._indices[3*u],s+this._indices[3*u+1],s+this._indices[3*u+2])}},{key:"numIndices",value:function(){return this._indices.length}},{key:"numVerts",value:function(){return this._verts.length/3}}]),t}(),fi=function(){function t(e,n,r){mr(this,t);var i=si(e,e.length/3,n,r,!0);this._indices=new Uint16Array(2*i.length),this._verts=i,this._normals=new Float32Array(i.length),this._arcs=i.length/3;for(var a=mt(),o=0;o<this._arcs;++o){var s=0===o?this._arcs-1:o-1,u=o===this._arcs-1?0:o+1;a[0]=this._verts[3*u+1]-this._verts[3*s+1],a[1]=this._verts[3*s]-this._verts[3*u],Lt(a,a),this._normals[3*o]=a[0],this._normals[3*o+1]=a[1],this._normals[3*o+2]=a[2]}for(o=0;o<this._arcs;++o)this._indices[6*o]=o,this._indices[6*o+1]=o+this._arcs,this._indices[6*o+2]=(o+1)%this._arcs+this._arcs,this._indices[6*o+3]=o,this._indices[6*o+4]=(o+1)%this._arcs+this._arcs,this._indices[6*o+5]=(o+1)%this._arcs}return gr(t,[{key:"addTransformed",value:function(t,e,n,r,i,a,o,s){for(var u=mt(),l=mt(),h=this._arcs,c=this._normals,d=this._verts,f=t.numVerts()-h,_=0;_<h;++_)bt(u,n*d[3*_],n*d[3*_+1],0),Gt(u,u,r),At(u,u,e),bt(l,c[3*_],c[3*_+1],0),Gt(l,l,r),t.addVertex(u,l,i,s);if(!a)if(0!==o)for(_=0;_<h;++_)t.addTriangle(f+(_+o)%h,f+_+h,f+(_+1)%h+h),t.addTriangle(f+(_+o)%h,f+(_+1)%h+h,f+(_+1+o)%h);else for(_=0;_<this._indices.length/3;++_)t.addTriangle(f+this._indices[3*_],f+this._indices[3*_+1],f+this._indices[3*_+2])}}]),t}(),_i=function(){function t(e){mr(this,t),this._arcs=e,this._indices=new Uint16Array(3*e*2),this._verts=new Float32Array(3*e*2),this._normals=new Float32Array(3*e*2);for(var n=2*Math.PI/this._arcs,r=0;r<this._arcs;++r){var i=Math.cos(n*r),a=Math.sin(n*r);this._verts[3*r]=i,this._verts[3*r+1]=a,this._verts[3*r+2]=-.5,this._verts[3*e+3*r]=i,this._verts[3*e+3*r+1]=a,this._verts[3*e+3*r+2]=.5,this._normals[3*r]=i,this._normals[3*r+1]=a,this._normals[3*e+3*r]=i,this._normals[3*e+3*r+1]=a}for(r=0;r<this._arcs;++r)this._indices[6*r]=r%this._arcs,this._indices[6*r+1]=e+(r+1)%this._arcs,this._indices[6*r+2]=(r+1)%this._arcs,this._indices[6*r+3]=r%this._arcs,this._indices[6*r+4]=e+r%this._arcs,this._indices[6*r+5]=e+(r+1)%this._arcs}return gr(t,[{key:"numVerts",value:function(){return this._verts.length/3}},{key:"numIndices",value:function(){return this._indices.length}},{key:"addTransformed",value:function(t,e,n,r,i,a,o,s,u){for(var l=mt(),h=mt(),c=t.numVerts(),d=this._verts,f=this._normals,_=this._arcs,v=0;v<2*_;++v){bt(l,r*d[3*v],r*d[3*v+1],n*d[3*v+2]),Gt(l,l,i),At(l,l,e),bt(h,f[3*v],f[3*v+1],f[3*v+2]),Gt(h,h,i);var m=v<_?s:u;t.addVertex(l,h,v<_?a:o,m)}var g=this._indices;for(v=0;v<g.length/3;++v)t.addTriangle(c+g[3*v],c+g[3*v+1],c+g[3*v+2])}}]),t}(),vi=function(){function t(e,n,r){mr(this,t),this._gl=e,this._vertBuffer=e.createBuffer(),this._float32Allocator=r||null,this._ready=!1,this._boundingSphere=null;var i=this._FLOATS_PER_VERT*n;this._vertData=r.request(i)}return gr(t,[{key:"setColor",value:function(t,e,n,r,i){var a=t*this._FLOATS_PER_VERT+this._COLOR_OFFSET;this._vertData[a+0]=e,this._vertData[a+1]=n,this._vertData[a+2]=r,this._vertData[a+3]=i,this._ready=!1}},{key:"getColor",value:function(t,e){var n=t*this._FLOATS_PER_VERT+this._COLOR_OFFSET;return e[0]=this._vertData[n+0],e[1]=this._vertData[n+1],e[2]=this._vertData[n+2],e[3]=this._vertData[n+3],e}},{key:"setOpacity",value:function(t,e){var n=t*this._FLOATS_PER_VERT+this._COLOR_OFFSET;this._vertData[n+3]=e,this._ready=!1}},{key:"setSelected",value:function(t,e){var n=t*this._FLOATS_PER_VERT+this._SELECT_OFFSET;this._vertData[n]=e,this._ready=!1}},{key:"boundingSphere",value:function(){return this._boundingSphere||(this._boundingSphere=this._calculateBoundingSphere()),this._boundingSphere}},{key:"_calculateBoundingSphere",value:function(){var t=this.numVerts();if(0===t)return null;var e,n,r=mt();for(n=0;n<t;++n)e=n*this._FLOATS_PER_VERT,r[0]+=this._vertData[e+0],r[1]+=this._vertData[e+1],r[2]+=this._vertData[e+2];xt(r,r,1/t);var i=0;for(n=0;n<t;++n){e=n*this._FLOATS_PER_VERT;var a=r[0]-this._vertData[e+0],o=r[1]-this._vertData[e+1],s=r[2]-this._vertData[e+2];i=Math.max(i,a*a+o*o+s*s)}return new ui(r,Math.sqrt(i))}},{key:"destroy",value:function(){this._gl.deleteBuffer(this._vertBuffer),this._float32Allocator.release(this._vertData)}},{key:"bindBuffers",value:function(){this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._vertBuffer),this._ready||(this._gl.bufferData(this._gl.ARRAY_BUFFER,this._vertData,this._gl.STATIC_DRAW),this._ready=!0)}},{key:"updateSquaredSphereRadius",value:function(t,e,n){var r=mt(),i=this.boundingSphere();if(!i)return e;if(n)return Ht(r,i.center(),n),Math.max(Dt(r,t),e);var a=i.radius()*i.radius();return Math.max(Dt(i.center(),t)+a,e)}},{key:"updateProjectionIntervals",value:function(t,e,n,r,i,a,o){var s=mt(),u=this.boundingSphere();if(u){o?Ht(s,u.center(),o):yt(s,u.center());var l=Bt(t,s),h=Bt(e,s),c=Bt(n,s);r.update(l-u.radius()),r.update(l+u.radius()),i.update(h-u.radius()),i.update(h+u.radius()),a.update(c-u.radius()),a.update(c+u.radius())}}}]),t}(),mi=function(t){function e(t,n,r,i,a){mr(this,e);var o=br(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,i));return o._FLOATS_PER_VERT=12,o._BYTES_PER_VERT=48,o._OBJID_OFFSET=10,o._OBJID_BYTE_OFFSET=40,o._SELECT_OFFSET=11,o._SELECT_BYTE_OFFSET=44,o._COLOR_OFFSET=6,o._COLOR_BYTE_OFFSET=24,o._NORMAL_OFFSET=3,o._NORMAL_BYTE_OFFSET=12,o._POS_OFFSET=0,o._POS_BYTE_OFFSET=0,o._indexBuffer=t.createBuffer(),o._uint16Allocator=a,o._numVerts=0,o._maxVerts=n,o._numTriangles=0,o._indexData=a.request(r),o}return yr(e,t),gr(e,[{key:"destroy",value:function(){pr(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"destroy",this).call(this),this._gl.deleteBuffer(this._indexBuffer),this._uint16Allocator.release(this._indexData)}},{key:"setIndexData",value:function(t){this._ready=!1,this._numTriangles=t.length/3;for(var e=0;e<t.length;++e)this._indexData[e]=t[e]}},{key:"setVertData",value:function(t){this._ready=!1,this._numVerts=t.length/this._FLOATS_PER_VERT;for(var e=0;e<t.length;++e)this._vertData[e]=t[e]}},{key:"numVerts",value:function(){return this._numVerts}},{key:"maxVerts",value:function(){return this._maxVerts}},{key:"numIndices",value:function(){return 3*this._numTriangles}},{key:"addVertex",value:function(t,e,n,r){if(this._numVerts!==this._maxVerts){var i=this._numVerts*this._FLOATS_PER_VERT;this._vertData[i++]=t[0],this._vertData[i++]=t[1],this._vertData[i++]=t[2],this._vertData[i++]=e[0],this._vertData[i++]=e[1],this._vertData[i++]=e[2],this._vertData[i++]=n[0],this._vertData[i++]=n[1],this._vertData[i++]=n[2],this._vertData[i++]=n[3],this._vertData[i++]=r,this._vertData[i++]=0,this._numVerts+=1,this._ready=!1}else console.error("maximum number of vertices reached")}},{key:"addTriangle",value:function(t,e,n){var r=3*this._numTriangles;r+2>=this._indexData.length||(this._indexData[r++]=t,this._indexData[r++]=e,this._indexData[r++]=n,this._numTriangles+=1,this._ready=!1)}},{key:"bindBuffers",value:function(){var t=this._ready,n=this._gl;pr(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"bindBuffers",this).call(this),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this._indexBuffer),t||n.bufferData(n.ELEMENT_ARRAY_BUFFER,this._indexData,n.STATIC_DRAW)}},{key:"bindAttribs",value:function(t){var e=this._gl,n=this._BYTES_PER_VERT;e.enableVertexAttribArray(t.posAttrib),e.vertexAttribPointer(t.posAttrib,3,e.FLOAT,!1,n,this._POS_BYTE_OFFSET),-1!==t.normalAttrib&&(e.enableVertexAttribArray(t.normalAttrib),e.vertexAttribPointer(t.normalAttrib,3,e.FLOAT,!1,n,this._NORMAL_BYTE_OFFSET)),-1!==t.colorAttrib&&(e.vertexAttribPointer(t.colorAttrib,4,e.FLOAT,!1,n,this._COLOR_BYTE_OFFSET),e.enableVertexAttribArray(t.colorAttrib)),-1!==t.objIdAttrib&&(e.vertexAttribPointer(t.objIdAttrib,1,e.FLOAT,!1,n,this._OBJID_BYTE_OFFSET),e.enableVertexAttribArray(t.objIdAttrib)),-1!==t.selectAttrib&&(e.vertexAttribPointer(t.selectAttrib,1,e.FLOAT,!1,n,this._SELECT_BYTE_OFFSET),e.enableVertexAttribArray(t.selectAttrib))}},{key:"releaseAttribs",value:function(t){var e=this._gl;e.disableVertexAttribArray(t.posAttrib),-1!==t.colorAttrib&&e.disableVertexAttribArray(t.colorAttrib),-1!==t.normalAttrib&&e.disableVertexAttribArray(t.normalAttrib),-1!==t.objIdAttrib&&e.disableVertexAttribArray(t.objIdAttrib),-1!==t.selectAttrib&&e.disableVertexAttribArray(t.selectAttrib)}},{key:"bind",value:function(t){this.bindBuffers(),this.bindAttribs(t)}},{key:"draw",value:function(){var t=this._gl;t.drawElements(t.TRIANGLES,3*this._numTriangles,t.UNSIGNED_SHORT,0)}}]),e}(vi),gi=function(){function t(){mr(this,t),this._vertData=[],this._indexData=[],this._numVerts=0}return gr(t,[{key:"numVerts",value:function(){return this._numVerts}},{key:"addVertex",value:function(t,e,n,r){this._numVerts+=1,this._vertData.push(t[0],t[1],t[2],e[0],e[1],e[2],n[0],n[1],n[2],n[3],r,0)}},{key:"addTriangle",value:function(t,e,n){this._indexData.push(t,e,n)}},{key:"numIndices",value:function(){return this._indexData.length}},{key:"indexData",value:function(){return this._indexData}},{key:"vertData",value:function(){return this._vertData}}]),t}(),pi=function(e){function n(t,e,r,i,a){mr(this,n);var o=br(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return o._float32Allocator=r,o._uint16Allocator=i,o._data=new gi,o._protoSphere=new di(8,8),o._protoCyl=new _i(8),o._va=null,o._idRanges=[],o._idPool=a,o._ready=!1,o._currentRange=null,o}return yr(n,e),gr(n,[{key:"updateSquaredSphereRadius",value:function(t,e){return e}},{key:"addTube",value:function(e,n,r,i){var a=mt(),o=mt(),s=mt(),u=mt(),l=t(),h=Dr((i=i||{}).color||"white"),c=!0;void 0!==i.cap&&(c=i.cap),kt(u,n,e);var d=Pt(u);if(Lt(u,u),At(a,e,n),xt(a,a,.5),hi(l,u,o,s,!1),c){var f=this._data.numVerts();this._data.addVertex(e,[-u[0],-u[1],-u[2]],h,0),an(this._data,f,8)}var _=void 0!==i.userData?i.userData:null;console.log(_);var v=this._nextObjectId({center:a,userData:_,geom:this});if(this._protoCyl.addTransformed(this._data,a,d,r,l,h,h,v,v),c){var m=this._data.numVerts();this._data.addVertex(n,u,h,0),on(this._data,m-8,8)}this._ready=!1}},{key:"_nextObjectId",value:function(t){return this._currentRange&&this._currentRange.hasLeft()||(this._currentRange=this._idPool.getContinuousRange(100),this._idRanges.push(this._currentRange)),this._currentRange.nextId(t)}},{key:"destroy",value:function(){ei.prototype.destroy.call(this);for(var t=0;t<this._idRanges.length;++t)this._idRanges[t].recycle()}},{key:"addSphere",value:function(t,e,n){var r=Dr((n=n||{}).color||"white"),i=void 0!==n.userData?n.userData:null,a=this._nextObjectId({center:t,userData:i,geom:this});this._protoSphere.addTransformed(this._data,t,e,r,a),this._ready=!1}},{key:"_prepareVertexArray",value:function(){this._ready=!0,null!==this._va&&this._va.destroy(),this._va=new mi(this._gl,this._data.numVerts(),this._data.numIndices(),this._float32Allocator,this._uint16Allocator),this._va.setIndexData(this._data.indexData()),this._va.setVertData(this._data.vertData())}},{key:"draw",value:function(t,e,n,r){if(this._visible){this._ready||this._prepareVertexArray();var i=this.shaderForStyleAndPass(e,n,r);if(i){t.bind(i),this._gl.uniform1i(i.symId,255);var a=this._va;a.bind(i),a.draw(),a.releaseAttribs(i)}}}},{key:"shaderForStyleAndPass",value:function(t,e,n){if("normal"===n)return"hemilight"===e?t.hemilight:t.phong;if("select"===n)return t.select;if("outline"===n)return t.outline;var r=t[n];return void 0!==r?r:null}}]),n}(ei),yi=function(t){function e(t,n,r,i,a,o){mr(this,e);var s=br(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t)),u=o||{};s._options={},s._options.fillStyle=u.fillStyle||"#000",s._options.backgroundAlpha=u.backgroundAlpha||0,s._options.fontSize=u.fontSize||24,s._options.font=u.font||"Verdana",s._options.fontStyle=u.fontStyle||"normal",s._options.fontColor=u.fontColor||"#000",s._order=100,s._pos=i,s._interleavedBuffer=s._gl.createBuffer(),s._interleavedData=new Float32Array(30),s._prepareText(n,r,a);return s._interleavedData[0]=i[0],s._interleavedData[1]=i[1],s._interleavedData[2]=i[2],s._interleavedData[3]=-.5,s._interleavedData[4]=-.5,s._interleavedData[5]=i[0],s._interleavedData[6]=i[1],s._interleavedData[7]=i[2],s._interleavedData[8]=.5,s._interleavedData[9]=.5,s._interleavedData[10]=i[0],s._interleavedData[11]=i[1],s._interleavedData[12]=i[2],s._interleavedData[13]=.5,s._interleavedData[14]=-.5,s._interleavedData[15]=i[0],s._interleavedData[16]=i[1],s._interleavedData[17]=i[2],s._interleavedData[18]=-.5,s._interleavedData[19]=-.5,s._interleavedData[20]=i[0],s._interleavedData[21]=i[1],s._interleavedData[22]=i[2],s._interleavedData[23]=-.5,s._interleavedData[24]=.5,s._interleavedData[25]=i[0],s._interleavedData[26]=i[1],s._interleavedData[27]=i[2],s._interleavedData[28]=.5,s._interleavedData[29]=.5,s}return yr(e,t),gr(e,[{key:"updateProjectionIntervals",value:function(){}},{key:"updateSquaredSphereRadius",value:function(t,e){return e}},{key:"_setupTextParameters",value:function(t){t.fillStyle=this._options.fontColor,t.textAlign="left",t.textBaseline="bottom",t.font=this._options.fontStyle+" "+this._options.fontSize+" px "+this._options.font}},{key:"_prepareText",value:function(t,e,n){this._setupTextParameters(e);var r=e.measureText(n).width,i=this._options.fontSize;t.width=sn(r),t.height=sn(i),e.fillStyle=this._options.fillStyle,e.globalAlpha=this._options.backgroundAlpha,e.fillRect(0,0,t.width,t.height),this._setupTextParameters(e),e.globalAlpha=1,e.lineWidth=.5,e.lineStyle="none",e.fillText(n,0,t.height),e.strokeText(n,0,t.height),this._texture=this._gl.createTexture(),this._textureFromCanvas(this._texture,t),this._xScale=r/t.width,this._yScale=i/t.height,this._width=r,this._height=i}},{key:"_textureFromCanvas",value:function(t,e){var n=this._gl;n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,!0),n.bindTexture(n.TEXTURE_2D,t),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,e),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.generateMipmap(n.TEXTURE_2D),n.bindTexture(n.TEXTURE_2D,null)}},{key:"bind",value:function(){var t=this._gl;t.bindBuffer(t.ARRAY_BUFFER,this._interleavedBuffer),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this._texture),this._ready||(t.bufferData(t.ARRAY_BUFFER,this._interleavedData,t.STATIC_DRAW),this._ready=!0)}},{key:"draw",value:function(t,e,n,r){if(this._visible&&"normal"===r){var i=e.text;t.bind(i),this.bind();var a=this._gl,o=t.upsamplingFactor();a.uniform1f(a.getUniformLocation(i,"xScale"),this._xScale),a.uniform1f(a.getUniformLocation(i,"yScale"),this._yScale),a.uniform1f(a.getUniformLocation(i,"width"),2*o*this._width/t.viewportWidth()),a.uniform1f(a.getUniformLocation(i,"height"),2*o*this._height/t.viewportHeight()),a.uniform1i(a.getUniformLocation(i,"sampler"),0);var s=a.getAttribLocation(i,"attrCenter");a.enableVertexAttribArray(s),a.vertexAttribPointer(s,3,a.FLOAT,!1,20,0);var u=a.getAttribLocation(i,"attrCorner");a.vertexAttribPointer(u,2,a.FLOAT,!1,20,12),a.enableVertexAttribArray(u),a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),a.drawArrays(a.TRIANGLES,0,6),a.disableVertexAttribArray(s),a.disableVertexAttribArray(u),a.disable(a.BLEND)}}}]),e}(ei),bi=function(){function t(e,n){mr(this,t),this._structure=e,this._assocs=[],this._callBeginEnd=n}return gr(t,[{key:"addAssoc",value:function(t,e,n,r){this._assocs.push({atom:t,vertexArray:e,vertStart:n,vertEnd:r})}},{key:"recolor",value:function(t,e){var n=new Float32Array(4*e.atomCount());this._callBeginEnd&&t.begin(this._structure);var r={};e.eachAtom(function(e,i){r[e.index()]=i,t.colorFor(e,n,4*i)}),this._callBeginEnd&&t.end(this._structure);for(var i=0;i<this._assocs.length;++i){var a=this._assocs[i],o=r[a.atom.index()];if(void 0!==o)for(var s=n[4*o+0],u=n[4*o+1],l=n[4*o+2],h=n[4*o+3],c=a.vertexArray,d=a.vertStart;d<a.vertEnd;++d)c.setColor(d,s,u,l,h)}}},{key:"getColorForAtom",value:function(t,e){for(var n=0;n<this._assocs.length;++n){var r=this._assocs[n];if(r.atom.full()===t.full())return r.vertexArray.getColor(r.vertStart,e)}return null}},{key:"setSelection",value:function(t){var e={};t.eachAtom(function(t){e[t.index()]=!0});for(var n=0;n<this._assocs.length;++n)for(var r=this._assocs[n],i=!0!==e[r.atom.index()]?0:1,a=r.vertexArray,o=r.vertStart;o<r.vertEnd;++o)a.setSelected(o,i)}},{key:"setOpacity",value:function(t,e){var n={};e.eachAtom(function(t){n[t.index()]=!0});for(var r=0;r<this._assocs.length;++r){var i=this._assocs[r];if(!0===n[i.atom.index()])for(var a=i.vertexArray,o=i.vertStart;o<i.vertEnd;++o)a.setOpacity(o,t)}}}]),t}(),Ai=function(){function t(e,n,r){mr(this,t),this._structure=e,this._assocs=[],this._callBeginEnd=r,this._interpolation=n||1,this._perResidueColors={}}return gr(t,[{key:"setPerResidueColors",value:function(t,e){this._perResidueColors[t]=e}},{key:"addAssoc",value:function(t,e,n,r,i){this._assocs.push({traceIndex:t,slice:n,vertStart:r,vertEnd:i,vertexArray:e})}},{key:"recolor",value:function(t,e){this._callBeginEnd&&t.begin(this._structure);var n,r,i=[],a=this._structure.backboneTraces();for(console.assert(this._perResidueColors,"per-residue colors must be set for recoloring to work"),n=0;n<a.length;++n){var o=this._perResidueColors[n];console.assert(o,"no per-residue colors. Seriously, man?");var s=0,u=a[n];for(r=0;r<u.length();++r)e.containsResidue(u.residueAt(r))?(t.colorFor(u.centralAtomAt(r),o,s),s+=4):s+=4;this._interpolation>1?i.push($r(o,this._interpolation)):i.push(o)}for(n=0;n<this._assocs.length;++n){var l=this._assocs[n],h=l.slice,c=i[l.traceIndex],d=c[4*h],f=c[4*h+1],_=c[4*h+2],v=c[4*h+3],m=l.vertexArray;for(r=l.vertStart;r<l.vertEnd;++r)m.setColor(r,d,f,_,v)}this._callBeginEnd&&t.end(this._structure)}},{key:"getColorForAtom",value:function(t,e){var n,r,i=this._structure.backboneTraces(),a=t.full().residue();for(n=0;n<i.length;++n){var o=this._perResidueColors[n],s=0,u=i[n];for(r=0;r<u.length();++r){if(a===u.residueAt(r).full())return e[0]=o[s+0],e[1]=o[s+1],e[2]=o[s+2],e[3]=o[s+3],e;s+=4}}return null}},{key:"setSelection",value:function(t){var e,n,r=[],i=this._structure.backboneTraces();for(e=0;e<i.length;++e){var a=new Float32Array(this._perResidueColors[e].length),o=0,s=i[e];for(n=0;n<s.length();++n){var u=t.containsResidue(s.residueAt(n))?1:0;a[o]=u,o+=1}this._interpolation>1?r.push(ci(a,this._interpolation)):r.push(a)}for(e=0;e<this._assocs.length;++e){var l=this._assocs[e],h=l.slice,c=r[l.traceIndex][h],d=l.vertexArray;for(n=l.vertStart;n<l.vertEnd;++n)d.setSelected(n,c)}}},{key:"setOpacity",value:function(t,e){var n,r,i=[],a=this._structure.backboneTraces();for(n=0;n<a.length;++n){var o=this._perResidueColors[n],s=0,u=a[n];for(r=0;r<u.length();++r)e.containsResidue(u.residueAt(r))?(o[s+3]=t,s+=4):s+=4;this._interpolation>1?i.push($r(o,this._interpolation)):i.push(o)}for(n=0;n<this._assocs.length;++n){var l=this._assocs[n],h=l.slice,c=i[l.traceIndex][4*h+3],d=l.vertexArray;for(r=l.vertStart;r<l.vertEnd;++r)d.setOpacity(r,c)}}}]),t}(),ki=void 0,Ci={chain:function(){return ki._chain},drawSymmetryRelated:function(t,e,n){ki.bind(e);for(var r=0;r<n.length;++r)t.bind(e,n[r]),ki._gl.uniform1i(e.symId,r),ki.draw();ki.releaseAttribs(e)}},wi=function(t){function e(t,n,r,i){mr(this,e);var a=br(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,r,i));return a.chain=Ci.chain.bind(Ci),a.drawSymmetryRelated=Ci.drawSymmetryRelated.bind(Ci),a._chain=t,a}return yr(e,t),e}(function(t){function e(t,n,r){mr(this,e);var i=br(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,r));return i._FLOATS_PER_VERT=9,i._POS_OFFSET=0,i._COLOR_OFFSET=3,i._ID_OFFSET=7,i._SELECT_OFFSET=8,i._numVerts=0,i._primitiveType=i._gl.LINES,i}return yr(e,t),gr(e,[{key:"numVerts",value:function(){return this._numVerts}},{key:"setDrawAsPoints",value:function(t){this._primitiveType=t?this._gl.POINTS:this._gl.LINES}},{key:"addPoint",value:function(t,e,n){var r=this._FLOATS_PER_VERT*this._numVerts;this._vertData[r++]=t[0],this._vertData[r++]=t[1],this._vertData[r++]=t[2],this._vertData[r++]=e[0],this._vertData[r++]=e[1],this._vertData[r++]=e[2],this._vertData[r++]=e[3],this._vertData[r++]=n,this._vertData[r++]=0,this._numVerts+=1,this._ready=!1,this._boundingSphere=null}},{key:"addLine",value:function(t,e,n,r,i,a){this.addPoint(t,e,i),this.addPoint(n,r,a)}},{key:"bindAttribs",value:function(t){this._gl.vertexAttribPointer(t.posAttrib,3,this._gl.FLOAT,!1,4*this._FLOATS_PER_VERT,4*this._POS_OFFSET),-1!==t.colorAttrib&&(this._gl.vertexAttribPointer(t.colorAttrib,4,this._gl.FLOAT,!1,4*this._FLOATS_PER_VERT,4*this._COLOR_OFFSET),this._gl.enableVertexAttribArray(t.colorAttrib)),this._gl.enableVertexAttribArray(t.posAttrib),-1!==t.objIdAttrib&&(this._gl.vertexAttribPointer(t.objIdAttrib,1,this._gl.FLOAT,!1,4*this._FLOATS_PER_VERT,4*this._ID_OFFSET),this._gl.enableVertexAttribArray(t.objIdAttrib)),-1!==t.selectAttrib&&(this._gl.vertexAttribPointer(t.selectAttrib,1,this._gl.FLOAT,!1,4*this._FLOATS_PER_VERT,4*this._SELECT_OFFSET),this._gl.enableVertexAttribArray(t.selectAttrib))}},{key:"releaseAttribs",value:function(t){this._gl.disableVertexAttribArray(t.posAttrib),-1!==t.colorAttrib&&this._gl.disableVertexAttribArray(t.colorAttrib),-1!==t.objIdAttrib&&this._gl.disableVertexAttribArray(t.objIdAttrib),-1!==t.selectAttrib&&this._gl.disableVertexAttribArray(t.selectAttrib)}},{key:"bind",value:function(t){this.bindBuffers(),this.bindAttribs(t)}},{key:"draw",value:function(){this._gl.drawArrays(this._primitiveType,0,this._numVerts)}}]),e}(vi)),Ri=function(t){function e(t,n,r,i,a,o){mr(this,e);var s=br(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,r,i,a,o));return s.chain=Ci.chain.bind(Ci),s.drawSymmetryRelated=Ci.drawSymmetryRelated.bind(Ci),s}return yr(e,t),e}(mi),Mi=function(t,e,n){for(var r=mt(),i=0;i<e.length;++i)for(var a=e[i],o=t.chainsByName(a.chains()),s=0;s<a.matrices().length;++s)for(var u=a.matrix(s),l=0;l<o.length;++l)for(var h=o[l],c=0;c<h.residues().length;++c){var d=h.residues()[c].centralAtom();null!==d&&(Ht(r,d.pos(),u),n(d,r))}},Si=function(t){function e(t,n,r){mr(this,e);var i=br(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i._indexedVAs=[],i._float32Allocator=n,i._uint16Allocator=r,i._remainingVerts=null,i._remainingIndices=null,i}return yr(e,t),gr(e,[{key:"_boundedVertArraySize",value:function(t){return Math.min(65536,t)}},{key:"addChainVertArray",value:function(t,e,n){this._remainingVerts=e,this._remainingIndices=n;var r=new Ri(t.name(),this._gl,this._boundedVertArraySize(e),n,this._float32Allocator,this._uint16Allocator);return this._indexedVAs.push(r),r}},{key:"addVertArray",value:function(t,e){this._remainingVerts=t,this._remainingIndices=e;var n=new mi(this._gl,this._boundedVertArraySize(t),e,this._float32Allocator,this._uint16Allocator);return this._indexedVAs.push(n),n}},{key:"vertArrayWithSpaceFor",value:function(t){var e=this._indexedVAs[this._indexedVAs.length-1];if(e.maxVerts()-e.numVerts()>=t)return e;this._remainingVerts-=e.numVerts(),this._remainingIndices-=e.numIndices(),t=this._boundedVertArraySize(this._remainingVerts);var n=null;return n=e instanceof Ri?new Ri(e.chain(),this._gl,t,this._remainingIndices,this._float32Allocator,this._uint16Allocator):new mi(this._gl,t,this._remainingIndices,this._float32Allocator,this._uint16Allocator),this._indexedVAs.push(n),n}},{key:"vertArray",value:function(t){return this._indexedVAs[t]}},{key:"destroy",value:function(){pr(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"destroy",this).call(this);for(var t=0;t<this._indexedVAs.length;++t)this._indexedVAs[t].destroy();this._indexedVAs=[]}},{key:"numVerts",value:function(){return this._indexedVAs[0].numVerts()}},{key:"shaderForStyleAndPass",value:function(t,e,n){if("normal"===n)return"hemilight"===e?t.hemilight:t.phong;if("select"===n)return t.select;if("outline"===n)return t.outline;var r=t[n];return void 0!==r?r:null}},{key:"_drawVertArrays",value:function(t,e,n,r){var i;if(r)for(i=0;i<n.length;++i)n[i].drawSymmetryRelated(t,e,r);else for(t.bind(e),this._gl.uniform1i(e.symId,255),i=0;i<n.length;++i)n[i].bind(e),n[i].draw(),n[i].releaseAttribs(e)}},{key:"vertArrays",value:function(){return this._indexedVAs}},{key:"addVertex",value:function(t,e,n,r){this._indexedVAs[0].addVertex(t,e,n,r)}},{key:"addTriangle",value:function(t,e,n){this._indexedVAs[0].addTriangle(t,e,n)}}]),e}(function(t){function e(t){mr(this,e);var n=br(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n._idRanges=[],n._vertAssocs=[],n._showRelated=null,n._selection=null,n}return yr(e,t),gr(e,[{key:"setShowRelated",value:function(t){if(!t||"asym"===t||null!==this.structure().assembly(t))return this._showRelated=t,t;console.error("no assembly with name",t,". Falling back to asymmetric unit")}},{key:"symWithIndex",value:function(t){if("asym"===this.showRelated())return null;var e=this.structure().assembly(this.showRelated());if(!e)return null;for(var n=e.generators(),r=0;r<n.length;++r){if(n[r].matrices().length>t)return n[r].matrix(t);t-=n[r].matrices().length}return null}},{key:"showRelated",value:function(){return this._showRelated}},{key:"select",value:function(t){return this.structure().select(t)}},{key:"structure",value:function(){return this._vertAssocs[0]._structure}},{key:"getColorForAtom",value:function(t,e){return this._vertAssocs[0].getColorForAtom(t,e)}},{key:"addIdRange",value:function(t){this._idRanges.push(t)}},{key:"destroy",value:function(){ei.prototype.destroy.call(this);for(var t=0;t<this._idRanges.length;++t)this._idRanges[t].recycle()}},{key:"eachCentralAtom",value:function(t){var e=this,n=e.structure(),r=n.assembly(e.showRelated());return null===r?un(n,t):Mi(n,r.generators(),t)}},{key:"addVertAssoc",value:function(t){this._vertAssocs.push(t)}},{key:"_vertArraysInvolving",value:function(t){for(var e=this.vertArrays(),n=[],r={},i=0;i<t.length;++i)r[t[i]]=!0;for(var a=0;a<e.length;++a)!0===r[e[a].chain()]&&n.push(e[a]);return n}},{key:"_drawSymmetryRelated",value:function(t,e,n){for(var r=n.generators(),i=0;i<r.length;++i){var a=r[i],o=this._vertArraysInvolving(a.chains());this._drawVertArrays(t,e,o,a.matrices())}}},{key:"_updateProjectionIntervalsAsym",value:function(t,e,n,r,i,a){for(var o=this.vertArrays(),s=0;s<o.length;++s)o[s].updateProjectionIntervals(t,e,n,r,i,a)}},{key:"updateProjectionIntervals",value:function(t,e,n,r,i,a){if(this._visible){var o=this.showRelated();if("asym"===o)return this._updateProjectionIntervalsAsym(t,e,n,r,i,a);for(var s=this.structure().assembly(o).generators(),u=0;u<s.length;++u)for(var l=s[u],h=this._vertArraysInvolving(l.chains()),c=0;c<l.matrices().length;++c)for(var d=0;d<h.length;++d){var f=l.matrix(c);h[d].updateProjectionIntervals(t,e,n,r,i,a,f)}}}},{key:"_updateSquaredSphereRadiusAsym",value:function(t,e){for(var n=this.vertArrays(),r=0;r<n.length;++r)e=n[r].updateSquaredSphereRadius(t,e);return e}},{key:"updateSquaredSphereRadius",value:function(t,e){if(!this._visible)return e;var n=this.showRelated();if("asym"===n)return this._updateSquaredSphereRadiusAsym(t,e);for(var r=this.structure().assembly(n).generators(),i=0;i<r.length;++i)for(var a=r[i],o=this._vertArraysInvolving(a.chains()),s=0;s<a.matrices().length;++s)for(var u=0;u<o.length;++u)e=o[u].updateSquaredSphereRadius(t,e);return e}},{key:"draw",value:function(t,e,n,r){if(this._visible){var i=this.shaderForStyleAndPass(e,n,r);if(i){var a=this.showRelated();if("asym"===a)return this._drawVertArrays(t,i,this.vertArrays(),null);var o=this.structure().assembly(a);return this._drawSymmetryRelated(t,i,o)}}}},{key:"colorBy",value:function(t,e){console.time("BaseGeom.colorBy"),this._ready=!1,e=e||this.structure();for(var n=0;n<this._vertAssocs.length;++n)this._vertAssocs[n].recolor(t,e);console.timeEnd("BaseGeom.colorBy")}},{key:"setOpacity",value:function(t,e){console.time("BaseGeom.setOpacity"),this._ready=!1,e=e||this.structure();for(var n=0;n<this._vertAssocs.length;++n)this._vertAssocs[n].setOpacity(t,e);console.timeEnd("BaseGeom.setOpacity")}},{key:"setSelection",value:function(t){console.time("BaseGeom.setSelection"),this._selection=t,this._ready=!1;for(var e=0;e<this._vertAssocs.length;++e)this._vertAssocs[e].setSelection(t);console.timeEnd("BaseGeom.setSelection")}},{key:"selection",value:function(){return null===this._selection&&(this._selection=this.structure().createEmptyView()),this._selection}}]),e}(ei)),Ti=function(t){function e(){return mr(this,e),br(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return yr(e,t),gr(e,[{key:"draw",value:function(t,e,n,r){this._gl.disable(this._gl.CULL_FACE),Si.prototype.draw.call(this,t,e,n,r),this._gl.enable(this._gl.CULL_FACE)}},{key:"shaderForStyleAndPass",value:function(t,e,n){return"normal"===n?t.spheres:"select"===n?t.selectSpheres:null}}]),e}(Si),Ei=function(t){function e(t,n){mr(this,e);var r=br(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return r._vertArrays=[],r._float32Allocator=n,r._lineWidth=.5,r._pointSize=1,r}return yr(e,t),gr(e,[{key:"addChainVertArray",value:function(t,e){var n=new wi(t.name(),this._gl,e,this._float32Allocator);return this._vertArrays.push(n),n}},{key:"setLineWidth",value:function(t){this._lineWidth=t}},{key:"setPointSize",value:function(t){this._pointSize=t}},{key:"vertArrays",value:function(){return this._vertArrays}},{key:"shaderForStyleAndPass",value:function(t,e,n){return"outline"===n?t.selectLines:"select"===n?t.select:t.lines}},{key:"destroy",value:function(){pr(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"destroy",this).call(this);for(var t=0;t<this._vertArrays.length;++t)this._vertArrays[t].destroy();this._vertArrays=[]}},{key:"_drawVertArrays",value:function(t,e,n,r){var i=t.upsamplingFactor();-1!==e.selectAttrib&&(i=4*t.upsamplingFactor());var a;if(r)for(t.bind(e),this._gl.lineWidth(i*this._lineWidth),e.pointSize&&this._gl.uniform1f(e.pointSize,i*this._pointSize),a=0;a<n.length;++a)n[a].drawSymmetryRelated(t,e,r);else for(t.bind(e),this._gl.lineWidth(i*this._lineWidth),this._gl.uniform1i(e.symId,255),e.pointSize&&this._gl.uniform1f(e.pointSize,i*this._pointSize),a=0;a<n.length;++a)n[a].bind(e),n[a].draw(),n[a].releaseAttribs(e)}},{key:"vertArray",value:function(){return this._va}}]),e}(wi),xi=.6,Fi=.8071,Oi=[-xi,-xi,0,xi,-xi,0,xi,xi,0,-xi,xi,0],Di=[-6*xi,-.9*Fi,0,-3.48,-1*Fi,0,3.48,-1*Fi,0,6*xi,-.9*Fi,0,6*xi,.9*Fi,0,3.48,1*Fi,0,-3.48,1*Fi,0,-6*xi,.9*Fi,0],Pi=[-6,-.9*Fi,0,-5.88,-1*Fi,0,5.88,-1*Fi,0,6,-.9*Fi,0,6,.9*Fi,0,5.88,1*Fi,0,-5.88,1*Fi,0,-6,.9*Fi,0],Ii={H:1.1,C:1.7,N:1.55,O:1.52,F:1.47,CL:1.75,BR:1.85,I:1.98,HE:1.4,NE:1.54,AR:1.88,XE:2.16,KR:2.02,P:1.8,S:1.8,B:1.92,LI:1.82,NA:2.27,K:2.75,RB:3.03,CS:3.43,FR:3.48,BE:1.53,MG:1.73,SR:2.49,BA:2.68,RA:2.83,TI:2.11,FE:2.04,CU:1.96},Vi=function(t,e,n,r){var i=mt(),a=mt(),o=mt();e=Math.max(e,1),n=Math.min(r-1,n);var s=3*(e-1);bt(i,t[s],t[s+1],t[s+2]),bt(o,t[3*e],t[3*e+1],t[3*e+2]);for(var u=e;u<n;++u)bt(a,t[s=3*(u+1)],t[s+1],t[s+2]),t[3*u+0]=.25*a[0]+.5*o[0]+.25*i[0],t[3*u+1]=.25*a[1]+.5*o[1]+.25*i[1],t[3*u+2]=.25*a[2]+.5*o[2]+.25*i[2],yt(i,o),yt(o,a)},Ni=function(t,e,n,r){var i=re(0,0,0,1),a=r.atomCount(),o=n.idPool.getContinuousRange(a);t.addIdRange(o);var s=n.protoSphere.numVerts(),u=n.protoSphere.numIndices(),l=1.5*n.radiusMultiplier;t.addChainVertArray(r,s*a,u*a),r.eachAtom(function(r){var a=t.vertArrayWithSpaceFor(s);n.color.colorFor(r,i,0);var u=a.numVerts(),h=o.nextId({geom:t,atom:r});n.protoSphere.addTransformed(a,r.pos(),l,i,h);var c=a.numVerts();e.addAssoc(r,a,u,c)})},Li=function(t,e,n){console.time("spheres");var r=new di(n.sphereDetail,n.sphereDetail);n.protoSphere=r;var i=new Si(e,n.float32Allocator,n.uint16Allocator),a=new bi(t,!0);return i.addVertAssoc(a),i.setShowRelated(n.showRelated),n.color.begin(t),t.eachChain(function(t){Ni(i,a,n,t)}),n.color.end(t),console.timeEnd("spheres"),i},Bi=function(t,e,n,r){var i=re(0,0,0,1),a=r.atomCount(),o=n.idPool.getContinuousRange(a);t.addIdRange(o);var s=1.5*n.radiusMultiplier;t.addChainVertArray(r,4*a,6*a),r.eachAtom(function(r){var a=t.vertArrayWithSpaceFor(4);n.color.colorFor(r,i,0);var u=o.nextId({geom:t,atom:r}),l=a.numVerts(),h=r.pos();a.addVertex(h,[-1,-1,s],i,u),a.addVertex(h,[1,1,s],i,u),a.addVertex(h,[1,-1,s],i,u),a.addVertex(h,[-1,1,s],i,u),a.addTriangle(l+0,l+1,l+2),a.addTriangle(l+0,l+3,l+1);var c=a.numVerts();e.addAssoc(r,a,l,c)})},ji=function(t,e,n){console.time("billboardedSpheres");var r=new Ti(e,n.float32Allocator,n.uint16Allocator),i=new bi(t,!0);return r.addVertAssoc(i),r.setShowRelated(n.showRelated),n.color.begin(t),t.eachChain(function(t){Bi(r,i,n,t)}),n.color.end(t),console.timeEnd("billboardedSpheres"),r},zi=function(e,n,r,i){var a=mt(),o=mt(),s=re(0,0,0,1),u=mt(),l=mt(),h=t(),c=i.atomCount(),d=0;i.eachAtom(function(t){d+=t.bonds().length});var f=c*r.protoSphere.numVerts()+d*r.protoCyl.numVerts(),_=c*r.protoSphere.numIndices()+d*r.protoCyl.numIndices();e.addChainVertArray(i,f,_);var v=r.idPool.getContinuousRange(c);e.addIdRange(v),i.eachAtom(function(t){var i=r.scaleByAtomRadius?Ii[t.element()]||1:1,c=r.sphereRadius*i,d=r.protoSphere.numVerts()+t.bondCount()*r.protoCyl.numVerts(),f=e.vertArrayWithSpaceFor(d),_=f.numVerts(),m=v.nextId({geom:e,atom:t});r.color.colorFor(t,s,0),r.protoSphere.addTransformed(f,t.pos(),c,s,m),t.eachBond(function(e){e.mid_point(a),kt(o,t.pos(),a);var n=Pt(o);xt(o,o,1/n),hi(h,o,u,l,!1),At(a,a,t.pos()),xt(a,a,.5),r.protoCyl.addTransformed(f,a,n,r.cylRadius,h,s,s,m,m)});var g=f.numVerts();n.addAssoc(t,f,_,g)})},Ui=function(t,e,n){console.time("ballsAndSticks");var r=new bi(t,!0),i=new di(n.sphereDetail,n.sphereDetail),a=new _i(n.arcDetail);n.protoSphere=i,n.protoCyl=a;var o=new Si(e,n.float32Allocator,n.uint16Allocator);return o.addVertAssoc(r),o.setShowRelated(n.showRelated),n.color.begin(t),t.eachChain(function(t){zi(o,r,n,t)}),n.color.end(t),console.timeEnd("ballsAndSticks"),o},qi=function(t,e,n,r){var i=re(0,0,0,1),a=n.atomCount(),o=r.idPool.getContinuousRange(a);t.addIdRange(o);var s=t.addChainVertArray(n,a);s.setDrawAsPoints(!0),n.eachAtom(function(n){var a=s.numVerts();r.color.colorFor(n,i,0);var u=o.nextId({geom:t,atom:n});s.addPoint(n.pos(),i,u);var l=s.numVerts();e.addAssoc(n,s,a,l)})},Wi=function(t,e,n){console.time("points");var r=new bi(t,!0);n.color.begin(t);var i=new Ei(e,n.float32Allocator);return i.setPointSize(n.pointSize),i.addVertAssoc(r),i.setShowRelated(n.showRelated),t.eachChain(function(t){qi(i,r,t,n)}),n.color.end(t),console.timeEnd("points"),i},Hi=function(t,e,n,r){var i=mt(),a=re(0,0,0,1),o=0,s=n.atomCount(),u=r.idPool.getContinuousRange(s);t.addIdRange(u),n.eachAtom(function(t){var e=t.bonds().length;o+=e||3});var l=t.addChainVertArray(n,2*o);n.eachAtom(function(n){var o=l.numVerts(),s=u.nextId({geom:t,atom:n});if(n.bonds().length)n.eachBond(function(t){t.mid_point(i),r.color.colorFor(n,a,0),l.addLine(n.pos(),a,i,a,s,s)});else{var h=n.pos();r.color.colorFor(n,a,0),l.addLine([h[0]-.2,h[1],h[2]],a,[h[0]+.2,h[1],h[2]],a,s,s),l.addLine([h[0],h[1]-.2,h[2]],a,[h[0],h[1]+.2,h[2]],a,s,s),l.addLine([h[0],h[1],h[2]-.2],a,[h[0],h[1],h[2]+.2],a,s,s)}var c=l.numVerts();e.addAssoc(n,l,o,c)})},Gi=function(t,e,n){console.time("lines");var r=new bi(t,!0);n.color.begin(t);var i=new Ei(e,n.float32Allocator);return i.setLineWidth(n.lineWidth),i.addVertAssoc(r),i.setShowRelated(n.showRelated),t.eachChain(function(t){Hi(i,r,t,n)}),n.color.end(t),console.timeEnd("lines"),i},Xi=function(t){for(var e=0,n=0;n<t.length;++n)e+=2*(t[n].length()-1);return e},Yi=function(t,e,n,r,i,a){var o=re(0,0,0,1),s=re(0,0,0,1),u=mt(),l=mt();e.addAssoc(r,n,0,n.numVerts(),n.numVerts()+1);var h=a.float32Allocator.request(4*i.length()),c=a.idPool.getContinuousRange(i.length());t.addIdRange(c);for(var d,f=c.nextId({geom:t,atom:i.centralAtomAt(0),isTrace:!0}),_=1;_<i.length();++_){a.color.colorFor(i.centralAtomAt(_-1),o,0),h[4*(_-1)+0]=o[0],h[4*(_-1)+1]=o[1],h[4*(_-1)+2]=o[2],h[4*(_-1)+3]=o[3],a.color.colorFor(i.centralAtomAt(_),s,0),i.posAt(u,_-1),i.posAt(l,_),d=c.nextId({geom:t,atom:i.centralAtomAt(_),isTrace:!0}),n.addLine(u,o,l,s,f,d),f=d,d=null;var v=n.numVerts();e.addAssoc(r,n,_,v-1,v+(_===i.length()-1?0:1))}return h[4*i.length()-4]=s[0],h[4*i.length()-3]=s[1],h[4*i.length()-2]=s[2],h[4*i.length()-1]=s[3],e.setPerResidueColors(r,h),r+1},$i=function(t,e,n,r,i){for(var a=i.backboneTraces(),o=Xi(a),s=t.addChainVertArray(i,o),u=0;u<a.length;++u)r=Yi(t,e,s,r,a[u],n);return r},Zi=function(t,e,n){console.time("lineTrace");var r=new Ai(t,1,!0);n.color.begin(t);var i=new Ei(e,n.float32Allocator);i.setLineWidth(n.lineWidth);var a=0;return t.eachChain(function(t){a=$i(i,r,n,a,t)}),i.addVertAssoc(r),i.setShowRelated(n.showRelated),n.color.end(t),console.timeEnd("lineTrace"),i},Ki=function(t,e){for(var n=0,r=0;r<t.length;++r)n+=2*(e*(t[r].length()-1)+1);return n},Qi=function(t,e,n,r,i,a){var o,s=mt(),u=mt(),l=re(0,0,0,1),h=re(0,0,0,1),c=a.fullTraceIndex(0),d=r.float32Allocator.request(3*a.length()),f=r.float32Allocator.request(4*a.length()),_=[],v=r.idPool.getContinuousRange(a.length());for(t.addIdRange(v),o=0;o<a.length();++o){var m=a.centralAtomAt(o);a.smoothPosAt(s,o,r.strength),r.color.colorFor(m,f,4*o),d[3*o]=s[0],d[3*o+1]=s[1],d[3*o+2]=s[2],_.push(v.nextId({geom:t,atom:m,isTrace:!0}))}var g=_[0],p=0,y=si(d,a.length(),r.splineDetail,r.strength,!1,r.float32Allocator),b=$r(f,r.splineDetail),A=n.numVerts();e.addAssoc(i,n,c,A,A+1);var k=Math.floor(r.splineDetail/2),C=oi(a.length(),r.splineDetail,!1);for(o=1;o<C;++o){s[0]=y[3*(o-1)],s[1]=y[3*(o-1)+1],s[2]=y[3*(o-1)+2],u[0]=y[3*(o-0)],u[1]=y[3*(o-0)+1],u[2]=y[3*(o-0)+2],l[0]=b[4*(o-1)+0],l[1]=b[4*(o-1)+1],l[2]=b[4*(o-1)+2],l[3]=b[4*(o-1)+3],h[0]=b[4*(o-0)+0],h[1]=b[4*(o-0)+1],h[2]=b[4*(o-0)+2],h[3]=b[4*(o-0)+3];var w=Math.floor((o+k)/r.splineDetail);p=_[Math.min(_.length-1,w)],n.addLine(s,l,u,h,g,p),g=p;var R=n.numVerts();e.addAssoc(i,n,c+o,R-1,R+(o===a.length-1?0:1))}return e.setPerResidueColors(i,f),r.float32Allocator.release(d),r.float32Allocator.release(y),i+1},Ji=function(t,e,n,r,i){for(var a=r.backboneTraces(),o=Ki(a,n.splineDetail),s=t.addChainVertArray(r,o),u=0;u<a.length;++u)i=Qi(t,e,s,n,i,a[u]);return i},ta=function(t,e,n){console.time("sline"),n.color.begin(t);var r=new Ai(t,n.splineDetail,1,!0),i=new Ei(e,n.float32Allocator);i.addVertAssoc(r),i.setLineWidth(n.lineWidth),i.setShowRelated(n.showRelated);var a=0;return t.eachChain(function(t){a=Ji(i,r,n,t,a)}),n.color.end(t),console.timeEnd("sline"),i},ea=function(t,e,n){for(var r=0,i=0;i<t.length;++i)r+=t[i].length()*e,r+=(t[i].length()-1)*n;return r},na=function(t,e,n){for(var r=0,i=0;i<t.length;++i)r+=t[i].length()*e,r+=(t[i].length()-1)*n;return r},ra=function(t,e,n,r,i){var a=i.backboneTraces(),o=ea(a,n.protoSphere.numVerts(),n.protoCyl.numVerts()),s=na(a,n.protoSphere.numIndices(),n.protoCyl.numIndices());t.addChainVertArray(i,o,s);for(var u=0;u<a.length;++u)_a(t,e,a[u],r,n),r++;return r},ia=function(t,e,n){console.time("trace"),n.protoCyl=new _i(n.arcDetail),n.protoSphere=new di(n.sphereDetail,n.sphereDetail);var r=new Si(e,n.float32Allocator,n.uint16Allocator),i=new Ai(t,1,!0);r.addVertAssoc(i),r.setShowRelated(n.showRelated),n.color.begin(t);var a=0;return t.eachChain(function(t){a=ra(r,i,n,a,t)}),n.color.end(t),console.timeEnd("trace"),r},aa=function(t,e,n){for(var r=0,i=0;i<t.length;++i){var a=((t[i].length()-1)*n+1)*e;r+=a+(Math.ceil((a+2)/65536)-1)*e,r+=2}return r},oa=function(t,e,n){for(var r=0,i=0;i<t.length;++i)r+=(t[i].length()*n-1)*e*6,r+=6*e;return r},sa=function(e,n,r,i){for(var a=t(),o=mt(),s=mt(),u=mt(),l=mt(),h=ee(),c=1.8*i.radius,d=i.protoCyl.numVerts()+2*i.protoSphere.numVerts(),f=0;f<r.length;++f){var _=r[f],v=i.idPool.getContinuousRange(_.length());e.addIdRange(v);for(var m=0;m<_.length();++m){var g=e.vertArrayWithSpaceFor(d),p=g.numVerts(),y=_.residueAt(m),b=y.name(),A=y.atom("C3'"),k=null;if(null!==(k="A"===b||"G"===b||"DA"===b||"DG"===b?y.atom("N1"):y.atom("N3"))&&null!==A){var C=v.nextId({geom:e,atom:k,isTrace:!0});At(l,A.pos(),k.pos()),xt(l,l,.5),i.color.colorFor(k,h,0),kt(u,k.pos(),A.pos());var w=Pt(u);xt(u,u,1/w),hi(a,u,s,o,!1),i.protoCyl.addTransformed(g,l,w,c,a,h,h,C,C),i.protoSphere.addTransformed(g,k.pos(),c,h,C),i.protoSphere.addTransformed(g,A.pos(),c,h,C);var R=g.numVerts();console.assert(R<=65536,"too many vertices"),n.addAssoc(k,g,p,R)}}}},ua=function(t,e,n,r,i,a){for(var o=a.backboneTraces(),s=aa(o,4*r.arcDetail,r.splineDetail),u=oa(o,4*r.arcDetail,r.splineDetail),l=[],h=r.protoCyl.numVerts()+2*r.protoSphere.numVerts(),c=r.protoCyl.numIndices()+2*r.protoSphere.numIndices(),d=0;d<o.length;++d){var f=o[d];f.residueAt(0).isNucleotide()&&(l.push(f),s+=f.length()*h,u+=f.length()*c)}t.addChainVertArray(a,s,u);for(var _=0;_<o.length;++_)i=fa(t,e,o[_],i,r);return sa(t,n,l,r),i},la=function(t,e,n){console.time("cartoon"),n.arrowSkip=Math.floor(3*n.splineDetail/4),n.coilProfile=new fi(Oi,n.arcDetail,1),n.arrowProfile=new fi(Pi,n.arcDetail/2,.1),n.helixProfile=new fi(Di,n.arcDetail/2,.1),n.strandProfile=new fi(Di,n.arcDetail/2,.1),n.protoCyl=new _i(4*n.arcDetail),n.protoSphere=new di(4*n.arcDetail,4*n.arcDetail);var r=new Si(e,n.float32Allocator,n.uint16Allocator),i=new Ai(t,n.splineDetail,!0);r.addVertAssoc(i),r.setShowRelated(n.showRelated),n.color.begin(t);var a=0,o=t.select({anames:["N1","N3"]}),s=new bi(o,!0);return r.addVertAssoc(s),t.eachChain(function(t){a=ua(r,i,s,n,a,t)}),n.color.end(t),console.timeEnd("cartoon"),r},ha=function(t,e,n){var r=mt(),i=mt(),a=re(.8,.8,.8,1),o=0;t.getUint32(0),o+=4;var s=t.getUint32(o),u=24*s+(o+=4),l=t.getUint32(u),h=new Si(e,n.float32Allocator,n.uint16Allocator);h.setShowRelated("asym");var c,d=h.addVertArray(s,3*l);for(c=0;c<s;++c)bt(r,t.getFloat32(o+0),t.getFloat32(o+4),t.getFloat32(o+8)),o+=12,bt(i,t.getFloat32(o+0),t.getFloat32(o+4),t.getFloat32(o+8)),o+=12,d.addVertex(r,i,a,0);for(o=u+4,c=0;c<l;++c){var f=t.getUint32(o+0),_=t.getUint32(o+4),v=t.getUint32(o+8);o+=12,d.addTriangle(f-1,v-1,_-1)}return h},ca=function(e,n,r,i,a,o,s,u,l,h,c){var d=t(),f=mt(),_=l.coilProfile;"C"===i||l.forceTube?u?ri(r,a):jt(r,f,a):"H"===i?_=l.helixProfile:"E"===i?_=l.strandProfile:"A"===i&&(_=l.arrowProfile),hi(d,a,r,f,!0),_.addTransformed(e,n,s,d,o,u,h,c)},da=function(t,e,n,r,i,a,o,s){var u=mt(),l=mt(),h=mt(),c=null,d=null,f=e.length();bt(h,0,0,0);for(var _=0;_<f;++_){a.push(o.nextId({geom:t,atom:e.centralAtomAt(_),isTrace:!0})),e.smoothPosAt(u,_,s.strength),r[3*_]=u[0],r[3*_+1]=u[1],r[3*_+2]=u[2],e.smoothNormalAt(l,_,s.strength);var v=e.centralAtomAt(_);s.color.colorFor(v,n,4*_),Bt(l,h)<0&&xt(l,l,-1),"E"===e.residueAt(_).ss()&&!s.forceTube&&s.smoothStrands&&(null===c&&(c=_),d=_),"C"===e.residueAt(_).ss()&&null!==c&&(Vi(r,c,d,f),Vi(i,c,d,f),c=null,d=null),i[3*_]=r[3*_]+l[0]+h[0],i[3*_+1]=r[3*_+1]+l[1]+h[1],i[3*_+2]=r[3*_+2]+l[2]+h[2],yt(h,l)}},fa=function(t,e,n,r,i){var a=mt(),o=mt(),s=re(0,0,0,1),u=mt(),l=mt(),h=aa([n],4*i.arcDetail,i.splineDetail),c=i.float32Allocator.request(3*n.length()),d=i.float32Allocator.request(4*n.length()),f=i.float32Allocator.request(3*n.length()),_=[],v=i.idPool.getContinuousRange(n.length());t.addIdRange(v),da(t,n,d,c,f,_,v,i);var m=t.vertArrayWithSpaceFor(h),g=si(c,n.length(),i.splineDetail,i.strength,!1,i.float32Allocator),p=si(f,n.length(),i.splineDetail,i.strength,!1,i.float32Allocator);e.setPerResidueColors(r,d);var y=i.radius*(n.residueAt(0).isAminoacid()?1:1.8),b=$r(d,i.splineDetail);bt(a,g[3]-g[0],g[4]-g[1],g[5]-g[2]),bt(o,g[0],g[1],g[2]),bt(u,p[0]-g[0],p[1]-g[1],p[2]-g[2]),Lt(a,a),Lt(u,u),ae(s,b[0],b[1],b[2],b[3]);var A=m.numVerts();m.addVertex(o,[-a[0],-a[1],-a[2]],s,_[0]);var k=n.residueAt(0).ss();ca(m,o,u,k,a,s,y,!0,i,0,_[0]),ln(m,A,4*i.arcDetail);var C=m.numVerts(),w=0;e.addAssoc(r,m,w,A,C),w+=1;for(var R=Math.floor(i.splineDetail/2),M=oi(n.length(),i.splineDetail,!1),S=4*i.arcDetail,T=1,E=M;T<E;++T){var x=3*T,F=4*T,O=3*(T+1),D=3*(T-1);bt(o,g[x],g[x+1],g[x+2]),T===E-1?bt(a,g[x]-g[D],g[x+1]-g[D+1],g[x+2]-g[D+2]):bt(a,g[O]-g[D],g[O+1]-g[D+1],g[O+2]-g[D+2]),Lt(a,a),ae(s,b[F],b[F+1],b[F+2],b[F+3]);var P=0,I=T+i.splineDetail/2,V=Math.floor(I/i.splineDetail),N=Math.floor((I-1)/i.splineDetail),L=Math.floor((I+i.arrowSkip)/i.splineDetail),B=!1,j=n.residueAt(V).ss();if(!i.forceTube){if(V!==N&&"C"===n.residueAt(N).ss()&&("H"===j||"E"===j)){bt(l,p[D]-g[D],p[D+1]-g[D+1],p[D+2]-g[D+2]),Lt(l,l);var z=2*Math.PI/(4*i.arcDetail),U=ni(u,l,a);P=((P=Math.round(U/z))+4*i.arcDetail)%(4*i.arcDetail)}L!==V&&L<n.length()&&"C"===n.residueAt(L).ss()&&"E"===j&&(B=!0)}bt(u,p[3*T]-g[x],p[x+1]-g[x+1],p[x+2]-g[x+2]),Lt(u,u),A=m.numVerts();var q=Math.floor((T+R)/i.splineDetail),W=_[Math.min(_.length-1,q)];ca(m,o,u,j,a,s,y,!1,i,P,W);var H=T===E-1?1:S;m.numVerts()+H>m.maxVerts()&&(C=m.numVerts(),e.addAssoc(r,m,w,A,C),m=t.vertArrayWithSpaceFor(H),A=0,ca(m,o,u,j,a,s,y,!0,i,0,W)),B&&(e.addAssoc(r,m,w,A,C),ca(m,o,u,"A",a,s,y,!1,i,0,W),T+=i.arrowSkip),C=m.numVerts(),T===E-1&&(C+=1),e.addAssoc(r,m,w,A,C),w+=1,B&&(w+=i.arrowSkip)}return m.addVertex(o,a,s,_[_.length-1]),hn(m,A,4*i.arcDetail),i.float32Allocator.release(f),i.float32Allocator.release(c),r+1},_a=function(e,n,r,i,a){if(0!==r.length()){var o=t(),s=mt(),u=mt(),l=mt(),h=mt(),c=mt(),d=mt(),f=re(0,0,0,1),_=re(0,0,0,1),v=a.idPool.getContinuousRange(r.length());e.addIdRange(v),a.color.colorFor(r.centralAtomAt(0),f,0);var m=ea([r],a.protoSphere.numVerts(),a.protoCyl.numVerts()),g=m,p=e.vertArrayWithSpaceFor(m),y=p.maxVerts(),b=p.numVerts();r.posAt(c,0);var A=v.nextId({geom:e,atom:r.centralAtomAt(0),isTrace:!0}),k=0;a.protoSphere.addTransformed(p,c,a.radius,f,A);var C=null;n.addAssoc(i,p,0,b,C);var w=a.float32Allocator.request(4*r.length());w[0]=f[0],w[1]=f[1],w[2]=f[2],w[3]=f[3];for(var R=a.protoCyl.numVerts()+a.protoSphere.numVerts(),M=1;M<r.length();++M){k=v.nextId({geom:e,atom:r.centralAtomAt(M),isTrace:!0}),r.posAt(c,M-1),r.posAt(d,M),a.color.colorFor(r.centralAtomAt(M),_,0),w[4*M+0]=_[0],w[4*M+1]=_[1],w[4*M+2]=_[2],w[4*M+3]=_[3],kt(s,d,c);var S=Pt(s);xt(s,s,1/S),hi(o,s,u,l,!1),yt(h,c),At(h,h,d),xt(h,h,.5),R>y-p.numVerts()&&(p=e.vertArrayWithSpaceFor(g)),g-=R;var T=p.numVerts();a.protoCyl.addTransformed(p,h,S,a.radius,o,f,_,A,k),C=p.numVerts(),C-=(C-T)/2,a.protoSphere.addTransformed(p,d,a.radius,_,k),A=k,n.addAssoc(i,p,M,b,C),b=C,yt(f,_)}n.setPerResidueColors(i,w),n.addAssoc(i,p,r.length()-1,b,p.numVerts())}},va="\nprecision ${PRECISION} float;\nuniform bool screenDoorTransparency;\n\nvec4 handleAlpha(vec4 inColor) {\n  if (screenDoorTransparency) {\n    ivec2 pxCoord = ivec2(gl_FragCoord.xy);\n    ivec2 mod = pxCoord - (pxCoord/2) * 2;\n\n    if (inColor.a < 0.99 && (inColor.a < 0.01 || mod.x != 0 || mod.y != 0)) {\n      discard;\n    }\n\n    return vec4(inColor.rgb, 1.0);\n  } else {\n    if (inColor.a == 0.0) {\n      discard;\n    }\n\n    return inColor;\n  }\n}\n\nint intMod(int x, int y) {\n  int z = x/y;\n  return x-y*z;\n}\n\nuniform vec4 selectionColor;\n\nvec3 handleSelect(vec3 inColor, float vertSelect) {\n  return mix(inColor, selectionColor.rgb, step(0.5, vertSelect) * selectionColor.a);\n}\n\nuniform bool fog;\nuniform float fogNear;\nuniform float fogFar;\nuniform vec3 fogColor;\n\nvec3 handleFog(vec3 inColor) {\n  if (fog) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = smoothstep(fogNear, fogFar, depth);\n\n    return mix(inColor, fogColor, fogFactor);\n  } else {\n    return inColor;\n  }\n}",ma="\nattribute vec3 attrPos;\nattribute vec4 attrColor;\nattribute vec3 attrNormal;\nattribute float attrSelect;\n\nuniform mat4 projectionMat;\nuniform mat4 modelviewMat;\nvarying vec4 vertColor;\nvarying vec3 vertNormal;\nvarying vec3 vertPos;\nvarying float vertSelect;\nvoid main(void) {\n  vertPos = (modelviewMat * vec4(attrPos, 1.0)).xyz;\n  gl_Position = projectionMat * modelviewMat * vec4(attrPos, 1.0);\n  vec4 n = (modelviewMat * vec4(attrNormal, 0.0));\n  vertNormal = n.xyz;\n  vertColor = attrColor;\n  vertSelect = attrSelect;\n}",ga=function(){function t(e,n,r){mr(this,t),this._from=e,this._to=n,this._duration=r,this._left=r,this._start=Date.now(),this._looping=!1,this._finished=!1}return gr(t,[{key:"setLooping",value:function(t){this._looping=t}},{key:"step",value:function(t){var e,n=Date.now()-this._start;return 0===this._duration?e=1:this._looping?e=(n-Math.floor(n/this._duration)*this._duration)/this._duration:(e=(n=Math.min(this._duration,n))/this._duration,this._finished=1===e),this.apply(t,e),this._finished}},{key:"apply",value:function(t,e){var n=(1-Math.cos(e*Math.PI))/2;this._current=this._from*(1-n)+this._to*n,t.setZoom(this._current)}},{key:"finished",value:function(){return this._finished}}]),t}(),pa=function(t){function e(t,n,r){mr(this,e);var i=br(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,r));return i._current=gt(t),i}return yr(e,t),gr(e,[{key:"apply",value:function(t,e){var n=(1-Math.cos(e*Math.PI))/2;zt(this._current,this._from,this._to,n),t.setCenter(this._current)}}]),e}(ga),ya=function(n){function r(n,i,a){mr(this,r);var o=br(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,n,i,a)),s=t(),u=t();e(s,n),e(u,i);var l=Oe(),h=Oe();return Xe(l,s),Xe(h,u),o._current=t(),ga.call(o,l,h,a),o}return yr(r,n),gr(r,[{key:"apply",value:function(t,e){var n=Oe();qe(n,this._from,this._to,e),y(this._current,n),t.setRotation(this._current)}}]),r}(ga),ba=function(n){function r(t,e){mr(this,r);var n=br(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,null,null,e));return n._axis=gt(t),n.setLooping(!0),n._previousAngle=0,n}return yr(r,n),gr(r,[{key:"apply",value:function(n,r){var i=t(),a=t();e(a,n.rotation());var o=.2*Math.sin(2*r*Math.PI),s=o-this._previousAngle;this._previousAngle=o,ii(i,this._axis,s),c(a,i,a),n.setRotation(a)}}]),r}(ga),Aa=function(n){function r(t,e){mr(this,r);var n=2*Math.PI/e*1e3,i=br(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,null,null,n));return i._axis=gt(t),i.setLooping(!0),i._speed=e,i._previousT=0,i}return yr(r,n),gr(r,[{key:"apply",value:function(n,r){var i=t(),a=t();e(a,n.rotation());var o=2*Math.PI*(r-this._previousT);this._previousT=r,ii(i,this._axis,o),c(a,i,a),n.setRotation(a)}},{key:"setSpeed",value:function(t){this._speed=t,this._duration=2*Math.PI/t*1e3}},{key:"setAxis",value:function(t){this._axis=t}}]),r}(ga),ka=function(){function t(){mr(this,t),this._animations=[]}return gr(t,[{key:"run",value:function(t){var e=Date.now();return this._animations=this._animations.filter(function(n){return!n.step(t,e)}),this._animations.length>0}},{key:"add",value:function(t){this._animations.push(t)}},{key:"remove",value:function(t){this._animations=this._animations.filter(function(e){return e!==t})}}]),t}(),Ca=function(t,e,n){if(0===t.length)return-1;n=n||mn;for(var r=0,i=t.length,a=r+i>>1;;){var o=t[a];if(n(e,o))i=a;else{if(!n(o,e))return a;r=a}var s=r+i>>1;if(s===a)return-1;a=s}},wa=function(t,e,n){if(n=n||mn,0===t.length||n(t[t.length-1],e))return-1;for(var r=0,i=t.length,a=r+i>>1;;){var o=t[a];n(e,o)?i=a:n(o,e)?r=a+1:i=a;var s=r+i>>1;if(s===a)return a;a=s}},Ra=function(t,e,n){if(n=n||mn,0===t.length||n(t[t.length-1],e))return t.length-1;if(n(e,t[0]))return-1;for(var r=0,i=t.length,a=r+i>>1;;){n(e,t[a])?i=a:r=a;var o=r+i>>1;if(o===a)return a;a=o}},Ma=function(){function t(e,n){mr(this,t),void 0===e||void 0===n?(this._empty=!0,this._min=this._max=null):(this._empty=!1,this._min=e,this._max=n)}return gr(t,[{key:"min",value:function(){return this._min}},{key:"max",value:function(){return this._max}},{key:"length",value:function(){return this._max-this._min}},{key:"empty",value:function(){return this._empty}},{key:"center",value:function(){return.5*(this._max+this._min)}},{key:"extend",value:function(t){this._min-=t,this._max+=t}},{key:"update",value:function(t){this._empty?(this._min=this._max=t,this._empty=!1):t<this._min?this._min=t:t>this._max&&(this._max=t)}}]),t}(),Sa=function(){function t(e,n,r,i,a,o,s){mr(this,t),this._pos=i,this._target=e,this._node=n,this._symIndex=r,this._legacyObject=a,this._legacyTransform=o,this._connectivity=s}return gr(t,[{key:"symIndex",value:function(){return this._symIndex}},{key:"target",value:function(){return this._target}},{key:"pos",value:function(){return this._pos}},{key:"connectivity",value:function(){return this._connectivity}},{key:"node",value:function(){return this._node}}]),t}(),Ta=function(){function e(t,n){mr(this,e),this._options=this._initOptions(n,t),this._initialized=!1,this._objects=[],this._domElement=t,this._redrawRequested=!1,this._resize=!1,this._lastTimestamp=null,this._objectIdManager=new Rr,this._spin=null,this._rockAndRoll=null,this.listenerMap={},this._animControl=new ka,this._initKeyboardInput(),this._initCanvas(),this.quality(this._options.quality),null!==this._options.click&&this.on("click",this._options.click),null!==this._options.doubleClick&&this.on("doubleClick",this._options.doubleClick),-1!==["complete","loaded","interactive"].indexOf(document.readyState)?this._initViewer():document.addEventListener("DOMContentLoaded",this._initViewer.bind(this))}return gr(e,[{key:"_initOptions",value:function(t,e){t=t||{},this._extensions=t.extensions||[],this._extensions.forEach(function(e){null!==e.optionOverrides&&Object.assign(t,e.optionOverrides())});var n={width:t.width||500,height:t.height||500,animateTime:t.animateTime||0,antialias:t.antialias,forceManualAntialiasing:An(t,"forceManualAntialiasing",!0),quality:An(t,"quality","low"),style:An(t,"style","hemilight"),background:Dr(t.background||"white"),slabMode:bn(t.slabMode),outline:An(t,"outline",!0),outlineColor:Dr(An(t,"outlineColor","black")),outlineWidth:An(t,"outlineWidth",1.5),selectionColor:Dr(An(t,"selectionColor","#3f3"),.7),fov:An(t,"fov",45),doubleClick:t.doubleClick||"center",click:t.click,fog:An(t,"fog",!0),transparency:An(t,"transparency","alpha")},r=e.getBoundingClientRect();return"auto"===n.width&&(n.width=r.width),"auto"===n.height&&(n.height=r.height),n}},{key:"_ensureSize",value:function(){this._resize&&(this._resize=!1,this._cam.setViewportSize(this._canvas.viewportWidth(),this._canvas.viewportHeight()),this._pickBuffer.resize(this._options.width,this._options.height))}},{key:"resize",value:function(t,e){t===this._options.width&&e===this._options.height||(this._canvas.resize(t,e),this._resize=!0,this._options.width=t,this._options.height=e,this.requestRedraw())}},{key:"fitParent",value:function(){var t=this._domElement.getBoundingClientRect();this.resize(t.width,t.height)}},{key:"gl",value:function(){return this._canvas.gl()}},{key:"ok",value:function(){return this._initialized}},{key:"options",value:function(t,e){if(void 0!==e)if(this._options[t]=e,"fog"===t)this._cam.fog(e),this.requestRedraw();else if("fov"===t)this._cam.setFieldOfViewY(e*Math.PI/180);else if("selectionColor"===t)this._cam.setSelectionColor(Dr(e,.7));else if("outlineColor"===t)this._cam.setOutlineColorColor(Dr(e));else if("outlineWidth"===t)this._cam.setOutlineWidth(e+0);else if("transparency"===t){var n="screendoor"===e;this._cam.setScreenDoorTransparency(n)}return this._options[t]}},{key:"quality",value:function(t){return void 0===t?this._options.quality:(this._options.quality=t,"high"===t&&(this._options.arcDetail=4,this._options.sphereDetail=16,this._options.splineDetail=8),"medium"===t&&(this._options.arcDetail=2,this._options.sphereDetail=10,this._options.splineDetail=5),"low"===t&&(this._options.arcDetail=2,this._options.sphereDetail=8,this._options.splineDetail=3),this._options.quality)}},{key:"imageData",value:function(){return this._canvas.imageData()}},{key:"_initPickBuffer",value:function(){var t={width:this._options.width,height:this._options.height};this._pickBuffer=new Mr(this._canvas.gl(),t)}},{key:"_initViewer",value:function(){if(!this._canvas.initGL())return this._domElement.removeChild(this._canvas.domElement()),this._domElement.innerHTML='<div style="vertical-align:middle; text-align:center;">\n<h1>WebGL not supported</h1><p>Your browser does not support WebGL.\nYou might want to try Chrome, Firefox, IE 11, or newer versions of Safari\n</p>\n<p>If you are using a recent version of one of the above browsers, your\ngraphic card might be blocked. Check the browser documentation for details\non how to unblock it.\n</p>\n</div>',this._domElement.style.width=this._options.width+"px",this._domElement.style.height=this._options.height+"px",!1;this._initPickBuffer(),this._2dcontext=this._textureCanvas.getContext("2d"),this._float32Allocator=new Sr(Float32Array),this._uint16Allocator=new Sr(Uint16Array),this._cam=new Kr(this._canvas.gl()),this._cam.setUpsamplingFactor(this._canvas.superSamplingFactor()),this._cam.setOutlineWidth(this._options.outlineWidth),this._cam.setOutlineEnabled(this._options.outline);var t="screendoor"===this._options.transparency;this._cam.setScreenDoorTransparency(t),this._cam.fog(this._options.fog),this._cam.setFogColor(this._options.background),this._cam.setOutlineColor(this._options.outlineColor),this._cam.setSelectionColor(this._options.selectionColor),this._cam.setFieldOfViewY(this._options.fov*Math.PI/180),this._mouseHandler.setCam(this._cam);var e=this._canvas,n=yn(e.gl())?"highp":"mediump";this._shaderCatalog={hemilight:e.initShader(ma,va+"\nvarying vec4 vertColor;\nvarying vec3 vertNormal;\nvarying float vertSelect;\n\nvoid main(void) {\n  float dp = dot(vertNormal, vec3(0.0, 0.0, 1.0));\n  float hemi = min(1.0, max(0.0, dp)*0.6+0.5);\n  gl_FragColor = vec4(vertColor.rgb*hemi, vertColor.a);\n  gl_FragColor.rgb = handleFog(handleSelect(gl_FragColor.rgb, vertSelect));\n  gl_FragColor = handleAlpha(gl_FragColor);\n}",n),phong:e.initShader(ma,va+"\nvarying vec4 vertColor;\nvarying vec3 vertNormal;\nvarying vec3 vertPos;\nuniform float zoom;\nvarying float vertSelect;\n\nvoid main(void) {\n  vec3 eyePos = vec3(0.0, 0.0, zoom);\n  float dp = dot(vertNormal, normalize(eyePos - vertPos));\n  float hemi = min(1.0, max(0.3, dp)+0.2);\n  //hemi *= vertColor.a;\n  vec3 rgbColor = vertColor.rgb * hemi;\n  //gl_FragDepthEXT = gl_FragCoord.z;\n  rgbColor += min(vertColor.rgb, 0.8) * pow(max(0.0, dp), 18.0);\n  rgbColor = handleSelect(rgbColor, vertSelect);\n  gl_FragColor = vec4(clamp(rgbColor, 0.0, 1.0), vertColor.a);\n  gl_FragColor.rgb = handleFog(gl_FragColor.rgb);\n  gl_FragColor = handleAlpha(gl_FragColor);\n}",n),outline:e.initShader("\nprecision ${PRECISION} float;\n\nattribute vec3 attrPos;\nattribute vec3 attrNormal;\nattribute vec4 attrColor;\nattribute float attrSelect;\n\nuniform vec3 outlineColor;\nuniform mat4 projectionMat;\nuniform mat4 modelviewMat;\nvarying float vertAlpha;\nvarying float vertSelect;\nuniform vec2 relativePixelSize;\nuniform float outlineWidth;\nuniform float outlineOffset;\n\nvoid main(void) {\n  gl_Position = projectionMat * modelviewMat * vec4(attrPos, 1.0);\n  vec4 normal = modelviewMat * vec4(attrNormal, 0.0);\n  vertAlpha = attrColor.a;\n  vertSelect = attrSelect;\n  vec2 expansion = relativePixelSize *\n       (outlineWidth + 2.0 * step(0.5, attrSelect));\n  vec2 offset = normal.xy * expansion;\n  gl_Position.xy += gl_Position.w * offset;\n  gl_Position.z += gl_Position.w * outlineOffset;\n}",va+"\nvarying float vertAlpha;\nvarying float vertSelect;\n\nuniform vec3 outlineColor;\n\nvoid main() {\n  gl_FragColor = vec4(mix(outlineColor, selectionColor.rgb,\n                          step(0.5, vertSelect)),\n                      vertAlpha);\n  gl_FragColor.rgb = handleFog(gl_FragColor.rgb);\n  gl_FragColor = handleAlpha(gl_FragColor);\n}",n),lines:e.initShader("\nattribute vec3 attrPos;\nattribute vec4 attrColor;\n\nuniform mat4 projectionMat;\nuniform mat4 modelviewMat;\nvarying vec4 vertColor;\nuniform float pointSize;\nvoid main(void) {\n  gl_Position = projectionMat * modelviewMat * vec4(attrPos, 1.0);\n  float distToCamera = vec4(modelviewMat * vec4(attrPos, 1.0)).z;\n  gl_PointSize = pointSize * 200.0 / abs(distToCamera);\n  vertColor = attrColor;\n}",va+"\nvarying vec4 vertColor;\nvarying vec3 vertNormal;\n\nvoid main(void) {\n  gl_FragColor = handleAlpha(vertColor);\n  gl_FragColor.rgb = handleFog(gl_FragColor.rgb);\n}",n),text:e.initShader("\nprecision ${PRECISION} float;\n\nattribute vec3 attrCenter;\nattribute vec2 attrCorner;\nuniform mat4 projectionMat;\nuniform mat4 modelviewMat;\nuniform mat4 rotationMat;\nvarying vec2 vertTex;\nuniform float width;\nuniform float height;\nvoid main() {\n  vec4 pos = modelviewMat* vec4(attrCenter, 1.0);\n  pos.z += 4.0;\n  gl_Position = projectionMat * pos;\n  gl_Position.xy += vec2(width,height)*attrCorner*gl_Position.w;\n  vertTex = (attrCorner+abs(attrCorner))/(2.0*abs(attrCorner));\n}","\nprecision ${PRECISION} float;\n\nuniform mat4 projectionMat;\nuniform mat4 modelviewMat;\nuniform sampler2D sampler;\nuniform float xScale;\nuniform float yScale;\nvarying vec2 vertTex;\nvoid main() {\n  vec2 texCoord = vec2(vertTex.x*xScale, vertTex.y*yScale);\n  gl_FragColor = texture2D(sampler, texCoord);\n  if (gl_FragColor.a == 0.0) { discard; }\n}",n),selectLines:e.initShader("\nattribute vec3 attrPos;\nattribute float attrSelect;\n\nuniform mat4 projectionMat;\nuniform mat4 modelviewMat;\nuniform float pointSize;\nvarying float vertSelect;\nvoid main(void) {\n  gl_Position = projectionMat * modelviewMat * vec4(attrPos, 1.0);\n  gl_Position.z += gl_Position.w * 0.000001;\n  float distToCamera = vec4(modelviewMat * vec4(attrPos, 1.0)).z;\n  gl_PointSize = pointSize * 200.0 / abs(distToCamera);\n  vertSelect = attrSelect;\n}","\nprecision ${PRECISION} float;\n\nvarying float vertSelect;\nvarying vec3 vertNormal;\nuniform float fogNear;\nuniform float fogFar;\nuniform vec3 fogColor;\nuniform bool fog;\nuniform vec4 selectionColor;\n\nvoid main(void) {\n  gl_FragColor = mix(vec4(0.0, 0.0, 0.0, 0.0),\n                     vec4(selectionColor.rgb, 1.0), vertSelect);\n  gl_FragColor.a = step(0.5, vertSelect);\n  if (gl_FragColor.a == 0.0) { discard; }\n  float depth = gl_FragCoord.z / gl_FragCoord.w;\n  if (fog) {\n    float fog_factor = smoothstep(fogNear, fogFar, depth);\n    gl_FragColor = mix(gl_FragColor, vec4(fogColor, gl_FragColor.w),\n                        fog_factor);\n  }\n}",n),select:e.initShader("\nprecision ${PRECISION} float;\nuniform mat4 projectionMat;\nuniform mat4 modelviewMat;\nuniform float pointSize;\nattribute vec3 attrPos;\nattribute float attrObjId;\nattribute vec4 attrColor;\n\nvarying float objId;\nvarying float objAlpha;\n\nvoid main(void) {\n  gl_Position = projectionMat * modelviewMat * vec4(attrPos, 1.0);\n  float distToCamera = vec4(modelviewMat * vec4(attrPos, 1.0)).z;\n  gl_PointSize = pointSize * 200.0 / abs(distToCamera);\n  objId = attrObjId;\n  objAlpha = attrColor.a;\n}","\nprecision ${PRECISION} float;\n\nvarying float objId;\nvarying float objAlpha;\nuniform int symId;\n\nint intMod(int x, int y) {\n  int z = x/y;\n  return x-y*z;\n}\nvoid main(void) {\n  if (objAlpha == 0.0) { discard; }\n  // ints are only required to be 7bit...\n  int integralObjId = int(objId+0.5);\n  int red = intMod(integralObjId, 256);\n  integralObjId/=256;\n  int green = intMod(integralObjId, 256);\n  integralObjId/=256;\n  int blue = intMod(integralObjId, 256);\n  int alpha = symId;\n  gl_FragColor = vec4(float(red), float(green),\n                      float(blue), float(alpha))/255.0;\n}",n)},e.gl().getExtension("EXT_frag_depth")&&(this._shaderCatalog.spheres=e.initShader("\nprecision ${PRECISION} float;\nattribute vec3 attrPos;\nattribute vec4 attrColor;\nattribute vec3 attrNormal;\nattribute float attrSelect;\nuniform vec2 relativePixelSize;\nuniform float outlineWidth;\nvarying float radius;\n\nuniform mat4 projectionMat;\nuniform mat4 modelviewMat;\nuniform mat4 rotationMat;\nvarying vec4 vertColor;\nvarying vec2 vertTex;\nvarying float border;\nvarying vec4 vertCenter;\nvarying float vertSelect;\nvoid main() {\n  vec3 d = vec3(attrNormal.xy * attrNormal.z, 0.0);\n  vec4 rotated = vec4(d, 0.0)*rotationMat;\n  gl_Position = projectionMat * modelviewMat *\n                (vec4(attrPos, 1.0)+rotated);\n  vertTex = attrNormal.xy;\n  vertColor = attrColor;\n  vertSelect = attrSelect;\n  vertCenter = modelviewMat* vec4(attrPos, 1.0);\n  float dist = length((projectionMat * vertCenter).xy - gl_Position.xy);\n  float dd = dist / gl_Position.w;\n  border = 1.0 - outlineWidth * 1.4 * length(relativePixelSize)/dd;\n  radius = attrNormal.z;\n}",va+"\n#extension GL_EXT_frag_depth: enable\n\nvarying vec2 vertTex;\nvarying vec4 vertCenter;\nvarying vec4 vertColor;\nvarying float vertSelect;\nvarying float radius;\nuniform mat4 projectionMat;\nuniform vec3 outlineColor;\nvarying float border;\nuniform bool outlineEnabled;\n\nvoid main(void) {\n  float zz = dot(vertTex, vertTex);\n  if (zz > 1.0)\n    discard;\n  vec3 normal = vec3(vertTex.x, vertTex.y, sqrt(1.0-zz));\n  vec3 pos = vertCenter.xyz + normal * radius;\n  float dp = normal.z;\n  float hemi = sqrt(min(1.0, max(0.3, dp) + 0.2));\n  vec4 projected = projectionMat * vec4(pos, 1.0);\n  float depth = projected.z / projected.w;\n  gl_FragDepthEXT = (depth + 1.0) * 0.5;\n  vec3 rgbColor = vertColor.rgb * hemi;\n  rgbColor += min(vertColor.rgb, 0.8) * pow(max(0.0, dp), 18.0);\n  if (outlineEnabled) {\n    rgbColor = mix(rgbColor * hemi, outlineColor, step(border, sqrt(zz)));\n  } else {\n    rgbColor *= hemi;\n  }\n  rgbColor = handleSelect(rgbColor, vertSelect);\n  vec4 fogged = vec4(handleFog(rgbColor), vertColor.a);\n  gl_FragColor = handleAlpha(fogged);\n}",n),this._shaderCatalog.selectSpheres=e.initShader("\nprecision ${PRECISION} float;\nattribute vec3 attrPos;\nattribute vec4 attrColor;\nattribute vec3 attrNormal;\nattribute float attrObjId;\nvarying float radius;\n\nuniform mat4 projectionMat;\nuniform mat4 modelviewMat;\nuniform mat4 rotationMat;\nvarying vec2 vertTex;\nvarying vec4 vertCenter;\nvarying float objId;\nvoid main() {\n  vec3 d = vec3(attrNormal.xy * attrNormal.z, 0.0);\n  vec4 rotated = vec4(d, 0.0)*rotationMat;\n  //vec4 rotated = vec4(d, 0.0);\n  gl_Position = projectionMat * modelviewMat *\n                (vec4(attrPos, 1.0)+rotated);\n  vertTex = attrNormal.xy;\n  vertCenter = modelviewMat* vec4(attrPos, 1.0);\n  radius = attrNormal.z;\n  objId = attrObjId;\n}",va+"\n#extension GL_EXT_frag_depth: enable\n\nvarying vec2 vertTex;\nvarying vec4 vertCenter;\nvarying vec4 vertColor;\nuniform mat4 projectionMat;\nvarying float objId;\nvarying float radius;\nuniform int symId;\n\nvoid main(void) {\n  float zz = dot(vertTex, vertTex);\n  if (zz > 1.0)\n    discard;\n  vec3 normal = vec3(vertTex.x, vertTex.y, sqrt(1.0-zz));\n  vec3 pos = vertCenter.xyz + normal * radius;\n  vec4 projected = projectionMat * vec4(pos, 1.0);\n  float depth = projected.z / projected.w;\n  gl_FragDepthEXT = (depth + 1.0) * 0.5;\n  // ints are only required to be 7bit...\n  int integralObjId = int(objId+0.5);\n  int red = intMod(integralObjId, 256);\n  integralObjId/=256;\n  int green = intMod(integralObjId, 256);\n  integralObjId/=256;\n  int blue = intMod(integralObjId, 256);\n  int alpha = symId;\n  gl_FragColor = vec4(float(red), float(green),\n                      float(blue), float(alpha))/255.0;\n}",n)),this._boundDraw=this._draw.bind(this),this._touchHandler=new Qr(this._canvas.domElement(),this,this._cam);var r=e.gl(),i=0;r.getParameter(r.DEPTH_BITS)>=24&&(i=1e-5);var a=this._shaderCatalog.outline;r.useProgram(a),r.uniform1f(r.getUniformLocation(a,"outlineOffset"),i);var o=this;return this._extensions.forEach(function(t){t.init(o)}),this._initialized||(this._initialized=!0,this._dispatchEvent({name:"viewerReadyEvent"},"viewerReady",this)),!0}},{key:"requestRedraw",value:function(){this._redrawRequested||(this._redrawRequested=!0,requestAnimationFrame(this._boundDraw))}},{key:"boundingClientRect",value:function(){return this._canvas.domElement().getBoundingClientRect()}},{key:"_drawWithPass",value:function(t){for(var e=0,n=this._objects.length;e!==n;++e)this._objects[e].draw(this._cam,this._shaderCatalog,this._options.style,t)}},{key:"_initKeyboardInput",value:function(){if(gn()||pn())this._keyInput=document;else{var t=document.createElement("div");t.setAttribute("style","overflow:hidden;width:0;height:0"),this._keyInput=document.createElement("textarea"),this._domElement.appendChild(t),t.appendChild(this._keyInput),this._keyInput.focus()}}},{key:"focus",value:function(){this._keyInput!==document&&this._keyInput.focus()}},{key:"_initCanvas",value:function(){var t={antialias:this._options.antialias,forceManualAntialiasing:this._options.forceManualAntialiasing,height:this._options.height,width:this._options.width,backgroundColor:this._options.background};this._canvas=new ti(this._domElement,t),this._textureCanvas=document.createElement("canvas"),this._textureCanvas.style.display="none",this._domElement.appendChild(this._textureCanvas),this._mouseHandler=new Jr(this._canvas,this,this._cam,this._options.animateTime),this._canvas.domElement().addEventListener("mousedown",this.focus.bind(this))}},{key:"translate",value:function(t,e){var n=mt(),r=T();if(e|=0,P(r,this._cam.rotation()),Ht(n,t,r),kt(n,this._cam.center(),n),0===e)return this._cam.setCenter(n),void this.requestRedraw();this._animControl.add(cn(this._cam.center(),gt(n),e)),this.requestRedraw()}},{key:"rotate",value:function(e,n,r){var i=mt(),a=t(),o=T();if(r|=0,Lt(i,e),ii(a,i,n),(void 0)(o,a),L(o,o,this._cam.rotation()),0===r)return this._cam.setRotation(o),void this.requestRedraw();this._animControl.add(dn(this._cam.rotation(),o,r)),this.requestRedraw()}},{key:"setRotation",value:function(t,e){if(0===(e|=0))return this._cam.setRotation(t),void this.requestRedraw();var n;9===t.length?(void 0)(n=T(),t):n=E(t),this._animControl.add(dn(this._cam.rotation(),n,e)),this.requestRedraw()}},{key:"setCamera",value:function(t,e,n,r){r|=0,this.setCenter(e,r),this.setRotation(t,r),this.setZoom(n,r)}},{key:"_animateCam",value:function(){this._animControl.run(this._cam)&&this.requestRedraw()}},{key:"_draw",value:function(){if(null!==this._canvas){this._redrawRequested=!1,this._animateCam(),this._canvas.bind(),this._ensureSize();var t=this._canvas.gl();t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT);var e=this._options.slabMode.update(this._objects,this._cam);null!==e&&this._cam.setNearFar(e.near,e.far),t.enable(t.CULL_FACE),this._options.outline&&(t.cullFace(t.BACK),t.enable(t.CULL_FACE),this._drawWithPass("outline")),t.cullFace(t.FRONT),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this._drawWithPass("normal")}}},{key:"setCenter",value:function(t,e){0!==(e|=0)?(this._animControl.add(cn(this._cam.center(),gt(t),e)),this.requestRedraw()):this._cam.setCenter(t)}},{key:"zoom",value:function(){return this._cam.zoom()}},{key:"setZoom",value:function(t,e){0!==(e|=0)?(this._animControl.add(fn(this._cam.zoom(),t,e)),this.requestRedraw()):this._cam.setZoom(t)}},{key:"centerOn",value:function(t,e){this.setCenter(t.center(),e)}},{key:"clear",value:function(){for(var t=0;t<this._objects.length;++t)this._objects[t].destroy();this._objects=[]}},{key:"on",value:function(t,e){if("keypress"!==t&&"keydown"!==t&&"keyup"!==t)if("viewpointChanged"!==t){"mousemove"!==t&&"mousedown"!==t&&"mouseup"!==t||this._canvas.domElement().addEventListener(t,e,!1);var n=this.listenerMap[t];if(void 0===n&&(n=[],this.listenerMap[t]=n),"center"===e){var r,i=(r=this._mouseHandler,this._mouseHandler._centerOnClicked).bind(r);n.push(i)}else n.push(e);this._initialized&&"viewerReady"===t&&e(this,null)}else this._cam.addOnCameraChanged(e);else this._keyInput.addEventListener(t,e,!1)}},{key:"_dispatchEvent",value:function(t,e,n){var r=this.listenerMap[e];r&&r.forEach(function(e){e(n,t)})}},{key:"renderAs",value:function(t,e,n,r){for(var i=!1,a=0;a<this.RENDER_MODES.length;++a)if(this.RENDER_MODES[a]===n){i=!0;break}if(i)return this[n](t,e,r);console.error("render mode",n,"not supported")}},{key:"_handleStandardMolOptions",value:function(t,e){return t=this._handleStandardOptions(t),t.showRelated=t.showRelated||"asym",t.showRelated&&"asym"!==t.showRelated&&null===e.assembly(t.showRelated)&&(console.error("no assembly with name",t.showRelated,". Falling back to asymmetric unit"),t.showRelated="asym"),t}},{key:"_handleStandardOptions",value:function(t){return t=Object.assign({},t),t.float32Allocator=this._float32Allocator,t.uint16Allocator=this._uint16Allocator,t.idPool=this._objectIdManager,t}},{key:"lineTrace",value:function(t,e,n){var r=this._handleStandardMolOptions(n,e);r.color=r.color||Br([1,0,1]),r.lineWidth=r.lineWidth||4;var i=Zi(e,this._canvas.gl(),r);return this.add(t,i)}},{key:"spheres",value:function(t,e,n){var r=this._handleStandardMolOptions(n,e);r.color=r.color||zr(),r.sphereDetail=this.options("sphereDetail"),r.radiusMultiplier=r.radiusMultiplier||1;var i;return i=this._canvas.gl().getExtension("EXT_frag_depth")?ji(e,this._canvas.gl(),r):Li(e,this._canvas.gl(),r),this.add(t,i)}},{key:"sline",value:function(t,e,n){var r=this._handleStandardMolOptions(n,e);r.color=r.color||Br([1,0,1]),r.splineDetail=r.splineDetail||this.options("splineDetail"),r.strength=r.strength||1,r.lineWidth=r.lineWidth||4;var i=ta(e,this._canvas.gl(),r);return this.add(t,i)}},{key:"cartoon",value:function(t,e,n){var r=this._handleStandardMolOptions(n,e);r.color=r.color||Ur(),r.strength=r.strength||1,r.splineDetail=r.splineDetail||this.options("splineDetail"),r.arcDetail=r.arcDetail||this.options("arcDetail"),r.radius=r.radius||.3,r.forceTube=r.forceTube||!1,r.smoothStrands=void 0===r.smoothStrands||r.smoothStrands;var i=la(e,this._canvas.gl(),r);return this.add(t,i)}},{key:"surface",value:function(t,e,n){var r=this._handleStandardOptions(n),i=ha(e,this._canvas.gl(),r);return this.add(t,i)}},{key:"tube",value:function(t,e,n){return n=n||{},n.forceTube=!0,this.cartoon(t,e,n)}},{key:"ballsAndSticks",value:function(t,e,n){var r=this._handleStandardMolOptions(n,e);r.color=r.color||zr(),r.cylRadius=r.radius||r.cylRadius||.1,r.sphereRadius=r.radius||r.sphereRadius||.2,r.arcDetail=2*(r.arcDetail||this.options("arcDetail")),r.sphereDetail=r.sphereDetail||this.options("sphereDetail"),r.scaleByAtomRadius=An(r,"scaleByAtomRadius",!0);var i=Ui(e,this._canvas.gl(),r);return this.add(t,i)}},{key:"lines",value:function(t,e,n){var r=this._handleStandardMolOptions(n,e);r.color=r.color||zr(),r.lineWidth=r.lineWidth||4;var i=Gi(e,this._canvas.gl(),r);return this.add(t,i)}},{key:"points",value:function(t,e,n){var r=this._handleStandardMolOptions(n,e);r.color=r.color||zr(),r.pointSize=r.pointSize||1;var i=Wi(e,this._canvas.gl(),r);return this.add(t,i)}},{key:"trace",value:function(t,e,n){var r=this._handleStandardMolOptions(n,e);r.color=r.color||Br([1,0,0]),r.radius=r.radius||.3,r.arcDetail=2*(r.arcDetail||this.options("arcDetail")),r.sphereDetail=r.sphereDetail||this.options("sphereDetail");var i=ia(e,this._canvas.gl(),r);return this.add(t,i)}},{key:"_updateProjectionIntervals",value:function(t,e,n){n.eachAtom(function(n){for(var r=n.pos(),i=0;i<3;++i)e[i].update(Bt(r,t[i]))});for(var r=0;r<3;++r)e[r].extend(1.5)}},{key:"fitTo",value:function(t,e){var n=this._cam.mainAxes(),r=[new Ma,new Ma,new Ma];if(t instanceof ei)t.updateProjectionIntervals(n[0],n[1],n[2],r[0],r[1],r[2]);else if(void 0!==t.eachAtom)this._updateProjectionIntervals(n,r,t);else if(void 0!==t.length)for(var i=0;i<t.length;++i)this._updateProjectionIntervals(n,r,t[i]);this._fitToIntervals(n,r,e)}},{key:"_fitToIntervals",value:function(t,e,n){if(e[0].empty()||e[1].empty()||e[2].empty())console.error("could not determine interval. No objects shown?");else{var r=e[0].center(),i=e[1].center(),a=e[2].center(),o=[r*t[0][0]+i*t[1][0]+a*t[2][0],r*t[0][1]+i*t[1][1]+a*t[2][1],r*t[0][2]+i*t[1][2]+a*t[2][2]],s=this._cam.fieldOfViewY(),u=this._cam.aspectRatio(),l=e[0].length()/u,h=e[1].length(),c=.5*Math.max(l,h)/Math.tan(.5*s),d=c+.5*e[2].length(),f=Math.max(c-.5,.1),_=1+c+e[2].length();this._cam.setNearFar(f,_);var v=void 0===n?this._options.animateTime:0|n;this.setCamera(this._cam.rotation(),o,d,v),this.requestRedraw()}}},{key:"autoZoom",value:function(t){var e=this._cam.mainAxes(),n=[new Ma,new Ma,new Ma];this.forEach(function(t){t.visible()&&t.updateProjectionIntervals(e[0],e[1],e[2],n[0],n[1],n[2])}),this._fitToIntervals(e,n,t)}},{key:"autoSlab",value:function(){var t=this._options._slabMode.update(this._objects,this._cam);null!==t&&this._cam.setNearFar(t.near,t.far),this.requestRedraw()}},{key:"rockAndRoll",value:function(t){return void 0===t?null!==this._rockAndRoll:t?(null===this._rockAndRoll&&(this._rockAndRoll=vn(),this._animControl.add(this._rockAndRoll),this.requestRedraw()),!0):(this._animControl.remove(this._rockAndRoll),this._rockAndRoll=null,this.requestRedraw(),!1)}},{key:"spin",value:function(t,e){return void 0===t?null!==this._spin:!1===t?(this._animControl.remove(this._spin),this._spin=null,this.requestRedraw(),!1):(!0===t&&(t=Math.PI/8),e=e||[0,1,0],null===this._spin?(this._spin=_n(e,t),this._animControl.add(this._spin)):(this._spin.setSpeed(t),this._spin.setAxis(e)),this.requestRedraw(),!0)}},{key:"slabMode",value:function(t,e){var n=bn(t,e=e||{}),r=n.update(this._objects,this._cam);null!==r&&this._cam.setNearFar(r.near,r.far),this._options.slabMode=n,this.requestRedraw()}},{key:"label",value:function(t,e,n,r){var i=new yi(this._canvas.gl(),this._textureCanvas,this._2dcontext,n,e,r);return this.add(t,i),i}},{key:"customMesh",value:function(t,e){var n=this._handleStandardOptions(e),r=new pi(t,this._canvas.gl(),n.float32Allocator,n.uint16Allocator,n.idPool);return this.add(t,r),r}},{key:"_drawPickingScene",value:function(){var t=this._canvas.gl();t.clearColor(0,0,0,0),t.disable(t.BLEND),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.clearColor(this._options.background[0],this._options.background[1],this._options.background[2],1),t.cullFace(t.FRONT),t.enable(t.CULL_FACE),this._drawWithPass("select")}},{key:"pick",value:function(t){this._pickBuffer.bind(),this._drawPickingScene();var e=new Uint8Array(4),n=this._canvas.gl();n.readPixels(t.x,this._options.height-t.y,1,1,n.RGBA,n.UNSIGNED_BYTE,e),this._pickBuffer.release(),e.data&&(e=e.data);var r=e[0]|e[1]<<8|e[2]<<16,i=e[3],a=this._objectIdManager.objectForId(r);if(void 0===a)return null;var o=mt(),s=null,u=null,l="unknown";return 255!==i?(s=a.atom,u=a.geom.symWithIndex(i),Ht(o,a.atom.pos(),u),l=a.isTrace?"trace":"full"):void 0!==a.atom?(s=a.atom,o=a.atom.pos(),l=a.isTrace?"trace":"full"):(s=a.userData,o=a.center),new Sa(s,a.geom,i<255?i:null,o,a,u,l)}},{key:"add",value:function(t,e){return e.name(t),this._objects.push(e),this._objects.sort(function(t,e){return t.order()-e.order()}),this.requestRedraw(),e}},{key:"_globToRegex",value:function(t){var e=t.replace(".","\\.").replace("*",".*");return new RegExp("^"+e+"$")}},{key:"forEach",value:function(){var t,e="*";2===arguments.length?(t=arguments[1],e=arguments[0]):t=arguments[0];for(var n=this._globToRegex(e),r=0;r<this._objects.length;++r){var i=this._objects[r];n.test(i.name())&&t(i,r)}}},{key:"rotation",value:function(){return this._cam.rotation()}},{key:"center",value:function(){return this._cam.center()}},{key:"get",value:function(t){for(var e=0;e<this._objects.length;++e)if(this._objects[e].name()===t)return this._objects[e];return console.error("could not find object with name",t),null}},{key:"hide",value:function(t){this.forEach(t,function(t){t.hide()})}},{key:"show",value:function(t){this.forEach(t,function(t){t.show()})}},{key:"rm",value:function(t){for(var e=[],n=this._globToRegex(t),r=0;r<this._objects.length;++r){var i=this._objects[r];n.test(i.name())?i.destroy():e.push(i)}this._objects=e}},{key:"all",value:function(){return this._objects}},{key:"isWebGLSupported",value:function(){return this._canvas.isWebGLSupported()}},{key:"destroy",value:function(){this.clear(),this._canvas.destroy(),this._canvas=null}}]),e}();Ta.RENDER_MODES=["sline","lines","trace","lineTrace","cartoon","tube","spheres","ballsAndSticks","points"];var Ea=function(){function t(e,n){mr(this,t),this._chains=e||[],this._matrices=n||[]}return gr(t,[{key:"addChain",value:function(t){this._chains.push(t)}},{key:"chains",value:function(){return this._chains}},{key:"addMatrix",value:function(t){this._matrices.push(t)}},{key:"matrices",value:function(){return this._matrices}},{key:"matrix",value:function(t){return this._matrices[t]}}]),t}(),xa=function(){function t(e){mr(this,t),this._name=e,this._generators=[]}return gr(t,[{key:"name",value:function(){return this._name}},{key:"generators",value:function(){return this._generators}},{key:"generator",value:function(t){return this._generators[t]}},{key:"addGenerator",value:function(t){this._generators.push(t)}}]),t}(),Fa=function(){function t(){mr(this,t)}return gr(t,[{key:"bondCount",value:function(){return this.bonds().length}},{key:"eachBond",value:function(t){for(var e=this.bonds(),n=0,r=e.length;n<r;++n)t(e[n])}},{key:"isConnectedTo",value:function(t){if(null===t)return!1;for(var e=t.full(),n=this.full(),r=this.bonds(),i=0,a=r.length;i<a;++i){var o=r[i];if(o.atom_one()===n&&o.atom_two()===e||o.atom_one()===e&&o.atom_two()===n)return!0}return!1}}]),t}(),Oa=function(t){function e(t,n,r,i,a,o,s,u,l){mr(this,e);var h=br(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,r,i,a,o,s,u,l));return h._properties={},h._residue=t,h._bonds=[],h._isHetatm=Boolean(o),h._name=n,h._pos=r,h._index=a,h._element=i,h._occupancy=void 0!==s?s:null,h._tempFactor=void 0!==u?u:null,h._serial=0|l,h}return yr(e,t),gr(e,[{key:"addBond",value:function(t){this._bonds.push(t)}},{key:"name",value:function(){return this._name}},{key:"bonds",value:function(){return this._bonds}},{key:"residue",value:function(){return this._residue}},{key:"structure",value:function(){return this._residue.structure()}},{key:"full",value:function(){return this}},{key:"qualifiedName",value:function(){return this.residue().qualifiedName()+"."+this.name()}},{key:"pos",value:function(){return this._pos}},{key:"setPos",value:function(t){yt(this._pos,t)}},{key:"element",value:function(){return this._element}},{key:"index",value:function(){return this._index}},{key:"occupancy",value:function(){return this._occupancy}},{key:"tempFactor",value:function(){return this._tempFactor}},{key:"serial",value:function(){return this._serial}},{key:"isHetatm",value:function(){return this._isHetatm}},{key:"prop",value:function(t){var e=this[t];if(void 0!==e)return e.call(this);var n=this._properties[t];return void 0===n?0:n}},{key:"setProp",value:function(t,e){this._properties[t]=e}}]),e}(Fa),Da=function(t){function e(t,n){mr(this,e);var r=br(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return r._resView=t,r._atom=n,r._bonds=[],r}return yr(e,t),gr(e,[{key:"full",value:function(){return this._atom}},{key:"name",value:function(){return this._atom.name()}},{key:"pos",value:function(){return this._atom.pos()}},{key:"element",value:function(){return this._atom.element()}},{key:"residue",value:function(){return this._resView}},{key:"bonds",value:function(){return this._atom.bonds()}},{key:"index",value:function(){return this._atom.index()}},{key:"occupancy",value:function(){return this._atom.occupancy()}},{key:"tempFactor",value:function(){return this._atom.tempFactor()}},{key:"serial",value:function(){return this._atom.serial()}},{key:"qualifiedName",value:function(){return this._atom.qualifiedName()}},{key:"isHetatm",value:function(){return this._atom.isHetatm()}},{key:"prop",value:function(t){return this._atom.prop(t)}},{key:"setProp",value:function(t,e){this._atom.setProp(t,e)}}]),e}(Fa),Pa=function(){function t(){mr(this,t)}return gr(t,[{key:"isWater",value:function(){return"HOH"===this.name()||"DOD"===this.name()}},{key:"eachAtom",value:function(t,e){e|=0;for(var n=0;n<this._atoms.length;n+=1){if(!1===t(this._atoms[n],e))return!1;e+=1}return e}},{key:"qualifiedName",value:function(){var t=this.chain().name()+"."+this.name()+this.num();return"\0"===this.insCode()?t:t+this.insCode()}},{key:"atom",value:function(t){if("string"==typeof t){for(var e=0;e<this._atoms.length;++e)if(this._atoms[e].name()===t)return this._atoms[e];return null}return t>=this._atoms.length||t<0?null:this._atoms[t]}},{key:"centralAtom",value:function(){return this.isAminoacid()?this.atom("CA"):this.isNucleotide()?this.atom("C3'"):null}},{key:"center",value:function(){var t=0,e=mt();return this.eachAtom(function(n){At(e,e,n.pos()),t+=1}),t>0&&xt(e,e,1/t),e}},{key:"isAminoacid",value:function(){return this._isAminoacid}},{key:"isNucleotide",value:function(){return this._isNucleotide}}]),t}(),Ia=function(t){function e(t,n,r,i){mr(this,e);var a=br(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,r,i));return a._name=n,a._num=r,a._insCode=i,a._atoms=[],a._ss="C",a._chain=t,a._isAminoacid=!1,a._isNucleotide=!1,a._index=t.residues().length,a._properties={},a}return yr(e,t),gr(e,[{key:"_deduceType",value:function(){this._isNucleotide=null!==this.atom("P")&&null!==this.atom("C3'"),this._isAminoacid=null!==this.atom("N")&&null!==this.atom("CA")&&null!==this.atom("C")&&null!==this.atom("O")}},{key:"name",value:function(){return this._name}},{key:"insCode",value:function(){return this._insCode}},{key:"num",value:function(){return this._num}},{key:"full",value:function(){return this}},{key:"addAtom",value:function(t,e,n,r,i,a,o){var s=new Oa(this,t,e,n,this.structure().nextAtomIndex(),r,i,a,0|o);return this._atoms.push(s),s}},{key:"ss",value:function(){return this._ss}},{key:"setSS",value:function(t){this._ss=t}},{key:"index",value:function(){return this._index}},{key:"atoms",value:function(){return this._atoms}},{key:"chain",value:function(){return this._chain}},{key:"structure",value:function(){return this._chain.structure()}},{key:"prop",value:function(t){var e=this[t];if(void 0!==e)return e.call(this);var n=this._properties[t];return void 0===n?0:n}},{key:"setProp",value:function(t,e){this._properties[t]=e}}]),e}(Pa),Va=function(t){function e(t,n){mr(this,e);var r=br(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return r._chainView=t,r._atoms=[],r._residue=n,r}return yr(e,t),gr(e,[{key:"addAtom",value:function(t,e){if(e)for(var n=0;n<this._atoms.length;++n){var r=this._atoms[n];if(r.index()===t.index())return r}var i=new Da(this,t.full());return this._atoms.push(i),i}},{key:"removeAtom",value:function(t){var e=this._atoms.length;return this._atoms=this._atoms.filter(function(e){return e.index()!==t.index()}),e!==this._atoms.length}},{key:"full",value:function(){return this._residue}},{key:"num",value:function(){return this._residue.num()}},{key:"insCode",value:function(){return this._residue.insCode()}},{key:"ss",value:function(){return this._residue.ss()}},{key:"index",value:function(){return this._residue.index()}},{key:"chain",value:function(){return this._chainView}},{key:"name",value:function(){return this._residue.name()}},{key:"atoms",value:function(){return this._atoms}},{key:"qualifiedName",value:function(){return this._residue.qualifiedName()}},{key:"containsResidue",value:function(t){return this._residue.full()===t.full()}},{key:"isAminoacid",value:function(){return this._residue.isAminoacid()}},{key:"isNucleotide",value:function(){return this._residue.isNucleotide()}},{key:"isWater",value:function(){return this._residue.isWater()}},{key:"prop",value:function(t){return this._residue.prop(t)}},{key:"setProp",value:function(t,e){this._residue.setProp(t,e)}}]),e}(Pa),Na=function(){function t(){mr(this,t),this._trace=[]}return gr(t,[{key:"push",value:function(t){this._trace.push(t)}},{key:"length",value:function(){return this._trace.length}},{key:"residueAt",value:function(t){return this._trace[t]}},{key:"posAt",value:function(t,e){return yt(t,this._trace[e].centralAtom().pos()),t}},{key:"smoothPosAt",value:function(t,e){return this.posAt(t,e)}},{key:"normalAt",value:function(t,e){var n=this._trace[e];return n.isAminoacid()&&kt(t,n.atom("O").pos(),n.atom("C").pos()),Lt(t,t),t}},{key:"smoothNormalAt",value:function(t,e){return this.normalAt(t,e)}},{key:"centralAtomAt",value:function(t){return this._trace[t].centralAtom()}},{key:"tangentAt",value:function(t,e){var n=mt(),r=mt();e>0?this.posAt(n,e-1):this.posAt(n,e),e<this._trace.length-1?this.posAt(r,e+1):this.posAt(r,e),kt(t,r,n)}},{key:"fullTraceIndex",value:function(t){return t}},{key:"residues",value:function(){return this._trace}},{key:"subsets",value:function(t){for(var e=0,n=0,r=[];n<t.length&&e<this._trace.length;){for(var i=t[n].full().index();this._trace.length>e&&this._trace[e].index()<i;)++e;if(e>=this._trace.length)break;for(var a=this._trace[e].index();t.length>n&&t[n].full().index()<a;)++n;if(n>=t.length)break;for(var o=e;t.length>n&&this._trace.length>e&&t[n].full().index()===this._trace[e].index();)++n,++e;var s=e;r.push(new La(this,o,s))}return r}}]),t}(),La=function(){function t(e,n,r){mr(this,t),this._fullTrace=e,this._fullTraceBegin=n,this._fullTraceEnd=r,this._isNTerminal=0===this._fullTraceBegin,this._isCTerminal=this._fullTrace.length()===this._fullTraceEnd;var i=this._fullTraceEnd-this._fullTraceBegin;this._isCTerminal||++i,this._isNTerminal||(++i,this._fullTraceBegin-=1),this._length=i}return gr(t,[{key:"length",value:function(){return this._length}},{key:"residueAt",value:function(t){return this._fullTrace.residueAt(this._fullTraceBegin+t)}},{key:"residues",value:function(){for(var t=[],e=0;e<this._length;++e)t.push(this.residueAt(e));return t}},{key:"_interpolate",value:function(t,e,n,r){var i=mt(),a=mt();return this.tangentAt(i,e),this.tangentAt(a,n),xt(i,i,r),xt(a,a,r),ai(t,this.centralAtomAt(e).pos(),i,this.centralAtomAt(n).pos(),a,.5,0),t}},{key:"smoothPosAt",value:function(t,e,n){return 0!==e||this._isNTerminal?e!==this._length-1||this._isCTerminal?(yt(t,this.centralAtomAt(e).pos()),t):this._interpolate(t,e-1,e,n):this._interpolate(t,e,e+1,n)}},{key:"smoothNormalAt",value:function(t,e){return this._fullTrace.normalAt(t,e+this._fullTraceBegin),t}},{key:"posAt",value:function(t,e){return yt(t,this.centralAtomAt(e).pos()),0!==e||this._isNTerminal||(At(t,t,this.centralAtomAt(e+1).pos()),xt(t,t,.5)),e!==this._length-1||this._isCTerminal||(At(t,t,this.centralAtomAt(e-1).pos()),xt(t,t,.5)),t}},{key:"centralAtomAt",value:function(t){return this.residueAt(t).centralAtom()}},{key:"fullTraceIndex",value:function(t){return this._fullTraceBegin+t}},{key:"tangentAt",value:function(t,e){return this._fullTrace.tangentAt(t,e+this._fullTraceBegin)}}]),t}(),Ba=function(){function t(){mr(this,t)}return gr(t,[{key:"eachAtom",value:function(t,e){e|=0;for(var n=0;n<this._residues.length;n+=1)if(!1===(e=this._residues[n].eachAtom(t,e)))return!1;return e}},{key:"atomCount",value:function(){for(var t=0,e=this.residues(),n=0;n<e.length;++n)t+=e[n].atoms().length;return t}},{key:"eachResidue",value:function(t){for(var e=0;e<this._residues.length;e+=1)if(!1===t(this._residues[e]))return!1}},{key:"residues",value:function(){return this._residues}},{key:"structure",value:function(){return this._structure}},{key:"asView",value:function(){var t=this.structure().createEmptyView();return t.addChain(this,!0),t}},{key:"residueByRnum",value:function(t){var e=this.residues();if(this._rnumsOrdered){var n=Ca(e,wn(t),Cn);return-1===n?null:e[n]}for(var r=0;r<e.length;++r)if(e[r].num()===t)return e[r];return null}},{key:"residuesInRnumRange",value:function(t,e){var n,r,i=[],a=this.residues();if(!0===this._rnumsOrdered){var o=wa(a,wn(t),Cn);if(-1===o)return i;var s=Ra(a,wn(e),Cn);if(-1===s)return i;for(n=o;n<=s;++n)i.push(this._residues[n])}else for(n=0,r=a.length;n!==r;++n){var u=a[n];u.num()>=t&&u.num()<=e&&i.push(u)}return i}},{key:"prop",value:function(t){return this[t]()}}]),t}(),ja=function(t){function e(t,n){mr(this,e);var r=br(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return r._structure=t,r._name=n,r._cachedTraces=[],r._residues=[],r._rnumsOrdered=!0,r}return yr(e,t),gr(e,[{key:"name",value:function(){return this._name}},{key:"full",value:function(){return this}},{key:"addResidue",value:function(t,e,n){var r=new Ia(this,t,e,n=n||"\0");return this._rnumsOrdered=Sn(this._residues,this._rnumsOrdered,r),this._residues.push(r),r}},{key:"assignSS",value:function(t,e,n){for(var r=kn(t[0],t[1]),i=kn(e[0],e[1]),a=1;a<this._residues.length-1;++a){var o=this._residues[a],s=kn(o.num(),o.insCode());s<r||s>=i||o.setSS(n)}}},{key:"eachBackboneTrace",value:function(t){this._cacheBackboneTraces();for(var e=0;e<this._cachedTraces.length;++e)t(this._cachedTraces[e])}},{key:"_cacheBackboneTraces",value:function(){if(!(this._cachedTraces.length>0)){for(var t=new Na,e=null,n=0;n<this._residues.length;n+=1){var r=this._residues[n],i=r.isAminoacid(),a=r.isNucleotide();!0===e&&!i||!1===e&&!a||null===e&&!a&&!i?(Mn(this._cachedTraces,t),e=null,t=new Na):0!==t.length()?(Rn(e,this._residues[n-1],r)&&(Mn(this._cachedTraces,t),t=new Na),t.push(r)):(t.push(r),e=r.isAminoacid())}Mn(this._cachedTraces,t)}}},{key:"backboneTraces",value:function(){var t=[];return this.eachBackboneTrace(function(e){t.push(e)}),t}}]),e}(Ba),za=function(t){function e(t,n){mr(this,e);var r=br(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return r._chain=n,r._residues=[],r._molView=t,r._residueMap={},r._rnumsOrdered=!0,r}return yr(e,t),gr(e,[{key:"addResidue",value:function(t,e){var n=new Va(this,t.full());if(this._rnumsOrdered=Sn(this._residues,this._rnumsOrdered,t),this._residues.push(n),this._residueMap[t.full().index()]=n,e)for(var r=t.atoms(),i=0;i<r.length;++i)n.addAtom(r[i].full(),!1);return n}},{key:"addAtom",value:function(t){var e=this._residueMap[t.residue().full().index()];return void 0===e&&(e=this.addResidue(t.residue())),e.addAtom(t,!0)}},{key:"removeAtom",value:function(t,e){var n=this._residueMap[t.residue().full().index()];if(void 0===n)return!1;var r=n.removeAtom(t);return r&&0===n.atoms().length&&e&&(delete this._residueMap[t.residue().full().index()],this._residues=this._residues.filter(function(t){return t!==n})),r}},{key:"containsResidue",value:function(t){var e=this._residueMap[t.full().index()];return void 0!==e&&e.full()===t.full()}},{key:"eachBackboneTrace",value:function(t){for(var e=this._chain.backboneTraces(),n=0;n<e.length;++n)for(var r=e[n].subsets(this._residues),i=0;i<r.length;++i)t(r[i])}},{key:"backboneTraces",value:function(){var t=[];return this.eachBackboneTrace(function(e){t.push(e)}),t}},{key:"full",value:function(){return this._chain}},{key:"name",value:function(){return this._chain.name()}},{key:"structure",value:function(){return this._molView}}]),e}(Ba),Ua={H:.31,HE:.28,LI:1.28,BE:.96,B:.84,C:.76,N:.71,O:.66,F:.57,NE:.58,NA:1.66,MG:1.41,AL:1.21,SI:1.11,P:1.07,S:1.05,CL:1.02,AR:1.06,K:2.03,CA:1.76,SC:1.7,TI:1.6,V:1.53,CR:1.39,MN:1.39,FE:1.32,CO:1.26,NI:1.24,CU:1.32,ZN:1.22,GA:1.22,GE:1.2,AS:1.19,SE:1.2,BR:1.2,KR:1.16,RB:2.2,SR:1.95,Y:1.9,ZR:1.75,NB:1.64,MO:1.54,TC:1.47,RU:1.46,RH:1.42,PD:1.39,AG:1.45,CD:1.44,IN:1.42,SN:1.39,SB:1.39,TE:1.38,I:1.39,XE:1.4,CS:2.44,BA:2.15,LA:2.07,CE:2.04,PR:2.03,ND:2.01,PM:1.99,SM:1.98,EU:1.98,GD:1.96,TB:1.94,DY:1.92,HO:1.92,ER:1.89,TM:1.9,YB:1.87,LU:1.87,HF:1.75,TA:1.7,W:1.62,RE:1.51,OS:1.44,IR:1.41,PT:1.36,AU:1.36,HG:1.32,TL:1.45,PB:1.46,BI:1.48,PO:1.4,AT:1.5,RN:1.5,FR:2.6,RA:2.21,AC:2.15,TH:2.06,PA:2,U:1.96,NP:1.9,PU:1.87,AM:1.8,CM:1.69},qa=function(){function t(){mr(this,t)}return gr(t,[{key:"eachResidue",value:function(t){for(var e=0;e<this._chains.length;e+=1)if(!1===this._chains[e].eachResidue(t))return!1}},{key:"eachAtom",value:function(t,e){e|=0;for(var n=0;n<this._chains.length;n+=1)if(!1===(e=this._chains[n].eachAtom(t,e)))return!1}},{key:"residueCount",value:function(){for(var t=this.chains(),e=0,n=0;n<t.length;++n)e+=t[n].residues().length;return e}},{key:"eachChain",value:function(t){for(var e=this.chains(),n=0;n<e.length;++n)if(!1===t(e[n]))return}},{key:"atomCount",value:function(){for(var t=this.chains(),e=0,n=0;n<t.length;++n)e+=t[n].atomCount();return e}},{key:"atoms",value:function(){var t=[];return this.eachAtom(function(e){t.push(e)}),t}},{key:"atom",value:function(t){var e=t.split("."),n=this.chain(e[0]);if(null===n)return null;var r=n.residueByRnum(parseInt(e[1],10));return null===r?null:r.atom(e[2])}},{key:"center",value:function(){var t=mt(),e=0;return this.eachAtom(function(n){At(t,t,n.pos()),e+=1}),e&&xt(t,t,1/e),t}},{key:"boundingSphere",value:function(){var t=this.center(),e=0;return this.eachAtom(function(n){e=Math.max(e,Dt(t,n.pos()))}),new geom.Sphere(t,Math.sqrt(e))}},{key:"backboneTraces",value:function(){for(var t=this.chains(),e=[],n=0;n<t.length;++n)Array.prototype.push.apply(e,t[n].backboneTraces());return e}},{key:"select",value:function(t){function e(e){return t.apply(this,arguments)}return e.toString=function(){return t.toString()},e}(function(t){return"protein"===t?this.residueSelect(function(t){return t.isAminoacid()}):"water"===t?this.residueSelect(function(t){return t.isWater()}):"ligand"===t?this.residueSelect(function(t){return!t.isAminoacid()&&!t.isWater()}):"polymer"===t?select.polymer(this,new Ha(this)):select.dict(this,new Ha(this),t||{})})},{key:"residueSelect",value:function(t){console.time("Mol.residueSelect");for(var e=new Ha(this.full()),n=0;n<this._chains.length;++n)for(var r=this._chains[n],i=null,a=r.residues(),o=0;o<a.length;++o)t(a[o])&&(i||(i=e.addChain(r,!1)),i.addResidue(a[o],!0));return console.timeEnd("Mol.residueSelect"),e}},{key:"atomSelect",value:function(t){console.time("Mol.atomSelect");for(var e=new Ha(this.full()),n=0;n<this._chains.length;++n)for(var r=this._chains[n],i=null,a=r.residues(),o=0;o<a.length;++o)for(var s=null,u=a[o],l=u.atoms(),h=0;h<l.length;++h)t(l[h])&&(i||(i=e.addChain(r,!1)),s||(s=i.addResidue(u,!1)),s.addAtom(l[h]));return console.timeEnd("Mol.atomSelect"),e}},{key:"assembly",value:function(t){for(var e=this.assemblies(),n=0;n<e.length;++n)if(e[n].name()===t)return e[n];return null}},{key:"chainsByName",value:function(t){for(var e={},n=this.chains(),r=0;r<n.length;++r)e[n[r].name()]=n[r];for(var i=[],a=0;a<t.length;++a){var o=e[t[a]];void 0!==o&&i.push(o)}return i}},{key:"selectWithin",value:function(t,e){console.time("Mol.selectWithin");var n=mt(),r=(e=e||{}).radius||4,i=r*r,a=!!e.matchResidues,o=[];t.eachAtom(function(t){o.push(t)});for(var s=new Ha(this.full()),u=null,l=null,h=this.chains(),c=!1,d=0;d<h.length;++d){var f=h[d].residues();l=null;for(var _=0;_<f.length;++_){u=null,c=!1;for(var v=f[_].atoms(),m=0;m<v.length&&!c;++m)for(var g=0;g<o.length;++g)if(kt(n,v[m].pos(),o[g].pos()),!(It(n)>i)){if(l||(l=s.addChain(h[d].full(),!1)),u||(u=l.addResidue(f[_].full(),a)),a){c=!0;break}u.addAtom(v[m].full());break}}}return console.timeEnd("Mol.selectWithin"),s}},{key:"createEmptyView",value:function(){return new Ha(this.full())}}]),t}(),Wa=function(t){function e(){mr(this,e);var t=br(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t._chains=[],t._assemblies=[],t._nextAtomIndex=0,t}return yr(e,t),gr(e,[{key:"addAssembly",value:function(t){this._assemblies.push(t)}},{key:"setAssemblies",value:function(t){this._assemblies=t}},{key:"assemblies",value:function(){return this._assemblies}},{key:"chains",value:function(){return this._chains}},{key:"full",value:function(){return this}},{key:"containsResidue",value:function(t){return t.full().structure()===this}},{key:"chainByName",value:function(t){for(var e=0;e<this._chains.length;++e)if(this._chains[e].name()===t)return this._chains[e];return null}},{key:"chain",value:function(t){return this.chainByName(t)}},{key:"nextAtomIndex",value:function(){var t=this._nextAtomIndex;return this._nextAtomIndex+=1,t}},{key:"addChain",value:function(t){var e=new ja(this,t);return this._chains.push(e),e}},{key:"connect",value:function(t,e){var n=new Tn(t,e);return t.addBond(n),e.addBond(n),n}},{key:"deriveConnectivity",value:function(){console.time("Mol.deriveConnectivity");var t=this,e=null;this.eachResidue(function(n){for(var r,i=n.atoms(),a=i.length,o=0;o<a;o+=1)for(var s=i[o],u=s.pos(),l=En(s.element()),h=0;h<o;h+=1){var c=i[h],d=En(c.element()),f=l+d-.3,_=l+d+.3;(r=Dt(u,c.pos()))<_*_&&r>f*f&&t.connect(s,c)}n._deduceType(),null!==e&&(n.isAminoacid()&&e.isAminoacid()&&xn(t,e,n),n.isNucleotide()&&e.isNucleotide()&&Fn(t,e,n)),e=n}),console.timeEnd("Mol.deriveConnectivity")}}]),e}(qa),Ha=function(t){function e(t){mr(this,e);var n=br(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n._mol=t,n._chains=[],n}return yr(e,t),gr(e,[{key:"full",value:function(){return this._mol}},{key:"assemblies",value:function(){return this._mol.assemblies()}},{key:"addChain",value:function(t,e){var n=new za(this,t.full());if(this._chains.push(n),e)for(var r=t.residues(),i=0;i<r.length;++i)n.addResidue(r[i],!0);return n}},{key:"addAtom",value:function(t){var e=this.chain(t.residue().chain().name());return null===e&&(e=this.addChain(t.residue().chain())),e.addAtom(t)}},{key:"removeAtom",value:function(t,e){if(null===t)return!1;var n=this.chain(t.residue().chain().name());if(null===n)return!1;var r=n.removeAtom(t,e);return r&&0===n.residues().length&&(this._chains=this._chains.filter(function(t){return t!==n})),r}},{key:"containsResidue",value:function(t){if(!t)return!1;var e=this.chain(t.chain().name());return!!e&&e.containsResidue(t)}},{key:"addResidues",value:function(t,e){var n=this,r={};return t.forEach(function(t){var i=t.chain().name();void 0===r[i]&&(r[i]=n.addChain(t.chain(),!1)),r[i].addResidue(t,e)}),r}},{key:"chains",value:function(){return this._chains}},{key:"chain",value:function(t){for(var e=0;e<this._chains.length;++e)if(this._chains[e].name()===t)return this._chains[e];return null}}]),e}(qa),Ga=function(){function t(){mr(this,t),this._assemblies={},this._current=null}return gr(t,[{key:"assemblies",value:function(){var t=[];for(var e in this._assemblies)this._assemblies.hasOwnProperty(e)&&t.push(this._assemblies[e]);return t}},{key:"assembly",value:function(t){return this._assemblies[t]}},{key:"nextLine",value:function(t){if("B"===(t=t.substr(11))[0]&&"BIOMOLECULE:"===t.substr(0,12)){var e=t.substr(13).trim();return this._currentAssembly=new xa(e),void(this._assemblies[e]=this._currentAssembly)}if("APPLY THE FOLLOWING TO CHAINS:"!==t.substr(0,30)&&"                   AND CHAINS:"!==t.substr(0,30)){if("  BIOMT"===t.substr(0,7)){for(var n=parseInt(t[7],10)-1,r=0;" "!==t[12+r];)r+=1;var i=parseFloat(t.substr(13+r,9)),a=parseFloat(t.substr(23+r,9)),o=parseFloat(t.substr(33+r,9)),s=parseFloat(t.substr(43+r,14));return this._currentMatrix[0+n]=i,this._currentMatrix[4+n]=a,this._currentMatrix[8+n]=o,this._currentMatrix[12+n]=s,void(2===n&&(this._currentSymGen.addMatrix(this._currentMatrix),this._currentMatrix=T()))}}else{var u=t.substr(30).split(",");"A"===t[0]&&(this._currentSymGen=new Ea,this._currentAssembly.addGenerator(this._currentSymGen)),this._currentMatrix=T();for(var l=0;l<u.length;++l){var h=u[l].trim();h.length&&this._currentSymGen.addChain(h)}}}}]),t}(),Xa=function(t){if(" "!==t[0]){var e=t.trim();if(4===e.length){for(var n=0,r=e.charCodeAt(n);n<4&&(r<65||r>122||r>90&&r<97);)++n,r=e.charCodeAt(n);return e[n]}var i=e.charCodeAt(0);return i>=48&&i<=57?e[1]:e.substr(0,2)}return t[1]},Ya=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};mr(this,t),this.CONTINUE=1,this.MODEL_COMPLETE=2,this.FILE_END=3,this.ERROR=4,this._helices=[],this._sheets=[],this._conect=[],this._serialToAtomMap={},this._rosettaMode=!1,this._structure=new Wa,this._remark350Reader=new Ga,this._currChain=null,this._currRes=null,this._currAtom=null,this._options={},this._options.conectRecords=Boolean(e.conectRecords)}return gr(t,[{key:"parseHelixRecord",value:function(t){var e=parseInt(t.substr(21,4),10),n=" "===t[25]?"\0":t[25],r=parseInt(t.substr(33,4),10),i=" "===t[37]?"\0":t[37],a=t[19];return this._helices.push({first:[e,n],last:[r,i],chainName:a}),!0}},{key:"parseRosettaAnnotation",value:function(t){if(t.length<5)return this.CONTINUE;var e=t[5],n=parseInt(t.substr(0,5).trim(),10);if(isNaN(n))return console.error("could not parse residue number"),this.ERROR;var r="C";"H"!==e&&"E"!==e||(r=e),1!==this._structure.chains().length&&console.warn("multiple chains are present. arbitrarily","assigning secondary structure to the last chain.");var i=this._currChain.residueByRnum(n);return null===i?(console.warn("could not find residue",n,"in last chain.","Skipping ROSETTA secondary structure annotation"),this.CONTINUE):(i.setSS(r),this.CONTINUE)}},{key:"parseSheetRecord",value:function(t){var e=parseInt(t.substr(22,4),10),n=" "===t[26]?"\0":t[26],r=parseInt(t.substr(33,4),10),i=" "===t[37]?"\0":t[37],a=t[21];return this._sheets.push({first:[e,n],last:[r,i],chainName:a}),!0}},{key:"parseAndAddAtom",value:function(t){var e=t[16];if(" "!==e&&"A"!==e)return!0;var n="H"===t[0],r=t[21],i=t.substr(17,3).trim(),a=t.substr(12,4),o=a.trim(),s=parseInt(t.substr(22,4),10);Number.isNaN(s)&&(s=1);var u=" "===t[26]?"\0":t[26],l=!1,h=!1;this._currChain&&this._currChain.name()===r||(h=!0,l=!0),this._currRes&&this._currRes.num()===s&&this._currRes.insCode()===u||(l=!0),h&&(this._currChain=this._structure.chain(r)||this._structure.addChain(r)),l&&(this._currRes=this._currChain.addResidue(i,s,u));for(var c=mt(),d=0;d<3;++d)c[d]=parseFloat(t.substr(30+8*d,8));var f=t.substr(76,2).trim();""===f&&(f=Xa(a));var _=parseFloat(t.substr(54,6).trim()),v=parseFloat(t.substr(60,6).trim()),m=parseInt(t.substr(6,5).trim(),10),g=this._currRes.addAtom(o,c,f,n,isNaN(_)?null:_,isNaN(v)?null:v,m);return this._options.conectRecords&&(this._serialToAtomMap[m]=g),!0}},{key:"parseConectRecord",value:function(t){for(var e=parseInt(t.substr(6,5).trim(),10),n=[],r=0;r<4;++r){var i=parseInt(t.substr(11+5*r,6).trim(),10);isNaN(i)||(i>e||n.push(i))}return this._conect.push({from:e,to:n}),!0}},{key:"processLine",value:function(t){var e=t.substr(0,6);return"ATOM  "===e||"HETATM"===e?this.parseAndAddAtom(t)?this.CONTINUE:this.ERROR:"REMARK"===e?("350"===t.substr(7,3)&&this._remark350Reader.nextLine(t),this.CONTINUE):"HELIX "===e?this.parseHelixRecord(t)?this.CONTINUE:this.ERROR:"SHEET "===e?this.parseSheetRecord(t)?this.CONTINUE:this.ERROR:this._options.conectRecords&&"CONECT"===e?this.parseConectRecord(t)?this.CONTINUE:this.ERROR:"END   "===e?this.FILE_END:"ENDMDL"===e?this.MODEL_COMPLETE:"complete:"===t.substr(0,9)?(this._rosettaMode=!0,this.CONTINUE):this._rosettaMode?0===t.trim().length?(this._rosettaMode=!1,this.CONTINUE):this.parseRosettaAnnotation(t):this.CONTINUE}},{key:"finish",value:function(){if(null===this._currChain)return null;var t,e=null;for(t=0;t<this._sheets.length;++t){var n=this._sheets[t];(e=this._structure.chain(n.chainName))&&e.assignSS(n.first,n.last,"E")}for(t=0;t<this._helices.length;++t){var r=this._helices[t];(e=this._structure.chain(r.chainName))&&e.assignSS(r.first,r.last,"H")}this._structure.setAssemblies(this._remark350Reader.assemblies()),this._options.conectRecords&&this._assignBondsFromConectRecords(this._structure),this._structure.deriveConnectivity(),console.log("imported",this._structure.chains().length,"chain(s),",this._structure.residueCount(),"residue(s)");var i=this._structure;return this._structure=new Wa,this._currChain=null,this._currRes=null,this._currAtom=null,this._rosettaMode=!1,i}},{key:"_assignBondsFromConectRecords",value:function(t){for(var e=0;e<this._conect.length;++e)for(var n=this._conect[e],r=this._serialToAtomMap[n.from],i=0;i<n.to.length;++i){var a=this._serialToAtomMap[n.to[i]];t.connect(r,a)}}}]),t}(),$a=function(t){return t.split(/\r\n|\r|\n/g)},Za=function(t,e){console.time("pdb");for(var n=e||{},r=$a(t),i=new Ya(n),a=[],o=0;o<r.length;o++){var s=i.processLine(r[o]);if(s===i.ERROR)return console.timeEnd("pdb"),null;if(s!==i.CONTINUE){var u=i.finish();if(null!==u&&a.push(u),s!==i.MODEL_COMPLETE||!n.loadAllModels)break}}var l=i.finish();return null!==l&&a.push(l),console.timeEnd("pdb"),n.loadAllModels?a:a[0]},Ka=function(){function t(){mr(this,t),this._structure=new Wa,this._reset(),this._sawEnd=!1}return gr(t,[{key:"processLine",value:function(t){var e=this._state;if(e<3){if(0===e){var n=t.trim();if(0===n.length)return!1;this._title=n}return this._sawEnd=!1,this._state++,!0}if(3===e){if(this._expectedAtomCount=parseInt(t.substr(0,3).trim(),10),this._expectedBondCount=parseInt(t.substr(3,3).trim(),10),isNaN(this._expectedAtomCount)||isNaN(this._expectedBondCount))return console.error("invalid bond definition"),!1;this._state++;var r=""+(this._structure.chains().length+1);this._currentChain=this._structure.addChain(r),this._currentResidue=this._currentChain.addResidue(this._title,1)}if(4===e){for(var i=[0,0,0],a=0;a<3;++a)if(i[a]=parseFloat(t.substr(10*a,10).trim()),isNaN(i[a]))return console.error("invalid atom position"),!1;var o=t.substr(31,3).trim();this._currentResidue.addAtom(o,i,o,!1),++this._atomCount===this._expectedAtomCount&&this._state++}if(5===e){var s=parseInt(t.substr(0,3).trim(),10)-1,u=parseInt(t.substr(3,3).trim(),10)-1;if(isNaN(s)||isNaN(u))return console.error("invalid bond definition"),!1;var l=this._currentResidue.atoms();this._structure.connect(l[s],l[u]),++this._bondCount===this._expectedBondCount&&this._state++}return"M  END"===t.substr(0,6)&&(this._sawEnd=!0,this._state++),"$$$$"===t.substr(0,4)&&this._reset(),!0}},{key:"_reset",value:function(){this._state=0,this._currentResidue=null,this._currentChain=null,this._expectedAtomCount=null,this._expectedBondount=null,this._atomCount=0,this._bondCount=0,this._title=""}},{key:"finish",value:function(){return this._sawEnd?this._structure:(console.error("truncated SDF file"),null)}}]),t}(),Qa=function(){function t(){mr(this,t),this._structure=new Wa,this._reset(),this._sawEnd=!1}return gr(t,[{key:"processLine",value:function(t){if(0===t.length||"*"===t[0])return!0;if(t.length<52)return!0;for(var e=t.substr(16,5),n=parseInt(t.substr(6,4).trim(),10),r=t.substr(11,3).trim(),i=mt(),a=0;a<3;++a)i[a]=parseFloat(t.substr(20+10*a,10).trim());var o=t[51];return null!==this._currentChain&&this._currentChain.name()===o||(this._currentResidue=null,this._currentChain=this._structure.chain(o),null===this._currentChain&&(this._currentChain=this._structure.addChain(o))),null!==this._currentResidue&&this._currentResidue.num()===n||(this._currentResidue=this._currentChain.addResidue(r,n)),this._currentResidue.addAtom(e.trim(),i,e[0],!1,1,0),!0}},{key:"_reset",value:function(){this._currentResidue=null,this._currentChain=null}},{key:"finish",value:function(){return this._structure.deriveConnectivity(),this._structure}}]),t}(),Ja=function(t){console.time("sdf");for(var e=new Ka,n=$a(t),r=0;r<n.length&&e.processLine(n[r]);r++);var i=e.finish();return console.timeEnd("sdf"),i},to=function(t){console.time("crd");for(var e=new Qa,n=$a(t),r=0;r<n.length&&e.processLine(n[r]);r++);var i=e.finish();return console.timeEnd("crd"),i},eo=function(t,e){var n=new XMLHttpRequest;n.open("GET",t,!0),n.onload=function(){n.response&&e(n.response)},n.send(null)},no=function(t,e,n){eo(t,function(t){var r=Za(t,n);e(r)})},ro=function(t,e){eo(t,function(t){var n=Ja(t);e(n)})},io=function(t,e){eo(t,function(t){var n=to(t);e(n)})},ao=Object.freeze({Remark350Reader:Ga,guessAtomElementFromName:Xa,pdb:Za,sdf:Ja,crd:to,fetchPdb:no,fetchSdf:ro,fetchCrd:io}),oo=function(){function t(e){mr(this,t),this._structure=e,this._frames=[],this._title=""}return gr(t,[{key:"addFrame",value:function(t){this._frames.push(t)}},{key:"useFrame",value:function(t){var e=this._frames[t];this._structure.eachAtom(function(t,n){var r=3*n;bt(t.pos(),e[r+0],e[r+1],e[r+2])})}},{key:"title",set:function(t){this._title=t}}]),t}(),so=function(t,e){var n=new oo(t),r="DROC"===String.fromCharCode(e.getUint8(4))+String.fromCharCode(e.getUint8(5))+String.fromCharCode(e.getUint8(6))+String.fromCharCode(e.getUint8(7)),i=92,a=e.getUint32(i,r);i+=4;var o,s="";for(o=0;o<a;++o)s+=String.fromCharCode(e.getUint8(i)),i+=1;n.title=s;var u=e.getUint32(8,r),l=!1;0!==e.getUint32(84,r)&&(l=0!==e.getUint32(48,r)),i+=8;var h=e.getUint32(i,r);for(i+=8,o=0;o<u;++o){var c=new Float32Array(3*h);l&&(i+=56);for(var d=0;d<3;++d){i+=4;for(var f=0;f<h;++f){var _=e.getFloat32(i,r);c[3*f+d]=_,i+=4}i+=4}n.addFrame(c)}return n},uo=function(t,e,n){On(t,function(t){var r=so(e,t);n(r)})},lo=Object.freeze({CoordGroup:oo,fetchDcd:uo}),ho=Object.freeze({principalAxes:Pn}),co=function(t,e,n,r){for(var i=mt(),a=mt(),o=Math.max(0,e-2);o<=e;++o)for(var s=2;s<5;++s)if(!(o+s>=t.length())){var u=Ot(t.posAt(i,o),t.posAt(a,o+s));if(Math.abs(u-n[s-2])>r)return!1}return!0},fo=function(t,e){return co(t,e,[5.45,5.18,6.37],2.1)},_o=function(t,e){return co(t,e,[6.1,10.4,13],1.42)},vo=function(t,e){if(bt(e,0,0,0),0!==t.length){for(var n=0;n<t.length;++n)At(e,e,t[n].pos());xt(e,e,1/t.length)}},mo=function(t,e,n,r,i){var a=mt(),o=mt();i[0]=0,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=0,i[6]=0,i[7]=0,i[8]=0;for(var s=0;s<e.length;++s){kt(a,t[s].pos(),n),kt(o,e[s].pos(),r);var u=a,l=o;i[0]+=u[0]*l[0],i[1]+=u[0]*l[1],i[2]+=u[0]*l[2],i[3]+=u[1]*l[0],i[4]+=u[1]*l[1],i[5]+=u[1]*l[2],i[6]+=u[2]*l[0],i[7]+=u[2]*l[1],i[8]+=u[2]*l[2]}};return{Viewer:Ta,isWebGLSupported:rn,io:ao,traj:lo,color:Zr,mol:{Mol:Wa,MolView:Ha,assignHelixSheet:Vn,superpose:function(e,n){var r=mt(),i=mt(),a=mt(),u=t(),l=t(),d=t(),f=t(),_=t(),v=e.atoms(),m=n.atoms();if(vo(m,r),vo(v,i),v.length!==m.length)return console.error("atom counts do not match ("+v.length+"in structure vs "+m.length+" in reference)"),!1;if(v.length<3)return console.error("at least 3 atoms are required for superposition"),!1;mo(v,m,i,r,l);var g=Nn([[l[0],l[1],l[2]],[l[3],l[4],l[5]],[l[6],l[7],l[8]]]);f[0]=g.U[0][0],f[1]=g.U[0][1],f[2]=g.U[0][2],f[3]=g.U[1][0],f[4]=g.U[1][1],f[5]=g.U[1][2],f[6]=g.U[2][0],f[7]=g.U[2][1],f[8]=g.U[2][2];var p=h(f);_[0]=g.V[0][0],_[1]=g.V[0][1],_[2]=g.V[0][2],_[3]=g.V[1][0],_[4]=g.V[1][1],_[5]=g.V[1][2],_[6]=g.V[2][0],_[7]=g.V[2][1],_[8]=g.V[2][2];var y=h(_);o(d),p*y<0&&(console.log("determinants smaller than zero!"),d[8]=-1,c(f,f,d)),console.log(A(f)),c(u,s(_,_),f);for(var b=e.full().atoms(),k=0;k<b.length;++k){var C=b[k];kt(a,C.pos(),i),Gt(a,a,u),At(a,r,a),C.setPos(a)}return!0},matchResiduesByNum:Un,matchResiduesByIndex:zn},vec3:Gn,vec4:Yn,mat3:qn,mat4:Wn,quat:vr,viewpoint:ho}});